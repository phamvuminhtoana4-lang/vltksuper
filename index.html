<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VO LAM SUPREME: V·∫†N C·ªî QUY T√îNG - MEGA VERSION</title>
    <style>
        /* ============================================================
           PH·∫¶N 1: H·ªÜ TH·ªêNG CSS ƒê·ªí S·ªò (600+ D√íNG STYLE)
           ============================================================ */
        :root {
            --gold: #FFD700; --gold-dark: #B8860B; --gold-light: #FFFACD;
            --hp: #ff4757; --hp-dark: #c0392b;
            --mp: #1e90ff; --mp-dark: #0984e3;
            --exp: #2ed573; --exp-dark: #26de81;
            --bg: #050505; --panel: rgba(15, 15, 15, 0.98);
            --border-ui: 2px solid var(--gold);
            --shadow-glow: 0 0 25px rgba(255, 215, 0, 0.3);
            --font-main: 'Constantia', 'Georgia', serif;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            margin: 0; padding: 0; 
        }

        body, html { 
            width: 100%; height: 100%; 
            overflow: hidden; 
            background: #000; 
            color: #eee; 
            font-family: var(--font-main); 
        }

        /* TH·∫æ GI·ªöI 2.5D ENGINE */
        #stage { 
            position: relative; 
            width: 100vw; height: 100vh; 
            overflow: hidden; 
            perspective: 1500px;
        }

        #map-container { 
            position: absolute; 
            width: 2000000px; height: 2000000px; 
            background: 
                radial-gradient(circle, #222 1.5px, transparent 1.5px),
                linear-gradient(to right, #111 1px, transparent 1px),
                linear-gradient(to bottom, #111 1px, transparent 1px);
            background-size: 100px 100px, 1000px 1000px, 1000px 1000px;
            will-change: transform;
            image-rendering: pixelated;
        }

        /* L·ªöP TH·ª∞C TH·ªÇ (ENTITIES) */
        .ent { 
            position: absolute; 
            width: 120px; height: 150px; 
            z-index: 100; 
            transition: opacity 0.4s;
            transform-style: preserve-3d;
        }

        /* NH√ÇN V·∫¨T & QU√ÅI V·∫¨T */
        .stick-man { 
            position: relative; 
            width: 100%; height: 100%; 
            display: flex; flex-direction: column; align-items: center; 
        }

        .head { 
            width: 35px; height: 35px; 
            border: 3px solid #fff; 
            border-radius: 50%; 
            background: #000; 
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            z-index: 5;
        }

        .body-line { 
            width: 4px; height: 55px; 
            background: #fff; 
            margin-top: -2px; 
            border-radius: 2px;
        }

        .arm-l, .arm-r {
            position: absolute; width: 3px; height: 35px;
            background: #fff; top: 40px; transform-origin: top;
        }
        .arm-l { transform: rotate(30deg); left: 55px; }
        .arm-r { transform: rotate(-30deg); right: 55px; }

        .leg-l, .leg-r {
            position: absolute; width: 3px; height: 40px;
            background: #fff; bottom: 15px; transform-origin: top;
        }
        .leg-l { transform: rotate(15deg); left: 58px; }
        .leg-r { transform: rotate(-15deg); right: 58px; }

        /* V≈® KH√ç SI√äU C·∫§P */
        .weapon { 
            position: absolute; 
            width: 6px; height: 85px; 
            background: linear-gradient(to bottom, var(--gold-light), var(--gold-dark)); 
            top: 40px; left: 65px; 
            transform-origin: top; 
            display: none; 
            filter: drop-shadow(0 0 8px var(--gold));
            border-radius: 3px;
        }

        /* HI·ªÜU ·ª®NG C√ÅNH (WINGS) */
        .wings-container {
            position: absolute; width: 160px; height: 100px;
            top: 20px; left: -20px; display: none; z-index: -1;
        }
        .wing {
            position: absolute; width: 80px; height: 100px;
            background: rgba(255, 215, 0, 0.4);
            clip-path: polygon(0% 20%, 100% 0%, 80% 100%, 0% 80%);
            animation: flap 0.6s infinite alternate ease-in-out;
        }
        .wing.right { right: 0; transform: scaleX(-1); }
        @keyframes flap { from { transform: rotate(-15deg); } to { transform: rotate(25deg); } }

        /* GIAO DI·ªÜN HUD (HEADS-UP DISPLAY) */
        #ui-layer { position: fixed; inset: 0; pointer-events: none; z-index: 2000; }
        .pointer { pointer-events: auto; }

        #hud-top-left {
            position: fixed; top: 25px; left: 25px;
            width: 380px; padding: 20px;
            background: var(--panel);
            border-left: 6px solid var(--gold);
            border-radius: 5px;
            box-shadow: var(--shadow-glow);
        }

        .bar-container {
            width: 100%; height: 22px;
            background: #111; border: 1px solid #444;
            border-radius: 11px; margin: 10px 0;
            overflow: hidden; position: relative;
        }
        .bar-fill { height: 100%; transition: width 0.4s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
        .bar-label {
            position: absolute; width: 100%; text-align: center;
            font-size: 11px; font-weight: 900; line-height: 22px;
            color: #fff; text-shadow: 1px 1px 2px #000;
        }

        /* MINI MAP PRO */
        #mini-map-container {
            position: fixed; top: 25px; right: 25px;
            width: 220px; height: 220px;
            background: rgba(0,0,0,0.85);
            border: 3px solid var(--gold);
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,1);
        }
        #map-radar { position: absolute; width: 100%; height: 100%; }
        .radar-line {
            position: absolute; width: 50%; height: 2px;
            background: linear-gradient(to right, transparent, var(--gold));
            top: 50%; left: 50%; transform-origin: left;
            animation: radar-sweep 4s linear infinite;
        }
        @keyframes radar-sweep { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* MENU TR∆Ø·ª¢T N√ÇNG CAO */
        #btn-toggle-menu {
            position: fixed; right: 0; top: 50%; transform: translateY(-50%);
            width: 50px; height: 200px;
            background: var(--gold); color: #000;
            border: none; border-radius: 20px 0 0 20px;
            cursor: pointer; font-weight: 900;
            writing-mode: vertical-rl; text-align: center;
            font-size: 16px; letter-spacing: 2px;
            box-shadow: -5px 0 15px rgba(0,0,0,0.5);
        }

        #side-panel {
            position: fixed; top: 0; right: -450px;
            width: 430px; height: 100vh;
            background: var(--panel);
            border-left: 4px solid var(--gold);
            transition: 0.6s cubic-bezier(0.075, 0.82, 0.165, 1);
            padding: 40px 25px;
            overflow-y: auto;
        }
        #side-panel.open { right: 0; }

        /* H·ªÜ TH·ªêNG SKILL DOCK */
        .skill-dock {
            position: fixed; bottom: 35px; right: 35px;
            display: grid; grid-template-columns: repeat(4, 95px);
            gap: 15px;
        }
        .skill-slot {
            width: 95px; height: 95px;
            background: radial-gradient(circle, #333, #050505);
            border: 2px solid #555; border-radius: 15px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            cursor: pointer; position: relative; overflow: hidden;
        }
        .skill-slot:hover { border-color: var(--gold); background: #111; }
        .skill-name { font-size: 11px; font-weight: bold; text-align: center; margin-top: 5px; color: var(--gold); }
        .cooldown-overlay {
            position: absolute; bottom: 0; width: 100%; height: 0%;
            background: rgba(0,0,0,0.7); transition: height 0.1s linear;
        }

        /* H·ªòI THO·∫†I & LOG */
        #dialogue-system {
            position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
            width: 750px; background: var(--panel);
            border: 2px solid var(--gold); border-radius: 15px;
            padding: 30px; display: none; box-shadow: 0 0 50px #000;
        }

        #game-event-log {
            position: fixed; bottom: 40px; left: 40px;
            width: 450px; height: 200px;
            background: rgba(0,0,0,0.4);
            padding: 15px; font-size: 13px;
            overflow: hidden; pointer-events: none;
            display: flex; flex-direction: column-reverse;
        }

        /* HI·ªÜU ·ª®NG CHI·∫æN ƒê·∫§U */
        .damage-pop {
            position: absolute; color: #ff4757;
            font-size: 32px; font-weight: 900;
            text-shadow: 2px 2px #000;
            animation: dmg-float 1.2s forwards;
            pointer-events: none; z-index: 999;
        }
        @keyframes dmg-float {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { transform: translateY(-40px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-120px) scale(1); opacity: 0; }
        }

        /* CH·ªåN PH√ÅI (M√ÄN H√åNH KH·ªûI T·∫†O) */
        #start-screen {
            position: fixed; inset: 0;
            background: radial-gradient(circle, #1a1a1a, #000);
            z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div id="start-screen">
    <h1 style="color:var(--gold); font-size: 60px; letter-spacing: 20px; text-shadow: 0 0 30px gold;">V√ï L√ÇM SUPREME</h1>
    <p style="color:#888; margin-bottom: 50px; letter-spacing: 5px;">H√ÄNH TR√åNH V·∫†N C·ªî - ƒê·ªòC T√îN KI·∫æM ƒê·∫†O</p>
    
    <div style="display:flex; gap:30px;">
        <div class="pointer" onclick="Engine.init('THIEU_LAM')" style="width:300px; padding:40px; background:#111; border:2px solid #333; border-radius:20px; text-align:center; cursor:pointer; transition:0.3s;">
            <h2 style="color:#f1c40f">THI·∫æU L√ÇM</h2>
            <hr style="margin:15px 0; border:0; border-top:1px solid #333">
            <p style="text-align:left; font-size:14px; line-height:2">
                <span style="color:var(--exp)">‚óè Sinh l·ª±c c·ª±c ƒë·∫°i: +2500</span><br>
                <span style="color:var(--exp)">‚óè Ph√≤ng ng·ª± ngo·∫°i gia: +150</span><br>
                <span style="color:var(--hp)">‚óè T·ªëc ƒë·ªô di chuy·ªÉn: -4</span><br>
                <span style="color:var(--hp)">‚óè S√°t th∆∞∆°ng c∆° b·∫£n: -20%</span>
            </p>
        </div>
        </div>
</div>

<div id="stage">
    <div id="map-container">
        <div id="layer-ground"></div>
        <div id="layer-entities"></div>
        <div id="layer-vfx"></div>

        <div id="hero" class="ent">
            <div class="wings-container" id="hero-wings">
                <div class="wing left"></div>
                <div class="wing right"></div>
            </div>
            <div class="name-tag" id="hero-name" style="color:var(--gold)">V√¥ Danh Hi·ªáp</div>
            <div class="hp-bar-mini"><div id="hero-hp-bar" class="hp-fill-mini"></div></div>
            <div class="stick-man">
                <div class="head" id="hero-head"></div>
                <div class="body-line"></div>
                <div class="arm-l"></div><div class="arm-r"></div>
                <div class="leg-l"></div><div class="leg-r"></div>
                <div class="weapon" id="hero-weapon"></div>
            </div>
        </div>
    </div>
</div>

<div id="ui-layer">
    <div id="hud-top-left" class="pointer">
        <div style="display:flex; justify-content:space-between; align-items:flex-end">
            <h2 id="ui-sect-name" style="color:var(--gold)">V√î PH√ÅI</h2>
            <span id="ui-level" style="font-weight:900; font-size:20px">C·∫•p 1</span>
        </div>
        <div class="bar-container">
            <div id="fill-hp" class="bar-fill" style="background:linear-gradient(to right, var(--hp-dark), var(--hp)); width:100%"></div>
            <div class="bar-label">SINH L·ª∞C: <span id="txt-hp">1000/1000</span></div>
        </div>
        <div class="bar-container">
            <div id="fill-mp" class="bar-fill" style="background:linear-gradient(to right, var(--mp-dark), var(--mp)); width:100%"></div>
            <div class="bar-label">N·ªòI L·ª∞C: <span id="txt-mp">500/500</span></div>
        </div>
        <div class="bar-container" style="height:8px; margin-top:5px;">
            <div id="fill-exp" class="bar-fill" style="background:var(--exp); width:0%"></div>
        </div>
        <div style="margin-top:10px; display:flex; gap:20px; font-size:14px">
            <span>üí∞ B·∫°c: <b id="ui-money" style="color:var(--gold)">0</b></span>
            <span>‚öîÔ∏è C√¥ng l·ª±c: <b id="ui-atk" style="color:var(--hp)">100</b></span>
        </div>
    </div>

    <div id="mini-map-container">
        <div id="map-radar"></div>
        <div class="radar-line"></div>
        <div class="map-dot" style="top:50%; left:50%; background:#fff; width:8px; height:8px; z-index:10; box-shadow:0 0 5px #fff"></div>
    </div>

    <div class="skill-dock pointer" id="skill-dock">
        </div>

    <button id="btn-toggle-menu" class="pointer" onclick="UI.toggleMenu()">H√ÄNH TRANG & CHI S·ªê</button>
    <div id="side-panel" class="pointer">
        <h1 style="color:var(--gold); border-bottom:2px solid #333; padding-bottom:10px">TR·∫†NG TH√ÅI</h1>
        <div id="full-stats-list" style="margin:20px 0; font-size:16px; line-height:2.5">
            </div>
        <hr style="border:0; border-top:1px solid #333; margin:20px 0">
        <h2 style="color:var(--gold)">PH√ÅP B·∫¢O</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px">
            <button onclick="Engine.toggleWings()" style="padding:15px; cursor:pointer; background:#222; color:#fff; border:1px solid var(--gold)">TH·∫¶N D·ª∞C (BAY)</button>
            <button onclick="Engine.toggleMount()" style="padding:15px; cursor:pointer; background:#222; color:#fff; border:1px solid var(--gold)">LINH TH√ö (C∆Ø·ª†I)</button>
        </div>
    </div>

    <div id="dialogue-system" class="pointer">
        <h2 id="npc-display-name" style="color:var(--gold)">L√£o Nh√¢n AI</h2>
        <p id="npc-display-msg" style="margin:20px 0; font-size:18px; line-height:1.6"></p>
        <div id="npc-display-options" style="display:flex; gap:15px"></div>
        <button onclick="UI.closeDialogue()" style="margin-top:25px; background:none; border:none; color:#666; cursor:pointer">L·∫ßn sau quay l·∫°i...</button>
    </div>

    <div id="game-event-log"></div>
</div>

<script>
    /**
     * PH·∫¶N 2: H·ªÜ TH·ªêNG LOGIC SI√äU C·∫§P (CORE ENGINE)
     * D√≤ng code ƒë∆∞·ª£c vi·∫øt t∆∞·ªùng minh, kh√¥ng thu g·ªçn.
     */

    const State = {
        player: {
            x: 1000000, y: 1000000,
            lv: 1, exp: 0, 
            hp: 1000, maxHp: 1000,
            mp: 500, maxMp: 500,
            atk: 100, def: 50, spd: 12,
            money: 1000,
            sect: null,
            isFlying: false,
            isMounted: false,
            baseSpd: 12
        },
        world: {
            mobs: [],
            npcs: [],
            bosses: [],
            items: []
        },
        input: {
            keys: {},
            mouse: { x: 0, y: 0 }
        },
        settings: {
            mapScale: 0.04,
            isRunning: false
        }
    };

    const SECT_DATA = {
        THIEU_LAM: {
            name: "Thi·∫øu L√¢m T·ª±",
            color: "#f1c40f",
            bonus: { hp: 2500, def: 150, spd: -4, atkMul: 0.8 },
            skills: [
                { id: 'tl1', n: "La H√°n Quy·ªÅn", dmg: 1.5, mp: 20, cd: 1000 },
                { id: 'tl2', n: "Ni√™m Hoa Ch·ªâ", dmg: 2.8, mp: 50, cd: 3000 },
                { id: 'tl3', n: "S∆∞ T·ª≠ H·ªëng", dmg: 4.5, mp: 120, cd: 8000 },
                { id: 'tl4', n: "D·ªãch C√¢n Kinh", dmg: 0, mp: 200, cd: 20000 }
            ]
        },
  
         const Engine = {
        // --- 1. KH·ªûI T·∫†O H·ªÜ TH·ªêNG ---
        init(sectKey) {
            const data = SECT_DATA[sectKey];
            if (!data) return;

            // Thi·∫øt l·∫≠p m√¥n ph√°i v√† c·ªông ch·ªâ s·ªë chi ti·∫øt
            State.player.sect = data;
            State.player.maxHp += data.bonus.hp;
            State.player.hp = State.player.maxHp;
            State.player.def += data.bonus.def;
            State.player.baseSpd += data.bonus.spd;
            State.player.spd = State.player.baseSpd;
            
            // C·∫≠p nh·∫≠t giao di·ªán ban ƒë·∫ßu
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('ui-sect-name').innerText = data.name;
            document.getElementById('ui-sect-name').style.color = data.color;
            document.getElementById('hero-head').style.borderColor = data.color;
            document.getElementById('hero-name').innerText = "Thi·∫øu Hi·ªáp " + data.name;

            // Kh·ªüi t·∫°o danh s√°ch k·ªπ nƒÉng l√™n Dock
            this.setupSkills(data.skills);

            // Kh·ªüi t·∫°o th·ª±c th·ªÉ th·∫ø gi·ªõi (Qu√°i, NPC, Boss)
            this.spawnWorldEntities();

            // K√≠ch ho·∫°t v√≤ng l·∫∑p game
            State.settings.isRunning = true;
            this.gameLoop();
            
            UI.addLog("H·ªÜ TH·ªêNG", "Ch√†o m·ª´ng b·∫°n gia nh·∫≠p " + data.name + ". H√£y d√πng W-A-S-D ƒë·ªÉ h√†nh t·∫©u!");
        },

        setupSkills(skills) {
            const dock = document.getElementById('skill-dock');
            dock.innerHTML = ''; // X√≥a s·∫°ch dock c≈©
            
            skills.forEach((skill, index) => {
                const slot = document.createElement('div');
                slot.className = 'skill-slot pointer';
                slot.innerHTML = `
                    <div class="cooldown-overlay" id="cd-${skill.id}"></div>
                    <div style="font-size: 20px;">${index + 1}</div>
                    <div class="skill-name">${skill.n}</div>
                `;
                slot.onclick = () => this.castSkill(skill);
                dock.appendChild(slot);
            });

            // Th√™m ph√≠m ƒë√°nh th∆∞·ªùng m·∫∑c ƒë·ªãnh
            const attackSlot = document.createElement('div');
            attackSlot.className = 'skill-slot pointer';
            attackSlot.style.border = "2px solid #ff4757";
            attackSlot.innerHTML = `<div>SPACE</div><div class="skill-name">ƒê√ÅNH TH∆Ø·ªúNG</div>`;
            attackSlot.onclick = () => this.performBasicAttack();
            dock.appendChild(attackSlot);
        },

        // --- 2. QU·∫¢N L√ù TH·ª∞C TH·ªÇ (ENTITIES) ---
        spawnWorldEntities() {
            // T·∫°o 100 qu√°i v·∫≠t d√£ nh√¢n xung quanh t·ªça ƒë·ªô ng∆∞·ªùi ch∆°i
            for (let i = 0; i < 100; i++) {
                const mobX = State.player.x + (Math.random() - 0.5) * 4000;
                const mobY = State.player.y + (Math.random() - 0.5) * 4000;
                const mob = new Entity('mob-' + i, 'D√£ Nh√¢n C·∫•p ' + (i%10 + 1), mobX, mobY, 600, 'mob');
                State.world.mobs.push(mob);
            }

            // T·∫°o NPC AI t·∫°i c√°c ƒëi·ªÉm c·ªë ƒë·ªãnh
            const npc1 = new Entity('npc-static-1', 'L√£o Gi√† Qu√©t R√°c', State.player.x + 400, State.player.y - 300, 99999, 'npc');
            State.world.npcs.push(npc1);

            const npc2 = new Entity('npc-static-2', 'Ch∆∞·ªüng M√¥n Ti·∫øp D·∫´n', State.player.x - 500, State.player.y + 600, 99999, 'npc');
            State.world.npcs.push(npc2);

            // T·∫°o Boss Th·∫ø Gi·ªõi
            const boss = new Entity('boss-world-1', 'H·ªéA K·ª≤ L√ÇN V·∫†N C·ªî', 1002000, 1002000, 50000, 'mob');
            State.world.bosses.push(boss);
        },

        // --- 3. TO√ÅN H·ªåC DI CHUY·ªÇN & VA CH·∫†M ---
        updatePhysics() {
            if (!State.settings.isRunning) return;

            let moveX = 0;
            let moveY = 0;

            // Ki·ªÉm tra ph√≠m b·∫•m ƒë·ªÉ x√°c ƒë·ªãnh vector di chuy·ªÉn
            if (State.input.keys['w'] || State.input.keys['arrowup']) moveY -= 1;
            if (State.input.keys['s'] || State.input.keys['arrowdown']) moveY += 1;
            if (State.input.keys['a'] || State.input.keys['arrowleft']) moveX -= 1;
            if (State.input.keys['d'] || State.input.keys['arrowright']) moveX += 1;

            // Chu·∫©n h√≥a vector di chuy·ªÉn (ƒë·ªÉ ƒëi ch√©o kh√¥ng b·ªã nhanh h∆°n ƒëi th·∫≥ng)
            if (moveX !== 0 || moveY !== 0) {
                const length = Math.sqrt(moveX * moveX + moveY * moveY);
                moveX /= length;
                moveY /= length;

                State.player.x += moveX * State.player.spd;
                State.player.y += moveY * State.player.spd;
                
                // Hi·ªáu ·ª©ng nghi√™ng nh√¢n v·∫≠t khi di chuy·ªÉn
                const heroEl = document.getElementById('hero');
                heroEl.style.transform = `rotate(${moveX * 10}deg)`;
            }

            // C·∫≠p nh·∫≠t v·ªã tr√≠ Camera (Map tr∆∞·ª£t ng∆∞·ª£c l·∫°i)
            const mapContainer = document.getElementById('map-container');
            const camX = window.innerWidth / 2 - State.player.x;
            const camY = window.innerHeight / 2 - State.player.y;
            mapContainer.style.transform = `translate(${camX}px, ${camY}px)`;

            // C·∫≠p nh·∫≠t v·ªã tr√≠ Hero tr√™n Map th·ª±c t·∫ø
            const hero = document.getElementById('hero');
            hero.style.left = State.player.x + 'px';
            hero.style.top = State.player.y + 'px';
        },

        // --- 4. H·ªÜ TH·ªêNG AI T·ª∞ ƒê·ªòNG ---
        updateAI() {
            // NPC di chuy·ªÉn ng·∫´u nhi√™n (Tu·∫ßn tra)
            State.world.npcs.forEach(npc => {
                if (!npc.nextAction || Date.now() > npc.nextAction) {
                    npc.vx = (Math.random() - 0.5) * 2;
                    npc.vy = (Math.random() - 0.5) * 2;
                    npc.nextAction = Date.now() + 2000 + Math.random() * 3000;
                }
                npc.x += npc.vx;
                npc.y += npc.vy;
                const el = document.getElementById(npc.id);
                if (el) {
                    el.style.left = npc.x + 'px';
                    el.style.top = npc.y + 'px';
                }
            });

            // Qu√°i v·∫≠t ƒëu·ªïi theo ng∆∞·ªùi ch∆°i n·∫øu l·∫°i g·∫ßn (Aggro)
            State.world.mobs.forEach(mob => {
                const dist = Math.hypot(State.player.x - mob.x, State.player.y - mob.y);
                if (dist < 400 && dist > 50) {
                    const angle = Math.atan2(State.player.y - mob.y, State.player.x - mob.x);
                    mob.x += Math.cos(angle) * 3;
                    mob.y += Math.sin(angle) * 3;
                }
                const el = document.getElementById(mob.id);
                if (el) {
                    el.style.left = mob.x + 'px';
                    el.style.top = mob.y + 'px';
                }
            });
        },

        // --- 5. H·ªÜ TH·ªêNG CHI·∫æN ƒê·∫§U CHI TI·∫æT ---
        performBasicAttack() {
            const weapon = document.getElementById('hero-weapon');
            weapon.style.display = 'block';
            weapon.style.animation = 'swing 0.2s ease-in-out';
            
            // Ki·ªÉm tra va ch·∫°m v·ªõi qu√°i
            [...State.world.mobs, ...State.world.bosses].forEach(target => {
                const dist = Math.hypot(State.player.x - target.x, State.player.y - target.y);
                if (dist < 150) {
                    this.calculateDamage(State.player, target, 1.0);
                }
            });

            setTimeout(() => {
                weapon.style.display = 'none';
                weapon.style.animation = '';
            }, 200);
        },

        calculateDamage(attacker, victim, multiplier) {
            // C√¥ng th·ª©c s√°t th∆∞∆°ng: (C√¥ng * H·ªá s·ªë) - (Th·ªß / 2)
            let dmg = (State.player.atk * multiplier) - (victim.type === 'npc' ? 999 : 20);
            dmg = Math.max(Math.floor(dmg + Math.random() * 10), 1);

            victim.hp -= dmg;
            UI.createDamagePop(victim.x, victim.y, dmg);
            
            // C·∫≠p nh·∫≠t thanh m√°u th·ª±c th·ªÉ
            const hpBar = document.getElementById(victim.id + '-h');
            if (hpBar) {
                const pct = Math.max(0, (victim.hp / victim.maxHp) * 100);
                hpBar.style.width = pct + '%';
            }

            // Ki·ªÉm tra t·ª≠ vong
            if (victim.hp <= 0) {
                this.onEntityDeath(victim);
            }
        },

        onEntityDeath(victim) {
            UI.addLog("CHI·∫æN ƒê·∫§U", "ƒê√£ h·∫° g·ª•c " + victim.name);
            State.player.exp += 500;
            State.player.money += 150;
            
            // Hi·ªáu ·ª©ng tan bi·∫øn
            const el = document.getElementById(victim.id);
            if (el) el.style.opacity = '0';
            
            // H·ªìi sinh sau 5 gi√¢y t·∫°i v·ªã tr√≠ ng·∫´u nhi√™n
            setTimeout(() => {
                victim.hp = victim.maxHp;
                victim.x = State.player.x + (Math.random() - 0.5) * 3000;
                victim.y = State.player.y + (Math.random() - 0.5) * 3000;
                if (el) {
                    el.style.left = victim.x + 'px';
                    el.style.top = victim.y + 'px';
                    el.style.opacity = '1';
                    document.getElementById(victim.id + '-h').style.width = '100%';
                }
            }, 5000);

            this.checkLevelUp();
            UI.update();
        },

        checkLevelUp() {
            const reqExp = State.player.lv * 2000;
            if (State.player.exp >= reqExp) {
                State.player.lv++;
                State.player.exp = 0;
                State.player.maxHp += 500;
                State.player.hp = State.player.maxHp;
                State.player.atk += 40;
                UI.addLog("THƒÇNG C·∫§P", "Ch√∫c m·ª´ng! B·∫°n ƒë√£ ƒë·∫°t C·∫•p " + State.player.lv);
            }
        },

        // --- 6. H·ªÜ TH·ªêNG PH√ÅP B·∫¢O (BAY & C∆Ø·ª†I) ---
        toggleWings() {
            State.player.isFlying = !State.player.isFlying;
            const wingEl = document.getElementById('hero-wings');
            if (State.player.isFlying) {
                wingEl.style.display = 'block';
                State.player.spd = State.player.baseSpd + 10;
                UI.addLog("PH√ÅP B·∫¢O", "ƒê√£ k√≠ch ho·∫°t V√¥ Th∆∞·ª£ng Th·∫ßn D·ª±c!");
            } else {
                wingEl.style.display = 'none';
                State.player.spd = State.player.isMounted ? State.player.baseSpd * 2 : State.player.baseSpd;
                UI.addLog("PH√ÅP B·∫¢O", "ƒê√£ thu h·ªìi c√°nh.");
            }
        },

        toggleMount() {
            State.player.isMounted = !State.player.isMounted;
            if (State.player.isMounted) {
                State.player.spd = State.player.baseSpd * 2.2;
                document.getElementById('hero').style.marginTop = "-20px";
                UI.addLog("LINH TH√ö", "ƒê√£ c∆∞·ª°i H·∫Øc Long M√£!");
            } else {
                State.player.spd = State.player.baseSpd;
                document.getElementById('hero').style.marginTop = "0px";
                UI.addLog("LINH TH√ö", "ƒê√£ xu·ªëng ng·ª±a.");
            }
        },

        // --- V√íNG L·∫∂P CH√çNH (GAME LOOP) ---
        gameLoop() {
            if (!State.settings.isRunning) return;

            this.updatePhysics();
            this.updateAI();
            UI.updateMiniMap();
            
            // H·ªìi ph·ª•c n·ªôi l·ª±c t·ª± ƒë·ªông
            if (Date.now() % 100 === 0) {
                if (State.player.mp < State.player.maxMp) State.player.mp += 1;
                UI.update();
            }

            requestAnimationFrame(() => this.gameLoop());
        }
    };

    /** ============================================================
     * PH·∫¶N 3: H·ªÜ TH·ªêNG UI & ƒêI·ªÄU KHI·ªÇN CHI TI·∫æT
     * ============================================================
     */
    const UI = {
        toggleMenu() {
            const panel = document.getElementById('side-panel');
            panel.classList.toggle('open');
            this.update();
        },

        update() {
            // C·∫≠p nh·∫≠t thanh m√°u/n·ªôi l·ª±c
            const hpPct = (State.player.hp / State.player.maxHp) * 100;
            const mpPct = (State.player.mp / State.player.maxMp) * 100;
            const expPct = (State.player.exp / (State.player.lv * 2000)) * 100;

            document.getElementById('fill-hp').style.width = hpPct + '%';
            document.getElementById('fill-mp').style.width = mpPct + '%';
            document.getElementById('fill-exp').style.width = expPct + '%';
            
            document.getElementById('txt-hp').innerText = `${Math.floor(State.player.hp)} / ${State.player.maxHp}`;
            document.getElementById('txt-mp').innerText = `${Math.floor(State.player.mp)} / ${State.player.maxMp}`;
            document.getElementById('ui-level').innerText = `C·∫•p ${State.player.lv}`;
            document.getElementById('ui-money').innerText = State.player.money;
            document.getElementById('ui-atk').innerText = State.player.atk;

            // C·∫≠p nh·∫≠t b·∫£ng ch·ªâ s·ªë chi ti·∫øt trong Menu
            document.getElementById('full-stats-list').innerHTML = `
                <div style="display:flex; justify-content:space-between"><span>‚öîÔ∏è T·∫•n c√¥ng:</span> <b style="color:var(--hp)">${State.player.atk}</b></div>
                <div style="display:flex; justify-content:space-between"><span>üõ°Ô∏è Ph√≤ng ng·ª±:</span> <b style="color:var(--mp)">${State.player.def}</b></div>
                <div style="display:flex; justify-content:space-between"><span>‚ö° T·ªëc ƒë·ªô:</span> <b style="color:var(--exp)">${State.player.spd.toFixed(1)}</b></div>
                <div style="display:flex; justify-content:space-between"><span>üìç T·ªça ƒë·ªô X:</span> <b>${Math.floor(State.player.x)}</b></div>
                <div style="display:flex; justify-content:space-between"><span>üìç T·ªça ƒë·ªô Y:</span> <b>${Math.floor(State.player.y)}</b></div>
            `;
        },

        updateMiniMap() {
            const radar = document.getElementById('map-radar');
            radar.innerHTML = '';
            const scale = State.settings.mapScale;
            const centerX = 110; // 220px / 2
            const centerY = 110;

            // V·∫Ω c√°c th·ª±c th·ªÉ l√™n Map
            [...State.world.npcs, ...State.world.mobs, ...State.world.bosses].forEach(ent => {
                const relX = (ent.x - State.player.x) * scale;
                const relY = (ent.y - State.player.y) * scale;

                // Ch·ªâ v·∫Ω n·∫øu n·∫±m trong v√≤ng tr√≤n radar (R=110)
                if (Math.hypot(relX, relY) < 105) {
                    let dotClass = 'dot-mob';
                    if (ent.type === 'npc') dotClass = 'dot-npc';
                    if (ent.id.includes('boss')) dotClass = 'dot-boss';

                    const dot = document.createElement('div');
                    dot.className = 'map-dot ' + dotClass;
                    dot.style.left = (centerX + relX) + 'px';
                    dot.style.top = (centerY + relY) + 'px';
                    radar.appendChild(dot);
                }
            });
        },

        createDamagePop(x, y, dmg) {
            const pop = document.createElement('div');
            pop.className = 'damage-pop';
            pop.innerText = '-' + dmg;
            pop.style.left = x + 'px';
            pop.style.top = y + 'px';
            document.getElementById('layer-vfx').appendChild(pop);
            setTimeout(() => pop.remove(), 1200);
        },

        addLog(tag, msg) {
            const logEl = document.getElementById('game-event-log');
            const entry = document.createElement('div');
            entry.style.marginBottom = '5px';
            entry.innerHTML = `<b style="color:var(--gold)">[${tag}]</b> <span style="color:#ccc">${msg}</span>`;
            logEl.prepend(entry);
            if (logEl.childNodes.length > 8) logEl.removeChild(logEl.lastChild);
        }
    };

    // --- X·ª¨ L√ù S·ª∞ KI·ªÜN B√ÄN PH√çM ---
    window.addEventListener('keydown', e => { 
        State.input.keys[e.key.toLowerCase()] = true; 
        if (e.code === 'Space') Engine.performBasicAttack();
    });
    window.addEventListener('keyup', e => { 
        State.input.keys[e.key.toLowerCase()] = false; 
    });

</script>
    // M·ªü r·ªông d·ªØ li·ªáu m√¥n ph√°i (V√µ ƒêang & ƒê∆∞·ªùng M√¥n) ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng thi·∫øu t√≠nh nƒÉng
    Object.assign(SECT_DATA, {
        VO_DANG: {
            name: "V√µ ƒêang S∆°n", color: "#3498db",
            bonus: { hp: 500, def: 50, spd: 2, atkMul: 1.2 },
            skills: [
                { id: 'vd1', n: "Th√°i C·ª±c Ki·∫øm", dmg: 2.2, mp: 40, cd: 1500, range: 250 },
                { id: 'vd2', n: "Thi√™n ƒê·ªãa V√¥ C·ª±c", dmg: 3.5, mp: 80, cd: 5000, range: 450 },
                { id: 'vd3', n: "V·∫°n Ki·∫øm Quy T√¥ng", dmg: 6.0, mp: 250, cd: 12000, range: 600 }
            ]
        },
        DUONG_MON: {
            name: "ƒê∆∞·ªùng Gia B·∫£o", color: "#9b59b6",
            bonus: { hp: -400, def: -30, spd: 8, atkMul: 2.0 },
            skills: [
                { id: 'dm1', n: "Truy T√¢m Ti·ªÖn", dmg: 1.8, mp: 30, cd: 800, range: 500 },
                { id: 'dm2', n: "ƒê·ªôc T·∫≠t L√™", dmg: 2.5, mp: 60, cd: 4000, range: 350 },
                { id: 'dm3', n: "B·∫°o V≈© L√™ Hoa", dmg: 8.5, mp: 300, cd: 15000, range: 700 }
            ]
        }
    });

    // --- LOGIC CHI√äU TH·ª®C CHI TI·∫æT ---
    Engine.castSkill = function(skill) {
        if (State.player.mp < skill.mp) {
            UI.addLog("C·∫¢NH B√ÅO", "N·ªôi l·ª±c kh√¥ng ƒë·ªß ƒë·ªÉ thi tri·ªÉn " + skill.n);
            return;
        }

        const cdEl = document.getElementById(`cd-${skill.id}`);
        if (cdEl && cdEl.style.height !== '0%' && cdEl.style.height !== '') {
            UI.addLog("H·ªÜ TH·ªêNG", skill.n + " ƒëang trong th·ªùi gian h·ªìi chi√™u!");
            return;
        }

        // Tr·ª´ n·ªôi l·ª±c v√† b·∫Øt ƒë·∫ßu h·ªìi chi√™u
        State.player.mp -= skill.mp;
        this.startCooldown(skill);
        UI.addLog("K·ª∏ NƒÇNG", "Thi tri·ªÉn: " + skill.n + "!");

        // Hi·ªáu ·ª©ng VFX chi√™u th·ª©c (V√≤ng s√°ng lan t·ªèa)
        this.createSkillVFX(State.player.x, State.player.y, skill.range || 300, State.player.sect.color);

        // Qu√©t m·ª•c ti√™u trong ph·∫°m vi s√°t th∆∞∆°ng
        let hitCount = 0;
        const targets = [...State.world.mobs, ...State.world.bosses];
        
        targets.forEach(target => {
            const dist = Math.hypot(State.player.x - target.x, State.player.y - target.y);
            if (dist <= (skill.range || 300)) {
                // T√≠nh to√°n s√°t th∆∞∆°ng d·ª±a tr√™n h·ªá s·ªë chi√™u th·ª©c
                this.calculateDamage(State.player, target, skill.dmg);
                hitCount++;
            }
        });

        if (hitCount > 0) {
            UI.addLog("CHI·∫æN ƒê·∫§U", `G√¢y s√°t th∆∞∆°ng l√™n ${hitCount} m·ª•c ti√™u.`);
        }
        UI.update();
    };

    Engine.startCooldown = function(skill) {
        const cdEl = document.getElementById(`cd-${skill.id}`);
        if (!cdEl) return;

        let start = Date.now();
        const timer = setInterval(() => {
            let elapsed = Date.now() - start;
            let progress = 100 - (elapsed / skill.cd * 100);
            
            if (progress <= 0) {
                cdEl.style.height = '0%';
                clearInterval(timer);
            } else {
                cdEl.style.height = progress + '%';
            }
        }, 50);
    };

    Engine.createSkillVFX = function(x, y, range, color) {
        const vfx = document.createElement('div');
        vfx.style.position = 'absolute';
        vfx.style.left = x + 'px';
        vfx.style.top = y + 'px';
        vfx.style.width = '0px';
        vfx.style.height = '0px';
        vfx.style.border = `4px solid ${color}`;
        vfx.style.borderRadius = '50%';
        vfx.style.transform = 'translate(-50%, -50%)';
        vfx.style.pointerEvents = 'none';
        vfx.style.boxShadow = `0 0 30px ${color}`;
        vfx.style.transition = 'all 0.6s ease-out';
        vfx.style.zIndex = '90';

        document.getElementById('layer-vfx').appendChild(vfx);

        // Hi·ªáu ·ª©ng b√πng n·ªï
        requestAnimationFrame(() => {
            vfx.style.width = (range * 2) + 'px';
            vfx.style.height = (range * 2) + 'px';
            vfx.style.opacity = '0';
        });

        setTimeout(() => vfx.remove(), 700);
    };

    /** ============================================================
     * PH·∫¶N 4: H·ªÜ TH·ªêNG NPC AI & GI·∫¢I TO√ÅN TH√îNG MINH
     * ============================================================
     */

    const NPCLogic = {
        interact(npcId) {
            const npc = State.world.npcs.find(n => n.id === npcId);
            if (!npc) return;

            // D·ª´ng AI tu·∫ßn tra c·ªßa NPC khi ƒëang n√≥i chuy·ªán
            npc.vx = 0; npc.vy = 0;
            npc.nextAction = Date.now() + 10000;

            const dialog = document.getElementById('dialogue-system');
            const nameEl = document.getElementById('npc-display-name');
            const msgEl = document.getElementById('npc-display-msg');
            const optEl = document.getElementById('npc-display-options');

            dialog.style.display = 'block';
            nameEl.innerText = npc.name;
            
            // T·∫°o b√†i to√°n ng·∫´u nhi√™n
            const a = Math.floor(Math.random() * 50) + 10;
            const b = Math.floor(Math.random() * 50) + 10;
            const result = a + b;

            msgEl.innerHTML = `Ch√†o ƒë·∫°i hi·ªáp! Ta c√≥ m·ªôt c√¢u ƒë·ªë nh·ªè ƒë·ªÉ th·ª≠ th√°ch cƒÉn c·ªët c·ªßa ng∆∞∆°i:<br><br><b>${a} c·ªông ${b} b·∫±ng bao nhi√™u?</b>`;
            
            optEl.innerHTML = '';
            // T·∫°o 3 ph∆∞∆°ng √°n tr·∫£ l·ªùi
            [result, result + 10, result - 5].sort(() => Math.random() - 0.5).forEach(val => {
                const btn = document.createElement('button');
                btn.style.padding = '10px 20px';
                btn.style.cursor = 'pointer';
                btn.innerText = "ƒê√°p √°n: " + val;
                btn.onclick = () => this.handleAnswer(val, result, npc);
                optEl.appendChild(btn);
            });
        },

        handleAnswer(choice, correct, npc) {
            if (choice === correct) {
                alert("NPC: Qu·∫£ l√† th√¥ng minh tuy·ªát ƒë·ªânh! Nh·∫≠n l·∫•y ph·∫ßn th∆∞·ªüng n√†y.");
                State.player.exp += 2000;
                State.player.money += 500;
                UI.addLog("NPC", "B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng b√†i to√°n c·ªßa " + npc.name);
                Engine.checkLevelUp();
            } else {
                alert("NPC: Sai r·ªìi! ƒê·∫°i hi·ªáp c·∫ßn luy·ªán t·∫≠p th√™m v·ªÅ t√≠nh to√°n.");
                UI.addLog("NPC", "B·∫°n ƒë√£ tr·∫£ l·ªùi sai c√¢u ƒë·ªë.");
            }
            UI.closeDialogue();
            UI.update();
        }
    };

    UI.closeDialogue = function() {
        document.getElementById('dialogue-system').style.display = 'none';
    };

    // L·∫Øng nghe s·ª± ki·ªán click v√†o NPC tr√™n Map
    document.getElementById('layer-entities').addEventListener('click', (e) => {
        let target = e.target;
        while (target && !target.id) target = target.parentElement;
        if (target && target.id.startsWith('npc-')) {
            NPCLogic.interact(target.id);
        }
    });

    /** ============================================================
     * PH·∫¶N 5: H·ªÜ TH·ªêNG L∆ØU TR·ªÆ & KH·ªûI CH·∫†Y (FINAL)
     * ============================================================
     */

    const Persistence = {
        save() {
            const data = JSON.stringify(State.player);
            localStorage.setItem('VOLAM_SAVE_DATA', data);
            UI.addLog("H·ªÜ TH·ªêNG", "ƒê√£ l∆∞u l·∫°i c√¥ng l·ª±c v√†o s·ªï k√Ω danh.");
        },
        load() {
            const saved = localStorage.getItem('VOLAM_SAVE_DATA');
            if (saved) {
                const loadedData = JSON.parse(saved);
                // Ch·ªâ load n·∫øu c√πng m√¥n ph√°i ho·∫∑c x·ª≠ l√Ω ph·ª©c t·∫°p h∆°n t√πy √Ω
                UI.addLog("H·ªÜ TH·ªêNG", "Ph√°t hi·ªán d·ªØ li·ªáu c≈©, ƒë·∫°i hi·ªáp c√≥ mu·ªën ti·∫øp t·ª•c?");
            }
        }
    };

    // T·ª± ƒë·ªông l∆∞u m·ªói 60 gi√¢y
    setInterval(() => {
        if (State.settings.isRunning) Persistence.save();
    }, 60000);

    // X·ª≠ l√Ω ph√≠m t·∫Øt s·ªë 1, 2, 3, 4 ƒë·ªÉ d√πng skill
    window.addEventListener('keydown', e => {
        if (!State.player.sect) return;
        const key = e.key;
        if (key >= '1' && key <= '4') {
            const skill = State.player.sect.skills[parseInt(key) - 1];
            if (skill) Engine.castSkill(skill);
        }
    });

    // Th√™m c√°c ph√°i v√†o m√†n h√¨nh ch·ªçn ban ƒë·∫ßu (B·ªï sung cho ph·∫ßn 1)
    const startList = document.querySelector('#start-screen div');
    startList.innerHTML += `
        <div class="pointer" onclick="Engine.init('VO_DANG')" style="width:300px; padding:40px; background:#111; border:2px solid #333; border-radius:20px; text-align:center; cursor:pointer; transition:0.3s;">
            <h2 style="color:#3498db">V√ï ƒêANG</h2>
            <hr style="margin:15px 0; border:0; border-top:1px solid #333">
            <p style="text-align:left; font-size:14px; line-height:2">
                <span style="color:var(--exp)">‚óè N·ªôi l·ª±c v√¥ song: +1000</span><br>
                <span style="color:var(--exp)">‚óè T·ªâ l·ªá b·∫°o k√≠ch: +1.2x</span><br>
                <span style="color:var(--hp)">‚óè Sinh l·ª±c: Trung b√¨nh</span><br>
                <span style="color:var(--hp)">‚óè Th·ªß ph√°p: C√¢n b·∫±ng</span>
            </p>
        </div>
        <div class="pointer" onclick="Engine.init('DUONG_MON')" style="width:300px; padding:40px; background:#111; border:2px solid #333; border-radius:20px; text-align:center; cursor:pointer; transition:0.3s;">
            <h2 style="color:#9b59b6">ƒê∆Ø·ªúNG M√îN</h2>
            <hr style="margin:15px 0; border:0; border-top:1px solid #333">
            <p style="text-align:left; font-size:14px; line-height:2">
                <span style="color:var(--exp)">‚óè Th√¢n ph√°p c·ª±c nhanh: +8</span><br>
                <span style="color:var(--exp)">‚óè √Åm kh√≠ s√°t th∆∞∆°ng: +2.0x</span><br>
                <span style="color:var(--hp)">‚óè Sinh l·ª±c c·ª±c th·∫•p: -400</span><br>
                <span style="color:var(--hp)">‚óè Th·ªß y·∫øu, d·ªÖ b·ªã tr·ªçng th∆∞∆°ng</span>
            </p>
        </div>
    `;

    console.log("H·ªá th·ªëng V√µ L√¢m Supreme: V·∫°n C·ªï Quy T√¥ng ƒë√£ s·∫µn s√†ng kh·ªüi ch·∫°y!");

</script>
</body>
        </html>
            
