<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>THI√äN GI·ªöI V√î T·∫¨N - B·∫¢N FIX L·ªñI H·ªÜ TH·ªêNG</title>
    <style>
        :root {
            --cyan: #00ffff; --gold: #f1c40f; --red: #ff4757; 
            --ui-bg: rgba(10, 10, 10, 0.98); --border: #333;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            margin: 0; padding: 0; background: #000; overflow: hidden; 
            font-family: 'Segoe UI', Arial, sans-serif; color: white; user-select: none; 
        }

        /* M√†n h√¨nh kh·ªüi ƒë·∫ßu - S·ª≠a l·ªói kh√¥ng b·∫•m ƒë∆∞·ª£c */
        #start-screen {
            position: fixed; inset: 0; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
        }
        .logo-area { text-align: center; margin-bottom: 30px; }
        .logo-area h1 { color: var(--gold); font-size: 35px; letter-spacing: 8px; margin: 0; text-shadow: 0 0 20px rgba(241, 196, 15, 0.5); }
        
        #sect-list {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            width: 100%; max-width: 400px; max-height: 50vh; overflow-y: auto;
            padding: 10px; border: 1px solid #222; background: rgba(255,255,255,0.02); border-radius: 15px;
        }
        .sect-card {
            padding: 15px; background: #111; border: 2px solid #333;
            border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .sect-card.selected { border-color: var(--cyan); background: rgba(0,255,255,0.1); transform: scale(1.05); }
        .sect-card i { font-style: normal; font-size: 24px; }
        .sect-card span { font-size: 14px; font-weight: bold; }

        .btn-start {
            margin-top: 30px; padding: 18px 80px; background: var(--gold);
            border: none; border-radius: 40px; font-weight: bold; font-size: 18px;
            cursor: pointer; box-shadow: 0 5px 20px rgba(241, 196, 15, 0.4);
            transition: 0.2s;
        }
        .btn-start:active { transform: scale(0.95); opacity: 0.8; }

        /* HUD & Giao di·ªán ch√≠nh */
        #game-ui { display: none; } /* Ch·ªâ hi·ªán khi v√†o game */
        
        .hud-top {
            position: absolute; top: 15px; left: 15px;
            display: flex; align-items: center; gap: 15px;
            background: var(--ui-bg); padding: 10px 20px;
            border-radius: 50px; border: 1px solid var(--border); z-index: 100;
        }
        .avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gold); display: flex; align-items: center; justify-content: center; font-size: 25px; }
        .hp-container { width: 150px; height: 10px; background: #222; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        #hp-bar { width: 100%; height: 100%; background: var(--red); transition: 0.3s; }

        /* H·ªá th·ªëng 3 K·ªπ nƒÉng (V√≤ng cung quanh n√∫t ƒë√°nh) */
        .action-controls {
            position: absolute; bottom: 30px; right: 30px;
            width: 260px; height: 260px; z-index: 100;
        }
        .btn-attack {
            position: absolute; bottom: 10px; right: 10px;
            width: 95px; height: 95px; background: var(--cyan);
            border: 4px solid #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; box-shadow: 0 0 20px rgba(0,255,255,0.5);
            pointer-events: auto; z-index: 110;
        }
        .skill-slot {
            position: absolute; width: 65px; height: 65px;
            background: var(--ui-bg); border: 2px solid #555;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 28px; pointer-events: auto; transition: 0.2s;
        }
        .skill-slot.active { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }
        .skill-slot .cooldown {
            position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7);
            height: 0%; border-radius: 50%;
        }

        /* T·ªça ƒë·ªô n√∫t b·∫•m */
        #slot0 { top: 0; right: 10px; }      /* Ph√≠a tr√™n */
        #slot1 { top: 50px; left: 10px; }    /* B√™n tr√°i tr√™n */
        #slot2 { bottom: 100px; left: 0; }   /* B√™n tr√°i d∆∞·ªõi */

        /* B·∫£ng T√¥ng M√¥n / H·ªçc ƒê·∫°o */
        #sect-panel {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 450px; background: var(--ui-bg);
            border: 2px solid var(--gold); border-radius: 20px; display: none;
            padding: 20px; z-index: 2000;
        }
        .panel-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab { flex: 1; padding: 10px; text-align: center; background: #222; border-radius: 8px; cursor: pointer; }
        .tab.active { background: var(--gold); color: black; font-weight: bold; }
        #skill-container { height: 300px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* MiniMap & Radar */
        .radar-box {
            position: absolute; top: 15px; right: 15px;
            width: 120px; height: 120px; background: rgba(0,0,0,0.8);
            border: 2px solid #444; border-radius: 10px; z-index: 100;
        }
        #radar-canvas { width: 100%; height: 100%; }

        /* Joystick */
        #joy-base {
            position: absolute; bottom: 50px; left: 50px;
            width: 150px; height: 150px; background: rgba(255,255,255,0.05);
            border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); z-index: 100;
        }
        #joy-stick {
            position: absolute; top: 50%; left: 50%;
            width: 60px; height: 60px; margin: -30px;
            background: rgba(255,255,255,0.2); border-radius: 50%;
        }

        #exit-sect-btn {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            padding: 10px 25px; background: var(--red); color: white; border: none;
            border-radius: 20px; display: none; z-index: 150; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="start-screen">
        <div class="logo-area">
            <h1>THI√äN GI·ªöI V√î T·∫¨N</h1>
            <p>Ch·ªçn kh·ªüi ƒëi·ªÉm c·ªßa con ƒë∆∞·ªùng tu ti√™n</p>
        </div>
        <div id="sect-list">
            </div>
        <button class="btn-start" onclick="checkAndStart()">B·∫ÆT ƒê·∫¶U TU LUY·ªÜN</button>
    </div>

    <div id="game-ui">
        <div class="hud-top">
            <div class="avatar" id="ui-avatar">üë§</div>
            <div>
                <div style="font-weight:bold; font-size:14px;" id="ui-sect-name">K·∫ª v√¥ danh</div>
                <div class="hp-container"><div id="hp-bar"></div></div>
                <div style="font-size:12px; color:var(--gold);">üí∞ <span id="ui-gold">0</span></div>
            </div>
        </div>

        <div class="radar-box">
            <canvas id="radar-canvas" width="120" height="120"></canvas>
            <div id="ui-coords" style="position:absolute; bottom:2px; width:100%; text-align:center; font-size:9px; color:#888;">0, 0</div>
        </div>

        <button id="exit-sect-btn" onclick="triggerExitSect()">R·ªúI KH·ªéI T√îNG M√îN</button>

        <div id="joy-base"><div id="joy-stick"></div></div>

        <div class="action-controls">
            <div class="btn-attack" id="main-atk">‚öîÔ∏è</div>
            <div class="skill-slot" id="slot0">üîí<div class="cooldown" id="cd0"></div></div>
            <div class="skill-slot" id="slot1">üîí<div class="cooldown" id="cd1"></div></div>
            <div class="skill-slot" id="slot2">üîí<div class="cooldown" id="cd2"></div></div>
        </div>

        <div id="sect-panel">
            <h3 id="panel-header" style="text-align:center; color:var(--gold);">TR∆Ø·ªûNG M√îN</h3>
            <div class="panel-tabs">
                <div class="tab active" onclick="switchTab('LEARN', this)">H·ªåC ƒê·∫†O</div>
                <div class="tab" onclick="switchTab('EQUIP', this)">TRANG B·ªä</div>
            </div>
            <div id="skill-container"></div>
            <button onclick="togglePanel(false)" style="width:100%; margin-top:15px; padding:10px; background:#444; color:white; border:none; border-radius:8px;">LUI RA</button>
        </div>
    </div>

    <canvas id="mainCanvas"></canvas>
</div>
<script>
    // 1. C·∫•u h√¨nh D·ªØ li·ªáu 10 T√¥ng M√¥n (Full 14 Tuy·ªát K·ªπ/Ph√°i)
    const SECT_DATA = {
        "V√µ ƒêang": { color: "#3498db", icon: "‚òØÔ∏è", skills: [
            {n: "Th√°i C·ª±c Ki·∫øm", i: "üó°Ô∏è", cost: 500, cd: 2, dmg: 100},
            {n: "B√°t Qu√°i Ch∆∞·ªüng", i: "üëê", cost: 2000, cd: 4, dmg: 250},
            {n: "Thanh Phong B·ªô", i: "üçÉ", cost: 8000, cd: 12, dmg: 0},
            {n: "Th·∫ßn M√¥n Ki·∫øm", i: "‚öîÔ∏è", cost: 20000, cd: 6, dmg: 600},
            {n: "H·ªï Tr·∫£o Th·ªß", i: "üêæ", cost: 50000, cd: 8, dmg: 1000},
            {n: "V√¥ C·ª±c C√¥ng", i: "üåÄ", cost: 120000, cd: 15, dmg: 2500},
            {n: "Th√°i C·ª±c Tr·∫≠n", i: "üéá", cost: 300000, cd: 30, dmg: 6000},
            {n: "Huy·ªÅn V≈© C√¥ng", i: "üê¢", cost: 800000, cd: 40, dmg: 12000},
            {n: "Th√°i H∆∞ Ki·∫øm", i: "‚ú®", cost: 1500000, cd: 25, dmg: 25000},
            {n: "L∆∞·ª°ng Nghi ·∫§n", i: "üåó", cost: 3000000, cd: 35, dmg: 55000},
            {n: "Ch√¢n V≈© Ki·∫øm", i: "üî±", cost: 7000000, cd: 50, dmg: 120000},
            {n: "ƒê·∫°o Ph√°p T·ª± Nhi√™n", i: "üìú", cost: 15000000, cd: 70, dmg: 300000},
            {n: "V√¥ Th∆∞·ª£ng Th√°i C·ª±c", i: "üåå", cost: 35000000, cd: 100, dmg: 700000},
            {n: "Nh√¢n Ki·∫øm H·ª£p Nh·∫•t", i: "‚õ©Ô∏è", cost: 80000000, cd: 150, dmg: 2000000}
        ]},
        "Thi·∫øu L√¢m": { color: "#f1c40f", icon: "üìø", skills: [
            {n: "La H√°n Quy·ªÅn", i: "‚úä", cost: 500, cd: 2, dmg: 110},
            {n: "Vi ƒê√† Ch∆∞·ªüng", i: "‚úã", cost: 2000, cd: 3, dmg: 280},
            {n: "S∆∞ T·ª≠ H·ªëng", i: "ü¶Å", cost: 8000, cd: 12, dmg: 800},
            {n: "Kim Cang Ph·ª•c Ma", i: "‚õìÔ∏è", cost: 20000, cd: 10, dmg: 1500},
            {n: "Long Tr·∫£o Th·ªß", i: "üêâ", cost: 50000, cd: 7, dmg: 2200},
            {n: "D·ªãch C√¢n Kinh", i: "üß¨", cost: 120000, cd: 60, dmg: 0},
            {n: "B√°t Nh√£ Ch∆∞·ªüng", i: "üßø", cost: 300000, cd: 20, dmg: 7000},
            {n: "Thi√™n Th·ªß Quan √Çm", i: "üôå", cost: 800000, cd: 30, dmg: 15000},
            {n: "B·ªì ƒê·ªÅ C√¥ng", i: "üå≥", cost: 1500000, cd: 45, dmg: 35000},
            {n: "ƒê·∫°i Bi Ch√∫", i: "üïç", cost: 3000000, cd: 55, dmg: 65000},
            {n: "Nh∆∞ Lai Th·∫ßn Ch∆∞·ªüng", i: "üñêÔ∏è", cost: 7000000, cd: 80, dmg: 150000},
            {n: "Kim Cang B·∫•t Ho·∫°i", i: "üõ°Ô∏è", cost: 15000000, cd: 120, dmg: 0},
            {n: "V·∫°n Ph·∫≠t Tri·ªÅu T√¥ng", i: "‚ò∏Ô∏è", cost: 35000000, cd: 160, dmg: 800000},
            {n: "Th·∫ßn Th√¥ng Ph·∫≠t ƒê√†", i: "üèÆ", cost: 80000000, cd: 200, dmg: 2500000}
        ]},
        "Minh Gi√°o": { color: "#e67e22", icon: "üî•", skills: [ {n: "H·ªèa Long", i: "üî•", cost: 500, cd: 2, dmg: 120}, {n: "C√†n Kh√¥n", i: "üåÄ", cost: 50000, cd: 20, dmg: 5000} ] },
        "C√°i Bang": { color: "#8e44ad", icon: "üçñ", skills: [ {n: "ƒê·∫£ C·∫©u", i: "ü•¢", cost: 500, cd: 2, dmg: 105}, {n: "H√†ng Long", i: "üêâ", cost: 50000, cd: 10, dmg: 6000} ] },
        "ƒê∆∞·ªùng M√¥n": { color: "#2ecc71", icon: "üèπ", skills: [ {n: "ƒê·ªôc Ti√™u", i: "üìç", cost: 500, cd: 1.5, dmg: 95}, {n: "B·∫°o V≈©", i: "üí•", cost: 50000, cd: 15, dmg: 5500} ] },
        "Nga Mi": { color: "#fd79a8", icon: "üå∏", skills: [ {n: "Ki·∫øm Ph√°p", i: "üó°Ô∏è", cost: 500, cd: 2, dmg: 100}, {n: "Thanh T√¢m", i: "üßº", cost: 50000, cd: 40, dmg: 0} ] },
        "Hoa S∆°n": { color: "#ecf0f1", icon: "‚õ∞Ô∏è", skills: [ {n: "Xung Linh", i: "‚öîÔ∏è", cost: 500, cd: 2, dmg: 110}, {n: "ƒê·ªôc C√¥", i: "ü¶Ö", cost: 50000, cd: 18, dmg: 8000} ] },
        "Ti√™u Dao": { color: "#55efc4", icon: "üß™", skills: [ {n: "B·∫Øc Minh", i: "üåÄ", cost: 500, cd: 3, dmg: 130}, {n: "LƒÉng Ba", i: "üí®", cost: 50000, cd: 25, dmg: 0} ] },
        "To√†n Ch√¢n": { color: "#9b59b6", icon: "üåü", skills: [ {n: "Nh·∫•t D∆∞∆°ng", i: "‚òùÔ∏è", cost: 500, cd: 2, dmg: 115}, {n: "Ti√™n Thi√™n", i: "üßò", cost: 50000, cd: 60, dmg: 0} ] },
        "Huy·∫øt ƒêao": { color: "#c0392b", icon: "üî™", skills: [ {n: "Huy·∫øt S√°t", i: "üî™", cost: 500, cd: 2, dmg: 150}, {n: "Huy·∫øt H·∫£i", i: "ü©∏", cost: 50000, cd: 15, dmg: 9000} ] }
    };

    // 2. Bi·∫øn Game To√†n C·ª•c
    let game = {
        state: 'START', p: { x: 0, y: 0, speed: 2.5, hp: 1500, maxHp: 1500, gold: 0, sect: null, owned: [], equip: [null, null, null], cd: [0, 0, 0] },
        entities: [], cam: { x: 0, y: 0 }, joy: { active: false, x: 0, y: 0 }, lastSectPos: { x: 0, y: 0 }
    };

    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const rCanvas = document.getElementById('radar-canvas');
    const rCtx = rCanvas.getContext('2d');

    // 3. Kh·ªüi t·∫°o danh s√°ch ph√°i (S·ª≠a l·ªói kh√¥ng hi·ªÉn th·ªã)
    function initSectList() {
        const list = document.getElementById('sect-list');
        list.innerHTML = "";
        Object.keys(SECT_DATA).forEach(name => {
            const card = document.createElement('div');
            card.className = 'sect-card';
            card.innerHTML = `<i>${SECT_DATA[name].icon}</i><span>${name}</span>`;
            card.onclick = () => {
                game.p.sect = name;
                document.querySelectorAll('.sect-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
            };
            list.appendChild(card);
        });
    }

    // 4. H√†m B·∫Øt ƒë·∫ßu Game (S·ª≠a l·ªói ƒë·ª©ng m√°y)
    function checkAndStart() {
        if (!game.p.sect) return alert("ƒê·∫°i hi·ªáp h√£y ch·ªçn m·ªôt T√¥ng m√¥n ƒë·ªÉ xu·∫•t th·∫ø!");
        
        // Chuy·ªÉn ƒë·ªïi giao di·ªán
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        
        // C·∫≠p nh·∫≠t HUD
        document.getElementById('ui-sect-name').innerText = game.p.sect;
        document.getElementById('ui-avatar').innerText = SECT_DATA[game.p.sect].icon;
        
        // C·∫•u h√¨nh Canvas
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        game.state = 'WORLD';
        addLog("H·ªá th·ªëng: Ch√†o m·ª´ng " + game.p.sect + " ƒë·ªá t·ª≠ gia nh·∫≠p giang h·ªì!");
        
        // K√≠ch ho·∫°t v√≤ng l·∫∑p game
        requestAnimationFrame(gameLoop);
    }

    // G·ªçi h√†m kh·ªüi t·∫°o ngay l·∫≠p t·ª©c
    window.onload = initSectList;
</script>
    /** --- H·ªÜ TH·ªêNG ƒêI·ªÄU KHI·ªÇN JOYSTICK (TOUCH & MOUSE) --- **/
    const joyBase = document.getElementById('joy-base');
    const joyStick = document.getElementById('joy-stick');
    let joyRect = joyBase.getBoundingClientRect();

    const handleJoyMove = (e) => {
        if (!game.joy.active) return;
        e.preventDefault();
        const touch = e.touches ? e.touches[0] : e;
        const centerX = joyRect.left + joyRect.width / 2;
        const centerY = joyRect.top + joyRect.height / 2;
        
        let dx = touch.clientX - centerX;
        let dy = touch.clientY - centerY;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const maxDist = joyRect.width / 2;

        if (dist > maxDist) { dx *= maxDist / dist; dy *= maxDist / dist; }

        game.joy.x = dx / maxDist;
        game.joy.y = dy / maxDist;
        joyStick.style.transform = `translate(${dx}px, ${dy}px)`;
    };

    joyBase.addEventListener('touchstart', (e) => { game.joy.active = true; joyRect = joyBase.getBoundingClientRect(); handleJoyMove(e); });
    window.addEventListener('touchmove', handleJoyMove, { passive: false });
    window.addEventListener('touchend', () => {
        game.joy.active = false; game.joy.x = 0; game.joy.y = 0;
        joyStick.style.transform = `translate(0px, 0px)`;
    });

    /** --- H·ªÜ TH·ªêNG D·ªäCH CHUY·ªÇN T√îNG M√îN --- **/
    function enterSectPortal(name) {
        if (game.p.sect !== name) {
            addLog(`<span style="color:var(--red)">C·∫•m ƒë·ªãa! ƒê·ªá t·ª≠ ${name} m·ªõi ƒë∆∞·ª£c ph√©p v√†o.</span>`);
            game.p.x -= 80; return;
        }
        game.lastSectPos = { x: game.p.x, y: game.p.y };
        game.state = 'SECT';
        game.p.x = 500; game.p.y = 800; // V·ªã tr√≠ c·ª≠a v√†o trong map ph√°i
        document.getElementById('exit-sect-btn').style.display = 'block';
        addLog(`ƒêang ti·∫øn v√†o th√°nh ƒë·ªãa ${name}...`);
    }

    function triggerExitSect() {
        game.state = 'WORLD';
        game.p.x = game.lastSectPos.x; game.p.y = game.lastSectPos.y + 100;
        document.getElementById('exit-sect-btn').style.display = 'none';
        addLog("ƒê√£ tr·ªü v·ªÅ th·∫ø gi·ªõi ngo√†i.");
    }

    /** --- V√íNG L·∫∂P GAME CH√çNH (LOGIC) --- **/
    function gameLoop() {
        updateLogic();
        renderGraphics();
        requestAnimationFrame(gameLoop);
    }

    function updateLogic() {
        // Di chuy·ªÉn nh√¢n v·∫≠t
        if (game.joy.active) {
            game.p.x += game.joy.x * game.p.speed;
            game.p.y += game.joy.y * game.p.speed;
        }

        // Camera b√°m s√°t
        game.cam.x = canvas.width / 2 - game.p.x;
        game.cam.y = canvas.height / 2 - game.p.y;

        if (game.state === 'WORLD') {
            // Sinh qu√°i v√† c·ªïng ph√°i n·∫øu ch∆∞a c√≥
            if (game.entities.length < 10) spawnWorldEntities();
            
            // Ki·ªÉm tra va ch·∫°m c·ªïng ph√°i
            game.entities.forEach(en => {
                if (en.type === 'portal') {
                    let d = Math.sqrt((en.x - game.p.x)**2 + (en.y - game.p.y)**2);
                    if (d < 70) enterSectPortal(en.name);
                }
            });
        } else {
            // Gi·ªõi h·∫°n trong T√¥ng m√¥n (Map ph√°i nh·ªè 1000x1000)
            game.p.x = Math.max(120, Math.min(880, game.p.x));
            game.p.y = Math.max(120, Math.min(880, game.p.y));
            
            // Ki·ªÉm tra l·∫°i g·∫ßn Tr∆∞·ªüng m√¥n (V·ªã tr√≠ m·∫∑c ƒë·ªãnh 500, 300)
            let distToMaster = Math.sqrt((game.p.x - 500)**2 + (game.p.y - 300)**2);
            if (distToMaster < 80 && document.getElementById('sect-panel').style.display === 'none') {
                togglePanel(true);
            }
        }
    }

    function spawnWorldEntities() {
        let sects = Object.keys(SECT_DATA);
        // Sinh c·ªïng ph√°i
        sects.forEach(s => {
            game.entities.push({
                type: 'portal', name: s, 
                x: (Math.random() - 0.5) * 4000, 
                y: (Math.random() - 0.5) * 4000 
            });
        });
        // Sinh qu√°i
        for(let i=0; i<15; i++) {
            game.entities.push({
                type: 'mob', hp: 150, maxHp: 150,
                x: (Math.random() - 0.5) * 3000, 
                y: (Math.random() - 0.5) * 3000
            });
        }
    }

    function addLog(m) {
        // T·∫°o log ƒë∆°n gi·∫£n n·∫øu ch∆∞a c√≥ h·ªá th·ªëng log ph·ª©c t·∫°p
        console.log(m);
    }
                /** --- H·ªÜ TH·ªêNG GIAO DI·ªÜN PANEL (H·ªåC ƒê·∫†O & TRANG B·ªä) --- **/
    let currentTab = 'LEARN';

    function togglePanel(show) {
        const panel = document.getElementById('sect-panel');
        panel.style.display = show ? 'block' : 'none';
        if (show) renderSkillList();
    }

    function switchTab(tab, el) {
        currentTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        renderSkillList();
    }

    function renderSkillList() {
        const container = document.getElementById('skill-container');
        container.innerHTML = '';
        const skills = SECT_DATA[game.p.sect].skills;

        skills.forEach((s, idx) => {
            const isOwned = game.p.owned.includes(s.n);
            const card = document.createElement('div');
            card.style.cssText = `background:#1a1a1a; padding:10px; border-radius:10px; border:1px solid ${isOwned ? 'var(--cyan)' : '#333'}; text-align:center;`;
            
            let actionBtn = '';
            if (currentTab === 'LEARN') {
                actionBtn = isOwned ? `<span style="color:gray; font-size:12px;">ƒê√É THU·ªòC</span>` : 
                            `<button onclick="buySkill(${idx})" style="background:var(--gold); border:none; border-radius:4px; padding:5px 10px; font-weight:bold;">${s.cost}üí∞</button>`;
            } else {
                actionBtn = isOwned ? `<div style="display:flex; gap:3px; justify-content:center;">
                                <button onclick="equipSkill('${s.n}', 0)" style="font-size:10px;">√î1</button>
                                <button onclick="equipSkill('${s.n}', 1)" style="font-size:10px;">√î2</button>
                                <button onclick="equipSkill('${s.n}', 2)" style="font-size:10px;">√î3</button>
                             </div>` : `<span style="color:gray; font-size:10px;">CH∆ØA H·ªåC</span>`;
            }

            card.innerHTML = `<div style="font-size:20px;">${s.i}</div>
                              <div style="font-size:11px; font-weight:bold;">${s.n}</div>
                              <div style="font-size:9px; color:#aaa; margin-bottom:5px;">ST: ${s.dmg}</div>
                              ${actionBtn}`;
            container.appendChild(card);
        });
    }

    function buySkill(idx) {
        const s = SECT_DATA[game.p.sect].skills[idx];
        if (game.p.gold >= s.cost) {
            game.p.gold -= s.cost;
            game.p.owned.push(s.n);
            updateHUD(); renderSkillList();
            addLog(`Ch√∫c m·ª´ng! B·∫°n ƒë√£ ng·ªô ƒë∆∞·ª£c [${s.n}]`);
        } else {
            alert("Linh th·∫°ch kh√¥ng ƒë·ªß!");
        }
    }

    function equipSkill(name, slot) {
        // G·ª° b·ªè n·∫øu k·ªπ nƒÉng ƒë√£ ·ªü √¥ kh√°c
        let existing = game.p.equip.indexOf(name);
        if (existing !== -1) game.p.equip[existing] = null;
        
        game.p.equip[slot] = name;
        updateHUD();
        addLog(`ƒê√£ trang b·ªã ${name} v√†o √¥ ${slot + 1}`);
    }

    /** --- H·ªÜ TH·ªêNG CHI·∫æN ƒê·∫§U (COMBAT) --- **/
    document.getElementById('main-atk').onclick = () => {
        performAttack(60, 40, "‚öîÔ∏è"); // ƒê√°nh th∆∞·ªùng
    };

    function useSkill(slot) {
        const sName = game.p.equip[slot];
        if (!sName) return;
        
        const now = Date.now();
        const sData = SECT_DATA[game.p.sect].skills.find(sk => sk.n === sName);
        
        if (now - game.p.cd[slot] < sData.cd * 1000) return;

        game.p.cd[slot] = now;
        startCooldownAnim(slot, sData.cd);
        performAttack(180, sData.dmg, sData.i);
    }

    function startCooldownAnim(slot, sec) {
        const mask = document.getElementById(`cd${slot}`);
        mask.style.height = '100%';
        let start = Date.now();
        let timer = setInterval(() => {
            let elapsed = Date.now() - start;
            let percent = 100 - (elapsed / (sec * 1000) * 100);
            mask.style.height = Math.max(0, percent) + '%';
            if (percent <= 0) clearInterval(timer);
        }, 50);
    }

    function performAttack(range, dmg, icon) {
        let hit = false;
        game.entities.forEach(en => {
            if (en.type === 'mob') {
                let d = Math.sqrt((en.x - game.p.x)**2 + (en.y - game.p.y)**2);
                if (d < range) {
                    en.hp -= dmg;
                    hit = true;
                    if (en.hp <= 0) {
                        en.dead = true;
                        game.p.gold += 200;
                    }
                }
            }
        });
        // Hi·ªáu ·ª©ng ch·ªØ n·ªïi (t·∫°m th·ªùi log)
        if (hit) updateHUD();
    }

    // G√°n s·ª± ki·ªán cho 3 √¥ k·ªπ nƒÉng
    [0,1,2].forEach(i => {
        document.getElementById(`slot${i}`).onclick = () => useSkill(i);
    });

    /** --- ƒê·ªí H·ªåA (RENDERING) --- **/
    function renderGraphics() {
        ctx.fillStyle = "#050505"; ctx.fillRect(0,0,canvas.width,canvas.height);
        const cx = game.cam.x, cy = game.cam.y;

        // V·∫Ω L∆∞·ªõi (Grid)
        ctx.strokeStyle = "#111"; ctx.lineWidth = 1;
        for(let x = (game.p.x % 100); x < canvas.width; x += 100) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }

        if (game.state === 'WORLD') {
            game.entities = game.entities.filter(e => !e.dead);
            game.entities.forEach(en => {
                let dx = en.x + cx, dy = en.y + cy;
                if (en.type === 'portal') {
                    ctx.font = "50px Arial"; ctx.fillText("‚õ©Ô∏è", dx-25, dy);
                    ctx.fillStyle = "gold"; ctx.font = "bold 12px Arial"; ctx.fillText(en.name, dx-20, dy+25);
                } else {
                    ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(dx, dy, 15, 0, Math.PI*2); ctx.fill();
                    // M√°u qu√°i
                    ctx.fillStyle = "#222"; ctx.fillRect(dx-15, dy-25, 30, 4);
                    ctx.fillStyle = "lime"; ctx.fillRect(dx-15, dy-25, (en.hp/en.maxHp)*30, 4);
                    // AI ƒë∆°n gi·∫£n: Qu√°i ƒëu·ªïi theo
                    let adx = game.p.x - en.x, ady = game.p.y - en.y;
                    let dist = Math.sqrt(adx*adx + ady*ady);
                    if (dist < 400) { en.x += adx/dist * 1.5; en.y += ady/dist * 1.5; }
                }
            });
        } else {
            // V·∫Ω Map T√¥ng M√¥n
            ctx.fillStyle = "#151515"; ctx.fillRect(100+cx, 100+cy, 800, 800);
            ctx.strokeStyle = SECT_DATA[game.p.sect].color; ctx.strokeRect(100+cx, 100+cy, 800, 800);
            ctx.font = "60px Arial"; ctx.fillText("üßô‚Äç‚ôÇÔ∏è", 500+cx-30, 300+cy);
            ctx.fillStyle = "white"; ctx.font = "14px Arial"; ctx.fillText("TR∆Ø·ªûNG M√îN", 500+cx-40, 340+cy);
        }

        // V·∫Ω Nh√¢n V·∫≠t (Player)
        const px = canvas.width/2, py = canvas.height/2;
        ctx.fillStyle = SECT_DATA[game.p.sect].color;
        ctx.beginPath(); ctx.arc(px, py, 12, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.stroke();

        renderRadar();
    }

    function renderRadar() {
        rCtx.fillStyle = "black"; rCtx.fillRect(0,0,120,120);
        game.entities.forEach(en => {
            let rx = 60 + (en.x - game.p.x)*0.05;
            let ry = 60 + (en.y - game.p.y)*0.05;
            if (rx > 0 && rx < 120 && ry > 0 && ry < 120) {
                rCtx.fillStyle = en.type === 'portal' ? "gold" : "red";
                rCtx.beginPath(); rCtx.arc(rx, ry, en.type === 'portal' ? 3 : 1.5, 0, Math.PI*2); rCtx.fill();
            }
        });
        rCtx.fillStyle = "cyan"; rCtx.beginPath(); rCtx.arc(60,60,2,0,Math.PI*2); rCtx.fill();
        document.getElementById('ui-coords').innerText = `${Math.floor(game.p.x)}, ${Math.floor(game.p.y)}`;
    }

    function updateHUD() {
        document.getElementById('ui-gold').innerText = game.p.gold.toLocaleString();
        document.getElementById('hp-bar').style.width = (game.p.hp / game.p.maxHp * 100) + "%";
        
        // C·∫≠p nh·∫≠t ph√≠m k·ªπ nƒÉng
        game.p.equip.forEach((name, i) => {
            const slot = document.getElementById(`slot${i}`);
            if (name) {
                const s = SECT_DATA[game.p.sect].skills.find(sk => sk.n === name);
                slot.innerHTML = s.i + `<div class="cooldown" id="cd${i}"></div>`;
                slot.classList.add('active');
            } else {
                slot.innerHTML = "üîí"; slot.classList.remove('active');
            }
        });
    }

    function addLog(m) {
        console.log(m); // Log ra console ƒë·ªÉ tr√°nh r√°c m√†n h√¨nh, ƒë·∫°i hi·ªáp c√≥ th·ªÉ t·∫°o div log ri√™ng
    }
</script>
</body>
            </html>
                
