<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>V√ï L√ÇM V√î T·∫¨N - MOBILE EDITION</title>
    <style>
        :root {
            --cyan: #00ffff; --gold: #f1c40f; --red: #ff4757; 
            --purple: #a29bfe; --bg: #050505; --ui-bg: rgba(0, 0, 0, 0.8);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; padding: 0; background: #000; overflow: hidden; 
            font-family: 'Segoe UI', sans-serif; color: white; user-select: none; 
        }

        /* --- C·∫§U TR√öC M√ÄN H√åNH NGANG --- */
        #game-wrapper { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        canvas { display: block; background: #000; }

        /* --- UI L·ªöP TR√äN --- */
        .hud { position: absolute; inset: 0; pointer-events: none; }
        .hud * { pointer-events: auto; }

        /* Th√¥ng tin nh√¢n v·∫≠t (G√≥c tr√™n tr√°i) */
        .player-header {
            position: absolute; top: 10px; left: 10px;
            display: flex; gap: 10px; background: var(--ui-bg);
            padding: 8px; border-radius: 40px 10px 10px 40px; border: 1px solid #444;
        }
        .avatar { width: 50px; height: 50px; background: #222; border: 2px solid var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .stats { display: flex; flex-direction: column; justify-content: center; }
        .hp-bar-bg { width: 150px; height: 8px; background: #222; border-radius: 4px; margin: 3px 0; overflow: hidden; }
        .hp-bar-fill { height: 100%; background: var(--red); width: 100%; transition: 0.3s; }

        /* Mini Map (G√≥c tr√™n ph·∫£i) */
        .map-container {
            position: absolute; top: 10px; right: 10px;
            width: 140px; height: 140px; background: #000;
            border: 2px solid #555; border-radius: 8px; overflow: hidden;
        }
        #radar { width: 100%; height: 100%; }
        .map-btns { position: absolute; bottom: 2px; right: 2px; display: flex; gap: 2px; }
        .map-btn { width: 22px; height: 22px; background: #333; color: #fff; border: none; font-size: 14px; border-radius: 3px; }

        /* H·ªá th·ªëng ph√≠m di chuy·ªÉn (B√™n tr√°i) */
        #touch-move-area {
            position: absolute; bottom: 20px; left: 20px;
            width: 150px; height: 150px; background: rgba(255,255,255,0.05);
            border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);
        }
        #joystick-stick {
            position: absolute; top: 50%; left: 50%;
            width: 60px; height: 60px; margin: -30px;
            background: rgba(255,255,255,0.2); border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* H·ªá th·ªëng K·ªπ nƒÉng (B√™n ph·∫£i - Layout v√≤ng cung) */
        .skill-container { position: absolute; bottom: 20px; right: 20px; width: 250px; height: 250px; }
        .btn-main-atk {
            position: absolute; bottom: 20px; right: 20px;
            width: 90px; height: 90px; background: var(--cyan);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 35px; box-shadow: 0 0 20px var(--cyan); border: 3px solid #fff;
        }
        .skill-btn {
            position: absolute; width: 55px; height: 55px;
            background: var(--ui-bg); border: 2px solid #666; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 20px; transition: 0.1s; filter: grayscale(1);
        }
        .skill-btn.unlocked { filter: grayscale(0); border-color: var(--gold); }
        .skill-btn .cd-overlay { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); height: 0%; border-radius: 50%; }
        .skill-btn .price { position: absolute; top: -15px; font-size: 9px; color: var(--gold); }

        /* T·ªça ƒë·ªô skill (V√≤ng cung quanh n√∫t ƒë√°nh ch√≠nh) */
        #sk-0 { bottom: 120px; right: 10px; }
        #sk-1 { bottom: 110px; right: 80px; }
        #sk-2 { bottom: 75px; right: 140px; }
        #sk-3 { bottom: 10px; right: 150px; }
        #sk-4 { bottom: -15px; right: 85px; } /* Ph√≠m ·∫©n ho·∫∑c n√¢ng cao */

        /* Shop & Chat */
        #shop-ui {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 350px; background: var(--ui-bg); border: 2px solid var(--gold);
            padding: 20px; border-radius: 10px; display: none; z-index: 1000;
        }
        .shop-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; }
        #chat-box {
            position: absolute; bottom: 10px; left: 180px; width: 250px; height: 100px;
            background: rgba(0,0,0,0.4); font-size: 11px; padding: 5px; overflow-y: auto;
            pointer-events: none; border-radius: 5px;
        }

        /* Start Screen */
        #start-screen {
            position: fixed; inset: 0; background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .sect-btn {
            padding: 12px 30px; margin: 5px; background: #111; border: 1px solid #444;
            color: white; border-radius: 5px; cursor: pointer; width: 200px;
        }
        .sect-btn.active { border-color: var(--cyan); background: rgba(0,255,255,0.1); }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="start-screen">
        <h2 style="color:var(--cyan)">V√ï L√ÇM V√î T·∫¨N: MOBILE</h2>
        <p style="font-size: 12px; color: #888;">Di chuy·ªÉn: Joystick Tr√°i | K·ªπ nƒÉng: Ph√≠m Ph·∫£i</p>
        <div id="sect-picker"></div>
        <button onclick="startGame()" style="margin-top:20px; padding:15px 50px; background:var(--cyan); border:none; font-weight:bold; border-radius:30px;">B·∫ÆT ƒê·∫¶U TU H√ÄNH</button>
    </div>

    <div id="shop-ui">
        <h3 style="text-align:center; color:var(--gold); margin-top:0;">TRUY·ªÄN TH·ª™A C√îNG PH√ÅP</h3>
        <div id="shop-items"></div>
        <button onclick="closeShop()" style="width:100%; margin-top:15px; padding:8px; background:var(--red); border:none; color:white;">LUI RA</button>
    </div>

    <canvas id="mainCanvas"></canvas>

    <div class="hud">
        <div class="player-header">
            <div class="avatar" id="p-avatar">üë§</div>
            <div class="stats">
                <div style="font-size:12px; font-weight:bold;"><span id="ui-sect">Ph√°i</span> - <span id="ui-name">ƒê·∫°i Hi·ªáp</span></div>
                <div class="hp-bar-bg"><div id="hp-bar" class="hp-bar-fill"></div></div>
                <div style="font-size:11px; color:var(--gold)">üí∞ Linh th·∫°ch: <span id="ui-gold">0</span></div>
            </div>
        </div>

        <div class="map-container">
            <canvas id="radar"></canvas>
            <div class="map-btns">
                <button class="map-btn" onclick="mapZoom(0.8)">-</button>
                <button class="map-btn" onclick="mapZoom(1.2)">+</button>
            </div>
            <div style="position:absolute; top:2px; left:5px; font-size:9px; color:#aaa;" id="ui-coords">0,0</div>
        </div>

        <div id="chat-box"></div>

        <div id="touch-move-area">
            <div id="joystick-stick"></div>
        </div>

        <div class="skill-container">
            <div class="btn-main-atk" id="btn-atk">‚öîÔ∏è</div>
            <div id="skills-sub-group">
                </div>
        </div>
    </div>
</div>

<script>
    /** --- C·∫§U H√åNH H·ªÜ TH·ªêNG T√îNG M√îN --- **/
    const SECT_CONFIG = {
        "V√µ ƒêang": {
            color: "#3498db", icon: "‚òØÔ∏è",
            skills: [
                {n: "Th√°i C·ª±c Ki·∫øm", icon: "üó°Ô∏è", cost: 200, cd: 3, dmg: 80},
                {n: "B√°t Qu√°i Ch∆∞·ªüng", icon: "üëê", cost: 1000, cd: 6, dmg: 150},
                {n: "Thanh Phong B·ªô", icon: "üçÉ", cost: 5000, cd: 10, dmg: 0},
                {n: "Thi√™n ƒê·ªãa V√¥ C·ª±c", icon: "üåÄ", cost: 25000, cd: 20, dmg: 500},
                {n: "Th√°i C·ª±c Tr·∫≠n", icon: "üéá", cost: 100000, cd: 45, dmg: 2000}
            ]
        },
        "Thi·∫øu L√¢m": {
            color: "#f1c40f", icon: "üìø",
            skills: [
                {n: "La H√°n Quy·ªÅn", icon: "‚úä", cost: 200, cd: 2, dmg: 70},
                {n: "C·ª≠u D∆∞∆°ng C√¥ng", icon: "‚òÄÔ∏è", cost: 1000, cd: 8, dmg: 200},
                {n: "Kim Cang Ch∆∞·ªüng", icon: "‚úã", cost: 5000, cd: 5, dmg: 300},
                {n: "S∆∞ T·ª≠ H·ªëng", icon: "ü¶Å", cost: 25000, cd: 15, dmg: 600},
                {n: "Nh∆∞ Lai Th·∫ßn Ch∆∞·ªüng", icon: "üñêÔ∏è", cost: 100000, cd: 40, dmg: 2500}
            ]
        },
        "ƒê∆∞·ªùng M√¥n": {
            color: "#2ecc71", icon: "üèπ",
            skills: [
                {n: "Xuy√™n T√¢m Ti·ªÖn", icon: "üìç", cost: 200, cd: 1.5, dmg: 60},
                {n: "ƒê·ªôc Th√≠ch", icon: "üß™", cost: 1000, cd: 4, dmg: 180},
                {n: "M√™ ·∫¢nh B·ªô", icon: "üë£", cost: 5000, cd: 12, dmg: 0},
                {n: "B·∫°o V≈© L√™ Hoa", icon: "üí•", cost: 25000, cd: 10, dmg: 400},
                {n: "Ph·∫≠t N·ªô ƒê∆∞·ªùng Li√™n", icon: "üå∫", cost: 100000, cd: 50, dmg: 3000}
            ]
        }
    };

    /** --- KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C --- **/
    let canvas = document.getElementById('mainCanvas');
    let ctx = canvas.getContext('2d');
    let rCanvas = document.getElementById('radar');
    let rCtx = rCanvas.getContext('2d');

    let game = {
        state: 'start',
        p: {
            x: 0, y: 0, vx: 0, vy: 0, speed: 2.2, // T·ªëc ƒë·ªô di chuy·ªÉn ch·∫≠m
            hp: 1000, maxHp: 1000, gold: 0,
            sect: null, skills: [], lastS: [0,0,0,0,0]
        },
        world: { chunks: new Set(), entities: [], zoom: 0.03 },
        input: { joyX: 0, joyY: 0 }
    };

    /** --- KH·ªûI T·∫†O BAN ƒê·∫¶U --- **/
    function initPicker() {
        const root = document.getElementById('sect-picker');
        Object.keys(SECT_CONFIG).forEach(s => {
            const btn = document.createElement('div');
            btn.className = 'sect-btn';
            btn.innerText = s;
            btn.onclick = () => {
                game.p.sect = s;
                document.querySelectorAll('.sect-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            };
            root.appendChild(btn);
        });
        resize();
        window.addEventListener('resize', resize);
    }
    initPicker();

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        rCanvas.width = 140; rCanvas.height = 140;
    }

    function startGame() {
        if(!game.p.sect) return alert("Vui l√≤ng ch·ªçn T√¥ng M√¥n!");
        game.p.skills = SECT_CONFIG[game.p.sect].skills.map(s => ({...s, unlocked: false}));
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('ui-sect').innerText = game.p.sect;
        document.getElementById('p-avatar').innerText = SECT_CONFIG[game.p.sect].icon;
        
        setupMobileControls();
        genSkillButtons();
        addLog("H·ªá th·ªëng: B·∫Øt ƒë·∫ßu h√†nh tr√¨nh c√†y cu·ªëc. H√£y t√¨m NPC T√¥ng m√¥n ƒë·ªÉ h·ªçc ƒë·∫°o!");
        game.state = 'play';
        requestAnimationFrame(loop);
    }

    /** --- H·ªÜ TH·ªêNG ƒêI·ªÄU KHI·ªÇN MOBILE (JOYSTICK + SKILLS) --- **/
    function setupMobileControls() {
        // Joystick b√™n tr√°i
        const moveArea = document.getElementById('touch-move-area');
        const stick = document.getElementById('joystick-stick');
        
        const handleMove = (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = moveArea.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let dx = touch.clientX - centerX;
            let dy = touch.clientY - centerY;
            let dist = Math.sqrt(dx*dx + dy*dy);
            let maxDist = rect.width / 2;

            if(dist > maxDist) {
                dx *= maxDist / dist;
                dy *= maxDist / dist;
                dist = maxDist;
            }

            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            game.input.joyX = dx / maxDist;
            game.input.joyY = dy / maxDist;
        };

        const resetMove = () => {
            stick.style.transform = `translate(0, 0)`;
            game.input.joyX = 0;
            game.input.joyY = 0;
        };

        moveArea.addEventListener('touchstart', handleMove);
        moveArea.addEventListener('touchmove', handleMove);
        moveArea.addEventListener('touchend', resetMove);

        // N√∫t ƒë√°nh th∆∞·ªùng b√™n ph·∫£i
        document.getElementById('btn-atk').addEventListener('touchstart', (e) => {
            e.preventDefault();
            performAttack(-1); // -1 l√† ƒë√°nh th∆∞·ªùng
        });
    }

    function genSkillButtons() {
        const container = document.getElementById('skills-sub-group');
        container.innerHTML = '';
        game.p.skills.forEach((s, i) => {
            const btn = document.createElement('div');
            btn.className = 'skill-btn';
            btn.id = `sk-${i}`;
            btn.innerHTML = `
                <div class="price">${s.cost}</div>
                ${s.icon}
                <div class="cd-overlay" id="cd-${i}"></div>
            `;
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                performAttack(i);
            });
            container.appendChild(btn);
        });
    }

    /** --- LOGIC GAME & CHI·∫æN ƒê·∫§U --- **/
    function performAttack(idx) {
        if(idx === -1) { // ƒê√°nh th∆∞·ªùng
            checkHit(50, 100); // 50 dmg, t·∫ßm 100
            return;
        }

        let s = game.p.skills[idx];
        if(!s.unlocked) return addLog("H·ªá th·ªëng: K·ªπ nƒÉng ch∆∞a ƒë∆∞·ª£c h·ªçc!");
        
        let now = Date.now();
        if(now - game.p.lastS[idx] < s.cd * 1000) return;

        game.p.lastS[idx] = now;
        const cdOverlay = document.getElementById(`cd-${idx}`);
        cdOverlay.style.height = '100%';
        cdOverlay.style.transition = 'none';
        setTimeout(() => {
            cdOverlay.style.transition = `height ${s.cd}s linear`;
            cdOverlay.style.height = '0%';
        }, 50);

        checkHit(s.dmg, 200);
        addLog(`B·∫°n thi tri·ªÉn: ${s.n}`);
    }

    function checkHit(dmg, range) {
        game.world.entities.forEach(en => {
            if(en.type === 'mob') {
                let dist = Math.sqrt((en.x - game.p.x)**2 + (en.y - game.p.y)**2);
                if(dist < range) {
                    en.hp -= dmg;
                    if(en.hp <= 0) {
                        en.dead = true;
                        let drop = Math.floor(Math.random() * 4) + 1; // C√†y c·ª±c kh√≥: 1-4 v√†ng
                        game.p.gold += drop;
                    }
                }
            }
        });
        game.world.entities = game.world.entities.filter(e => !e.dead);
    }

    /** --- QU·∫¢N L√ù B·∫¢N ƒê·ªí V√î T·∫¨N --- **/
    function updateWorld() {
        let cx = Math.floor(game.p.x / 2500), cy = Math.floor(game.p.y / 2500);
        for(let i=-1; i<=1; i++){
            for(let j=-1; j<=1; j++){
                let key = `${cx+i},${cy+j}`;
                if(!game.world.chunks.has(key)) {
                    game.world.chunks.add(key);
                    spawnEntities(cx+i, cy+j);
                }
            }
        }
    }

    function spawnEntities(cx, cy) {
        let bx = cx * 2500, by = cy * 2500;
        // NPC T√¥ng m√¥n (C·ª±c hi·∫øm tr√™n map r·ªông)
        if(Math.random() > 0.7) {
            game.world.entities.push({
                type: 'sect-npc', x: bx + 500 + Math.random()*1500, y: by + 500 + Math.random()*1500,
                name: Object.keys(SECT_CONFIG)[Math.floor(Math.random()*3)]
            });
        }
        // Qu√°i v·∫≠t
        for(let k=0; k<8; k++) {
            game.world.entities.push({
                type: 'mob', x: bx + Math.random()*2500, y: by + Math.random()*2500,
                hp: 200, maxHp: 200, color: '#ff4757'
            });
        }
    }

    /** --- V√íNG L·∫∂P CH√çNH (RENDER) --- **/
    function loop() {
        if(game.state !== 'play') return;

        // C·∫≠p nh·∫≠t v·ªã tr√≠
        game.p.x += game.input.joyX * game.p.speed;
        game.p.y += game.input.joyY * game.p.speed;
        updateWorld();

        // V·∫Ω n·ªÅn
        ctx.fillStyle = "#050505"; ctx.fillRect(0,0,canvas.width,canvas.height);
        let camX = canvas.width/2 - game.p.x, camY = canvas.height/2 - game.p.y;

        // V·∫Ω l∆∞·ªõi Grid
        ctx.strokeStyle = "#151515"; ctx.lineWidth = 1;
        let startX = Math.floor(game.p.x / 100) * 100 - 1000;
        let startY = Math.floor(game.p.y / 100) * 100 - 1000;
        for(let x = startX; x < startX + 2000; x += 100) {
            ctx.beginPath(); ctx.moveTo(x + camX, 0); ctx.lineTo(x + camX, canvas.height); ctx.stroke();
        }
        for(let y = startY; y < startY + 2000; y += 100) {
            ctx.beginPath(); ctx.moveTo(0, y + camY); ctx.lineTo(canvas.width, y + camY); ctx.stroke();
        }

        // V·∫Ω th·ª±c th·ªÉ
        game.world.entities.forEach(en => {
            let dx = en.x + camX, dy = en.y + camY;
            if(dx < -50 || dx > canvas.width+50 || dy < -50 || dy > canvas.height+50) return;

            if(en.type === 'sect-npc') {
                ctx.font = "40px Arial"; ctx.fillText("üè∞", dx-20, dy);
                ctx.fillStyle = "#fff"; ctx.font = "12px Arial"; ctx.fillText(`NPC ${en.name}`, dx-25, dy+20);
                
                // Ki·ªÉm tra va ch·∫°m ƒë·ªÉ m·ªü Shop
                if(Math.sqrt((en.x - game.p.x)**2 + (en.y - game.p.y)**2) < 100) {
                    ctx.fillStyle = varColor('--gold'); ctx.fillText("NH·∫§N ƒê·ªÇ V√ÄO", dx-30, dy-40);
                    en.touchable = true;
                } else en.touchable = false;
            } else {
                ctx.fillStyle = en.color; ctx.beginPath(); ctx.arc(dx, dy, 15, 0, Math.PI*2); ctx.fill();
            }
        });

        // T∆∞∆°ng t√°c NPC b·∫±ng ch·∫°m m√†n h√¨nh (N·∫øu g·∫ßn)
        canvas.ontouchstart = (e) => {
            let npc = game.world.entities.find(en => en.touchable);
            if(npc) openShop(npc.name);
        };

        // V·∫Ω Stickman (Nh√¢n v·∫≠t ch√≠nh)
        drawPlayer(canvas.width/2, canvas.height/2);

        // C·∫≠p nh·∫≠t UI
        updateUI();
        drawRadar();

        requestAnimationFrame(loop);
    }

    function drawPlayer(x, y) {
        let color = SECT_CONFIG[game.p.sect].color;
        ctx.strokeStyle = color; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(x, y-40, 8, 0, Math.PI*2); ctx.stroke(); // ƒê·∫ßu
        ctx.beginPath(); ctx.moveTo(x, y-32); ctx.lineTo(x, y-10); ctx.stroke(); // Th√¢n
        ctx.beginPath(); ctx.moveTo(x, y-28); ctx.lineTo(x-15, y-15); ctx.stroke(); // Tay
        ctx.beginPath(); ctx.moveTo(x, y-28); ctx.lineTo(x+15, y-15); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x, y-10); ctx.lineTo(x-10, y+5); ctx.stroke(); // Ch√¢n
        ctx.beginPath(); ctx.moveTo(x, y-10); ctx.lineTo(x+10, y+5); ctx.stroke();
    }

    function drawRadar() {
        rCtx.fillStyle = "#000"; rCtx.fillRect(0,0,140,140);
        let cx = 70, cy = 70;
        game.world.entities.forEach(en => {
            let rx = cx + (en.x - game.p.x) * game.world.zoom;
            let ry = cy + (en.y - game.p.y) * game.world.zoom;
            if(rx < 0 || rx > 140 || ry < 0 || ry > 140) return;
            rCtx.fillStyle = en.type === 'sect-npc' ? varColor('--gold') : 'red';
            rCtx.beginPath(); rCtx.arc(rx, ry, en.type === 'sect-npc' ? 4 : 1.5, 0, Math.PI*2); rCtx.fill();
        });
        rCtx.fillStyle = varColor('--cyan'); rCtx.beginPath(); rCtx.arc(cx, cy, 3, 0, Math.PI*2); rCtx.fill();
    }

    /** --- UI HELPERS --- **/
    function updateUI() {
        document.getElementById('ui-gold').innerText = game.p.gold;
        document.getElementById('ui-coords').innerText = `${Math.floor(game.p.x)},${Math.floor(game.p.y)}`;
        document.getElementById('hp-bar').style.width = (game.p.hp/game.p.maxHp*100) + "%";
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t k·ªπ nƒÉng tr√™n m√†n h√¨nh
        game.p.skills.forEach((s, i) => {
            const btn = document.getElementById(`sk-${i}`);
            if (btn) {
                if (s.unlocked) {
                    btn.classList.add('unlocked');
                    btn.querySelector('.price').style.display = 'none'; // ƒê√£ h·ªçc th√¨ ·∫©n gi√°
                } else {
                    btn.classList.remove('unlocked');
                }
            }
        });
    }

    /** --- H·ªÜ TH·ªêNG C·ª¨A H√ÄNG NPC T√îNG M√îN --- **/
    function openShop(sectName) {
        // Ch·ªâ cho ph√©p mua k·ªπ nƒÉng c·ªßa ƒë√∫ng t√¥ng m√¥n ƒë√£ ch·ªçn l√∫c ƒë·∫ßu
        if(sectName !== game.p.sect) {
            addLog(`H·ªá th·ªëng: B·∫°n l√† ƒë·ªá t·ª≠ ${game.p.sect}, kh√¥ng th·ªÉ h·ªçc c√¥ng ph√°p c·ªßa ${sectName}!`);
            return;
        }

        const root = document.getElementById('shop-items');
        root.innerHTML = ''; // L√†m m·ªõi danh s√°ch v·∫≠t ph·∫©m
        
        game.p.skills.forEach((s, i) => {
            if(!s.unlocked) {
                const row = document.createElement('div');
                row.className = 'shop-row';
                row.innerHTML = `
                    <div style="display:flex; flex-direction:column;">
                        <span style="color:var(--cyan); font-weight:bold;">${s.n}</span>
                        <span style="font-size:10px; color:#aaa;">S√°t th∆∞∆°ng: ${s.dmg} | H·ªìi: ${s.cd}s</span>
                    </div>
                    <button onclick="buySkill(${i})" style="background:var(--gold); border:none; padding:8px 12px; color:#000; font-weight:bold; border-radius:4px; cursor:pointer;">
                        ${s.cost} üí∞
                    </button>
                `;
                root.appendChild(row);
            }
        });

        if (root.innerHTML === '') {
            root.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">Ng√†i ƒë√£ h·ªçc h·∫øt to√†n b·ªô tuy·ªát k·ªπ c·ªßa t√¥ng m√¥n!</div>';
        }

        document.getElementById('shop-ui').style.display = 'block';
    }

    function buySkill(i) {
        let s = game.p.skills[i];
        if(game.p.gold >= s.cost) {
            game.p.gold -= s.cost;
            game.p.skills[i].unlocked = true;
            addLog(`Ch√∫c m·ª´ng! Ng√†i ƒë√£ lƒ©nh h·ªôi ƒë∆∞·ª£c: ${s.n}`);
            updateUI(); // C·∫≠p nh·∫≠t l·∫°i ti·ªÅn v√† tr·∫°ng th√°i n√∫t
            openShop(game.p.sect); // Refresh danh s√°ch shop
        } else {
            alert("Linh th·∫°ch kh√¥ng ƒë·ªß! H√£y chƒÉm ch·ªâ c√†y cu·ªëc th√™m ·ªü ngo·∫°i vi.");
        }
    }

    function closeShop() { 
        document.getElementById('shop-ui').style.display = 'none'; 
    }

    /** --- C√ÅC H√ÄM TI·ªÜN √çCH KH√ÅC --- **/
    function mapZoom(v) { 
        // Gi·ªõi h·∫°n ƒë·ªô thu ph√≥ng c·ªßa mini-map
        game.world.zoom = Math.max(0.005, Math.min(0.1, game.world.zoom * v)); 
    }

    function addLog(m) {
        const box = document.getElementById('chat-box');
        const entry = document.createElement('div');
        entry.style.marginBottom = '4px';
        entry.innerHTML = `<span style="color:var(--gold)">[Tin nh·∫Øn]</span> ${m}`;
        box.appendChild(entry);
        
        // T·ª± ƒë·ªông cu·ªôn xu·ªëng tin nh·∫Øn m·ªõi nh·∫•t
        box.scrollTop = box.scrollHeight;
    }

    // L·∫•y m√£ m√†u t·ª´ bi·∫øn CSS
    function varColor(n) { 
        return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); 
    }

    // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng thay ƒë·ªïi k√≠ch th∆∞·ªõc m√†n h√¨nh ho·∫∑c xoay ƒëi·ªán tho·∫°i
    window.addEventListener('orientationchange', () => {
        setTimeout(resize, 200);
    });

</script>
</body>
</html>
