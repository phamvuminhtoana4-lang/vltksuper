<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>V√ï L√ÇM SUPREME: THI√äN H·∫† V√î SONG (MEGA BUILD)</title>

    <style id="game-main-styles">
        
:root {
    /* H·ªá th·ªëng bi·∫øn m√†u Ng≈© H√†nh (C·ª±c chi ti·∫øt) */
    --kim-glow: #ffffff; --kim-dark: #a0a0a0; --kim-vfx: rgba(255,255,255,0.8);
    --moc-glow: #2ecc71; --moc-dark: #1b5e20; --moc-vfx: rgba(46,204,113,0.8);
    --thuy-glow: #3498db; --thuy-dark: #1a237e; --thuy-vfx: rgba(52,152,219,0.8);
    --hoa-glow: #e74c3c; --hoa-dark: #b71c1c; --hoa-vfx: rgba(231,76,60,0.8);
    --tho-glow: #f1c40f; --tho-dark: #f57f17; --tho-vfx: rgba(241,196,15,0.8);

    /* Bi·∫øn hi·ªáu ·ª©ng AI Chat */
    --chat-bg: rgba(0, 0, 0, 0.85);
    --chat-border: var(--tho-glow);
    
    /* Animation Timing */
    --anim-fast: 0.2s;
    --anim-slow: 0.8s;
}

/* 1. N·ªÄN T·∫¢NG ƒê·ªí H·ªåA (THE FOUNDATION) */
body {
    background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%);
    cursor: url('https://cur.cursors-4u.net/games/gam-4/gam372.cur'), auto;
}

/* Hi·ªáu ·ª©ng m√¢y kh√≥i che ph·ªß b·∫£n ƒë·ªì */
.vfx-mist {
    position: absolute; inset: 0;
    background: url('https://www.transparenttextures.com/patterns/fog.png');
    opacity: 0.2; animation: fogMove 60s linear infinite;
    pointer-events: none; z-index: 5;
}

@keyframes fogMove {
    from { background-position: 0 0; }
    to { background-position: 10000px 5000px; }
}

/* 2. C∆† CH·∫æ AI CHAT BUBBLE (X·ª¨ L√ù T·ª∞ ƒê·ªòNG CHAT C·ª¶A NPC/QU√ÅI) */
.ai-chat-bubble {
    position: absolute; bottom: 130%; left: 50%;
    transform: translateX(-50%);
    background: var(--chat-bg);
    border: 1px solid var(--chat-border);
    padding: 6px 12px;
    border-radius: 12px;
    color: #fff;
    font-size: 11px;
    white-space: nowrap;
    z-index: 200;
    pointer-events: none;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.ai-chat-bubble::after {
    content: ''; position: absolute; top: 100%; left: 50%;
    border: 6px solid transparent; border-top-color: var(--chat-border);
    transform: translateX(-50%);
}

/* M√†u s·∫Øc chat theo t√¢m tr·∫°ng AI */
.chat-angry { border-color: var(--hoa-glow); color: var(--hoa-glow); font-weight: bold; }
.chat-scared { border-color: var(--thuy-glow); font-style: italic; }
.chat-funny { border-color: var(--moc-glow); }

@keyframes popIn { from { transform: translateX(-50%) scale(0); } to { transform: translateX(-50%) scale(1); } }

/* 3. CHI TI·∫æT NH√ÇN V·∫¨T & NPC (ADVANCED RIGGING) */
.entity {
    position: absolute; transition: transform 0.1s linear;
    filter: drop-shadow(0 0 5px rgba(0,0,0,0.8));
}

/* Stickman Bone Structure */
.rig-head {
    width: 24px; height: 24px; border: 2px solid #fff; border-radius: 50%;
    position: relative; background: #111;
}

/* AI NPC c·ªßa t·ª´ng ph√°i - ƒê·∫∑c ƒëi·ªÉm nh·∫≠n d·∫°ng */
.side-npc-thieulam .rig-head { border-color: var(--kim-glow); box-shadow: 0 0 10px var(--kim-glow); }
.side-npc-caibang .rig-head { border-color: var(--hoa-glow); }
.side-npc-duongmon .rig-head { border-color: var(--moc-glow); }

.eyes-vfx {
    position: absolute; top: 8px; width: 100%; display: flex; justify-content: space-around;
}

.eyes-vfx::before, .eyes-vfx::after {
    content: ''; width: 3px; height: 3px; background: #0ff; border-radius: 50%;
    box-shadow: 0 0 5px #0ff; animation: blink 3s infinite;
}

@keyframes blink { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0); } }

/* 4. H·ªÜ TH·ªêNG V≈® KH√ç SI√äU C·∫§P (WEAPON MODELS) */
.weapon-mount {
    position: absolute; top: 0; left: 0; width: 4px; height: 60px;
    background: linear-gradient(to bottom, transparent, #fff);
    transform-origin: top; transition: 0.3s;
}

/* Hi·ªáu ·ª©ng ch√©m (Slash VFX) */
.trail-vfx {
    position: absolute; top: 0; left: 0; width: 40px; height: 100px;
    background: conic-gradient(from 0deg, var(--tho-vfx), transparent);
    opacity: 0; pointer-events: none;
}

.attacking .trail-vfx {
    animation: slashAnim 0.3s ease-out;
}

@keyframes slashAnim {
    0% { opacity: 1; transform: rotate(0deg) scale(0.5); }
    100% { opacity: 0; transform: rotate(180deg) scale(1.5); }
}

/* 5. GIAO DI·ªÜN CH·ªåN PH√ÅI (SECT SELECTION UI) */
.sect-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 20px;
}

.sect-card {
    background: rgba(20, 20, 30, 0.9);
    border: 2px solid #333;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative; overflow: hidden;
}

.sect-card:hover {
    border-color: var(--tho-glow);
    transform: translateY(-10px) scale(1.05);
    box-shadow: 0 10px 30px rgba(241, 196, 15, 0.3);
}

.sect-card.active {
    border-color: var(--tho-glow);
    background: linear-gradient(145deg, #2c2c3e, #1a1a2e);
}

/* 6. QU√ÅI V·∫¨T & BOSS (MONSTERS & BOSSES) */
.mob-base {
    filter: drop-shadow(0 0 10px rgba(255,0,0,0.3));
}

.boss-entity {
    transform: scale(2.5);
    filter: drop-shadow(0 0 20px var(--hoa-glow));
}

.boss-aura {
    position: absolute; inset: -50px;
    background: radial-gradient(circle, rgba(231,76,60,0.2) 0%, transparent 70%);
    animation: bossPulse 2s infinite;
}

@keyframes bossPulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.2); opacity: 0.8; }
}

/* 7. UI CHI·∫æN ƒê·∫§U (BATTLE HUD) */
.btn-gate-supreme {
    background: linear-gradient(to bottom, #d4af37, #8a6d3b);
    border: 2px solid #fff;
    border-radius: 50px;
    color: #fff;
    padding: 15px 40px;
    font-size: 20px;
    font-weight: 900;
    text-shadow: 2px 2px #000;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    transition: 0.3s;
}

.btn-gate-supreme:active { transform: scale(0.9); }

/* N√∫t N·ªô (Ultimate Button) */
.ult-fire-vfx {
    position: absolute; inset: 0;
    background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
    mix-blend-mode: overlay;
    animation: fireMove 1s steps(10) infinite;
}

@keyframes fireMove { from { background-position: 0 0; } to { background-position: 0 100px; } }

/* 8. HI·ªÜU ·ª®NG TH·ªúI TI·∫æT DYNAMIC */
.sakura-rain-vfx {
    position: fixed; inset: 0; pointer-events: none; z-index: 100;
}

.petal {
    position: absolute; width: 10px; height: 10px;
    background: #ffb7c5; border-radius: 0 50% 0 50%;
    animation: petalFall 5s linear infinite;
}

@keyframes petalFall {
    0% { transform: translateY(-10vh) rotate(0deg); opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
}
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="start-screen">
        <div class="vfx-cinematic-bg">
            <div id="stars-layer"></div>
            <div id="clouds-layer"></div>
            <div id="embers-layer"></div>
        </div>

        <div class="ui-selection-master">
            <header class="game-branding">
                <div class="glow-title" data-text="V√ï L√ÇM SUPREME">V√ï L√ÇM SUPREME</div>
                <div class="sub-branding">V·∫†N C·ªî QUY T√îNG - CH√ç T√îN KI·∫æM HI·ªÜP</div>
                <div class="divider-v3"></div>
            </header>

            <div class="server-selector-grid">
                <div class="sv-node active" data-sv="1">
                    <div class="sv-status online"></div>
                    <div class="sv-info"><b>S1: TH√ÅI S∆†N</b><span>12ms</span></div>
                </div>
                <div class="sv-node" data-sv="2">
                    <div class="sv-status busy"></div>
                    <div class="sv-info"><b>S2: TR∆Ø·ªúNG GIANG</b><span>45ms</span></div>
                </div>
            </div>

            <section class="sect-mega-selection">
                <div class="sect-header-label">TH·ªàNH CH·ªåN TRUY·ªÄN TH·ª™A M√îN PH√ÅI</div>
                
                <div class="sect-container-scroll">
                    <div class="sect-grid-inner" id="sect-picker">
                        </div>
                </div>

                <div id="sect-full-preview" class="sect-card-preview">
                    <div class="visual-avatar">
                        <div class="aura-circle"></div>
                        <div id="hero-preview-model"></div>
                    </div>
                    <div class="detail-stats">
                        <h2 id="pre-name">--- CH·ªú CH·ªåN ---</h2>
                        <div class="stat-group">
                            <label>CƒÉn C·ªët (HP):</label> <div class="p-bar"><div id="pre-hp" class="p-fill"></div></div>
                            <label>N·ªôi C√¥ng (ATK):</label> <div class="p-bar"><div id="pre-atk" class="p-fill"></div></div>
                            <label>Th√¢n Ph√°p (SPD):</label> <div class="p-bar"><div id="pre-spd" class="p-fill"></div></div>
                            <label>May M·∫Øn (LUK):</label> <div class="p-bar"><div id="pre-luk" class="p-fill"></div></div>
                        </div>
                        <div class="sect-special-ability">
                            <b>Tuy·ªát H·ªçc:</b> <span id="pre-skill">???</span>
                            <p id="pre-desc">Ch·ªçn m√¥n ph√°i ƒë·ªÉ xem cƒÉn duy√™n giang h·ªì.</p>
                        </div>
                    </div>
                </div>
            </section>

            <footer class="gate-actions">
                <button id="btn-enter-game" class="btn-gate-supreme">XU·∫§T TH·∫æ GIANG H·ªí</button>
                <div class="loading-status hidden" id="boot-loader">
                    <div class="spinner-v3"></div>
                    <div class="text-status">ƒêang n·∫°p linh kh√≠ (0%)...</div>
                    <div class="progress-track"><div id="boot-progress"></div></div>
                </div>
            </footer>
        </div>
    </div>

    <main id="stage" style="display: none;">
        
        <div id="camera-viewport">
            <div id="world-map-container">
                
                <div id="terrain-canvas-group">
                    <canvas id="ground-mesh-layer"></canvas>
                    <div id="ancient-scenery">
                        </div>
                </div>

                <div id="dynamic-weather-system">
                    <div class="fog-emitter"></div>
                    <div class="sakura-rain-vfx"></div>
                    <div class="thunder-overlay"></div>
                    <div class="day-night-cycle-overlay"></div>
                </div>

                <div id="entities-interaction-layer">
                    
                    <article id="hero" class="entity player-class">
                        
                        <div class="vfx-wings-mount" id="hero-wings">
                            <div class="wing-part l-1"></div>
                            <div class="wing-part r-1"></div>
                        </div>

                        <div class="vfx-aura-mount" id="hero-aura"></div>

                        <div class="unit-overhead-hud">
                            <div class="rank-title-badge">‚≠ê V·∫°n C·ªï Ki·∫øm T√¥n ‚≠ê</div>
                            <div class="name-container">
                                <span class="guild-prefix">[H√†o Ki·ªát]</span>
                                <span id="hero-display-name">ƒê·∫°i Hi·ªáp</span>
                            </div>
                            <div class="mini-vital-bars">
                                <div class="mini-hp"><div id="hero-hp-mini" class="fill"></div></div>
                                <div class="mini-mp"><div id="hero-mp-mini" class="fill"></div></div>
                            </div>
                        </div>

                        <div class="stick-rig">
                            <div class="rig-head"><div class="eyes-vfx"></div><div class="hair-vfx"></div></div>
                            <div class="rig-torso">
                                <div class="arm arm-left"><div class="joint"></div><div class="hand"></div></div>
                                <div class="arm arm-right">
                                    <div class="joint"></div>
                                    <div class="hand">
                                        <div class="weapon-mount" id="hero-weapon">
                                            <div class="blade-edge"></div>
                                            <div class="glow-layer"></div>
                                            <div class="trail-vfx"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="rig-legs">
                                <div class="leg leg-left"></div>
                                <div class="leg leg-right"></div>
                            </div>
                        </div>

                        <div class="hero-shadow"></div>
                        <div class="footstep-vfx-pool"></div>
                    </article>

                    <div id="mobs-container"></div>
                    <div id="bosses-container"></div>
                    <div id="npcs-container"></div>
                    <div id="loot-drop-container"></div>
                </div>

                <div id="skill-vfx-layer"></div>
                <div id="damage-popup-layer"></div>
            </div>
        </div>

        <div id="ui-master-hud">
            
            <section class="hud-top-left">
                <div class="portrait-unit" onclick="ui.toggleModal('profile')">
                    <div id="ui-sect-icon-box" class="sect-icon"></div>
                    <div class="lv-box">99</div>
                </div>
                <div class="bars-stack">
                    <div class="bar-unit hp"><div id="ui-hp-fill" class="fill"></div><label id="ui-hp-txt">0/0</label></div>
                    <div class="bar-unit mp"><div id="ui-mp-fill" class="fill"></div><label id="ui-mp-txt">0/0</label></div>
                    <div class="bar-unit exp"><div id="ui-exp-fill" class="fill"></div></div>
                </div>
                <div class="currency-hud">
                    <div class="c-node">üí∞ <span id="ui-gold">0</span></div>
                    <div class="c-node">‚öîÔ∏è <span id="ui-atk">0</span></div>
                    <div class="c-node">üõ°Ô∏è <span id="ui-def">0</span></div>
                </div>
            </section>

            <aside class="hud-top-right">
                <div class="map-label">
                    <div class="m-name" id="ui-map-name">TRUNG NGUY√äN</div>
                    <div class="m-coords" id="ui-coords">0,0</div>
                </div>
                <div class="radar-box">
                    <canvas id="radar-canvas"></canvas>
                    <div class="radar-ping"></div>
                </div>
            </aside>

            <section class="hud-bottom-left">
                <div class="quest-tracker">
                    <div class="q-title">Nhi·ªám V·ª• Ch√≠nh Tuy·∫øn</div>
                    <div class="q-desc" id="ui-quest-desc">Ti√™u di·ªát 10 S∆°n T·∫∑c ƒë·ªÉ nh·∫≠n T·∫©y T·ªßy Kinh.</div>
                </div>
                <div class="chat-system">
                    <nav class="chat-tabs">
                        <button class="active">Th·∫ø Gi·ªõi</button>
                        <button>Bang</button>
                        <button>M·∫≠t</button>
                    </nav>
                    <div id="chat-messages" class="chat-flow"></div>
                    <div class="chat-input-row">
                        <input type="text" id="chat-input" placeholder="Nh·∫≠p l·ªùi mu·ªën n√≥i...">
                    </div>
                </div>
            </section>

            <nav id="hud-controls-mobile">
                
                <div id="joystick-wrapper">
                    <div id="joystick-base">
                        <div id="joystick-knob"></div>
                    </div>
                </div>

                <div id="skill-pad">
                    <div class="btn-main-atk-slot">
                        <button id="btn-attack">
                            <div class="atk-icon">‚öîÔ∏è</div>
                            <div class="cooldown-overlay"></div>
                        </button>
                    </div>

                    <div class="s-slot s1"><button id="btn-s1"><div class="cd" id="cd-1"></div><span class="key">1</span></button></div>
                    <div class="s-slot s2"><button id="btn-s2"><div class="cd" id="cd-2"></div><span class="key">2</span></button></div>
                    <div class="s-slot s3"><button id="btn-s3"><div class="cd" id="cd-3"></div><span class="key">3</span></button></div>
                    
                    <div class="s-slot s4-ult">
                        <button id="btn-s4">
                            <div class="cd" id="cd-4"></div>
                            <div class="ult-fire-vfx"></div>
                            <span class="key">N·ªò</span>
                        </button>
                    </div>

                    <div class="util-slot fly"><button id="btn-fly">‚úàÔ∏è</button></div>
                    <div class="util-slot mount"><button id="btn-mount">üêé</button></div>
                    <div class="util-slot sit"><button id="btn-sit">üßò</button></div>
                </div>
            </nav>

            <nav class="hud-side-menu">
                <button onclick="ui.openModal('inventory')">H√ÄNH TRANG</button>
                <button onclick="ui.openModal('skills')">TUY·ªÜT H·ªåC</button>
                <button onclick="ui.openModal('forge')">R√àN ƒê√öC</button>
                <button onclick="ui.openModal('shop')">K·ª≤ TR√ÇN</button>
                <button onclick="ui.openModal('guild')">BANG H·ªòI</button>
            </nav>
        </div>

        <div id="global-modal" class="modal-hidden">
            <div class="modal-window-v3">
                <header class="modal-header">
                    <div class="deco-l"></div>
                    <h2 id="modal-title">TH√îNG TIN</h2>
                    <div class="deco-r"></div>
                    <button class="close-btn" onclick="ui.closeModal()">‚úñ</button>
                </header>
                <div class="modal-content-area" id="modal-render-target">
                    </div>
                <footer class="modal-footer">
                    <div id="modal-footer-msg">H·ªá Th·ªëng V√µ L√¢m Supreme v3.0</div>
                </footer>
            </div>
        </div>

        <div id="toast-container"></div>

    </main>

    <audio id="bgm-player" loop></audio>
    <audio id="sfx-player"></audio>

    <script id="game-logic-part-3">
        

// 1. C·∫§U H√åNH D·ªÆ LI·ªÜU M√îN PH√ÅI (SECT DATA)
const SECTS = {
    thieulam: { name: "Thi·∫øu L√¢m", element: "Kim", atk: 80, hp: 1500, spd: 4, skill: "S∆∞ T·ª≠ H·ªëng", desc: "Ch√°nh t√¥ng v√µ h·ªçc, m√¨nh ƒë·ªìng da s·∫Øt." },
    vodang: { name: "V√µ ƒêang", element: "Th·ªï", atk: 90, hp: 1100, spd: 6, skill: "Th√°i C·ª±c Ki·∫øm", desc: "L·∫•y nhu th·∫Øng c∆∞∆°ng, ki·∫øm kh√≠ v√¥ h√¨nh." },
    ngami: { name: "Nga Mi", element: "Th·ªßy", atk: 75, hp: 1000, spd: 7, skill: "B·∫•t Di·ªát B·∫•t Tuy·ªát", desc: "H·ªó tr·ª£ ƒë·ªìng ƒë·ªôi, tr·ªã li·ªáu c·ª±c m·∫°nh." },
    caibang: { name: "C√°i Bang", element: "H·ªèa", atk: 110, hp: 1200, spd: 5, skill: "H√†ng Long Ch∆∞·ªüng", desc: "Thi√™n h·∫° ƒë·ªá nh·∫•t bang, b·ªôc ph√° c·ª±c cao." },
    duongmon: { name: "ƒê∆∞·ªùng M√¥n", element: "M·ªôc", atk: 120, hp: 800, spd: 8, skill: "B·∫°o V≈© L√™ Hoa", desc: "√Åm kh√≠ ƒë·ªôc m√¥n, xu·∫•t qu·ª∑ nh·∫≠p th·∫ßn." }
};

// 2. KHO D·ªÆ LI·ªÜU AI CHAT (NPC & MONSTER PERSONALITY)
const AI_QUOTES = {
    MONSTER_AGGRO: [
        "Ng∆∞∆°i nh√¨n c√°i g√¨? Mu·ªën n·∫øm th·ª≠ n·∫Øm ƒë·∫•m c·ªßa ta kh√¥ng?",
        "H√¥m nay ta s·∫Ω c√≥ th·ªãt ng∆∞·ªùi ƒë·ªÉ nh·∫Øm r∆∞·ª£u!",
        "K·∫ª n√†o d√°m b√©n m·∫£ng v√†o l√£nh ƒë·ªãa c·ªßa H·∫Øc Phong Bang?",
        "Giao n·∫°p ng√¢n l∆∞·ª£ng, ta cho ng∆∞∆°i ƒëi to√†n th√¢y!",
        "Tr√¥ng ng∆∞∆°i c√≥ v·∫ª... nhi·ªÅu ti·ªÅn ƒë·∫•y!"
    ],
    MONSTER_HURT: [
        "A! Nh·∫π tay th√¥i ƒë·∫°i hi·ªáp, ta ch·ªâ l√†m thu√™ th√¥i!",
        "H·ª±! Ki·∫øm ph√°p g√¨ m√† s·∫Øc th·∫ø?",
        "Ng∆∞∆°i ƒë·ª£i ƒë√≥, ta s·∫Ω g·ªçi ƒë·∫°i ca t·ªõi!",
        "Tha m·∫°ng! Nh√† ta c√≤n m·∫π gi√† con th∆°!",
        "Ch·∫øt ti·ªát, ta l·∫°i s∆° h·ªü r·ªìi..."
    ],
    NPC_SECT_CHAT: [
        "Huynh ƒë√†i, ph√°i c·ªßa ng∆∞∆°i d·∫°o n√†y y·∫øu th·∫ø qu√° nh·ªâ?",
        "Nh√¨n t∆∞·ªõng m·∫°o ng∆∞∆°i, ch·∫Øc ch·∫Øn l√† m·ªôt cao th·ªß!",
        "Giang h·ªì hi·ªÉm √°c, ƒëi ƒë·ª©ng c·∫©n th·∫≠n nh√©!",
        "Mu·ªën h·ªçc tuy·ªát k·ªπ kh√¥ng? N·∫°p t·ªá ƒëi r·ªìi ta ch·ªâ cho...",
        "T·ªëng Kim chi·∫øn tr∆∞·ªùng s·∫Øp m·ªü, chu·∫©n b·ªã ch∆∞a?"
    ],
    BOSS_LAUGH: [
        "Haha! Ch√∫t b·∫£n lƒ©nh n√†y m√† c≈©ng ƒë√≤i th√°ch th·ª©c ta?",
        "V·∫°n c·ªï quy t√¥ng! T·∫•t c·∫£ h√£y tan bi·∫øn ƒëi!",
        "Ch·∫øt d∆∞·ªõi tay ta l√† vinh d·ª± c·ªßa ng∆∞∆°i!",
        "Ta l√† b·∫•t b·∫°i! Th·∫ø gian kh√¥ng ai l√†m ta b·ªã th∆∞∆°ng ƒë∆∞·ª£c!"
    ]
};

// 3. KH·ªûI T·∫†O TR·∫†NG TH√ÅI GAME (GAME STATE)
const state = {
    player: {
        x: 1000000, y: 1000000,
        hp: 1000, maxHp: 1000, mp: 500, maxMp: 500,
        atk: 100, def: 50, spd: 6, gold: 1000, lv: 1,
        sect: null, isAttacking: false, isMoving: false,
        direction: 1 // 1: ph·∫£i, -1: tr√°i
    },
    mobs: [],
    bullets: [],
    viewport: { w: window.innerWidth, h: window.innerHeight },
    keys: {},
    joystick: { active: false, x: 0, y: 0 }
};

// 4. H·ªÜ TH·ªêNG AI LOGIC (NPC INTELLIGENCE)
const spawnAI_NPC = (type, x, y) => {
    const npc = {
        id: 'npc_' + Date.now() + Math.random(),
        type: type, // 'monster', 'sect_npc', 'boss'
        x: x, y: y,
        hp: 200, maxHp: 200,
        lastChat: 0,
        el: null
    };

    // T·∫°o DOM cho NPC
    const div = document.createElement('div');
    div.className = `entity ${type === 'monster' ? 'mob-base' : 'side-npc-thieulam'}`;
    div.innerHTML = `
        <div class="overhead-hud">
            <div class="name-tag">${type === 'monster' ? 'S∆°n T·∫∑c' : 'ƒê·ªìng M√¥n'}</div>
            <div class="hp-mini-box"><div class="fill" style="width:100%"></div></div>
        </div>
        <div class="stick-rig">
            <div class="rig-head"></div>
            <div class="rig-torso"><div class="arm arm-right"></div></div>
        </div>
    `;
    document.getElementById('mobs-container').appendChild(div);
    npc.el = div;
    state.mobs.push(npc);
};

const handleAIChat = (npc, messagePool) => {
    const now = Date.now();
    if (now - npc.lastChat > 5000 && Math.random() > 0.7) { // 5 gi√¢y chat 1 l·∫ßn, t·ª∑ l·ªá 30%
        const msg = messagePool[Math.floor(Math.random() * messagePool.length)];
        const bubble = document.createElement('div');
        bubble.className = 'ai-chat-bubble';
        bubble.innerText = msg;
        npc.el.appendChild(bubble);
        npc.lastChat = now;
        setTimeout(() => bubble.remove(), 3000);
    }
};

// 5. ENGINE V·∫¨N H√ÄNH (CORE LOOP)
const update = () => {
    // X·ª≠ l√Ω di chuy·ªÉn Player
    let dx = 0, dy = 0;
    if (state.keys['ArrowUp'] || state.keys['w']) dy -= state.player.spd;
    if (state.keys['ArrowDown'] || state.keys['s']) dy += state.player.spd;
    if (state.keys['ArrowLeft'] || state.keys['a']) { dx -= state.player.spd; state.player.direction = -1; }
    if (state.keys['ArrowRight'] || state.keys['d']) { dx += state.player.spd; state.player.direction = 1; }

    state.player.x += dx;
    state.player.y += dy;

    // Update Player View (Camera)
    const camX = state.player.x - state.viewport.w / 2;
    const camY = state.player.y - state.viewport.h / 2;
    document.getElementById('world-map-container').style.transform = `translate(${-camX}px, ${-camY}px)`;
    
    // Update Player Visuals
    const heroEl = document.getElementById('hero');
    heroEl.style.transform = `translate(${state.player.x}px, ${state.player.y}px) scaleX(${state.player.direction})`;

    // X·ª≠ l√Ω AI Mobs
    state.mobs.forEach(mob => {
        const dist = Math.hypot(state.player.x - mob.x, state.player.y - mob.y);
        
        // Logic ƒëu·ªïi b√°m
        if (dist < 400 && dist > 50) {
            mob.x += (state.player.x - mob.x) / 50;
            mob.y += (state.player.y - mob.y) / 50;
            handleAIChat(mob, AI_QUOTES.MONSTER_AGGRO);
        } else if (dist <= 50) {
            // T·∫•n c√¥ng ng∆∞·ªùi ch∆°i
            if (Math.random() > 0.95) damagePlayer(10);
        }

        mob.el.style.transform = `translate(${mob.x}px, ${mob.y}px)`;
    });

    requestAnimationFrame(update);
};

// 6. H·ªÜ TH·ªêNG CHI·∫æN ƒê·∫§U (COMBAT SYSTEM)
const damagePlayer = (amount) => {
    state.player.hp -= amount;
    updateUI();
    if (state.player.hp <= 0) {
        showToast("ƒê·∫°i hi·ªáp ƒë√£ ki·ªát s·ª©c! ƒêang h·ªìi ph·ª•c t·∫°i th√†nh...", "#ff4757");
        state.player.hp = state.player.maxHp;
        state.player.x = 1000000; state.player.y = 1000000;
    }
};

const updateUI = () => {
    document.getElementById('ui-hp-fill').style.width = (state.player.hp / state.player.maxHp * 100) + '%';
    document.getElementById('ui-hp-txt').innerText = `${Math.floor(state.player.hp)} / ${state.player.maxHp}`;
    document.getElementById('ui-gold').innerText = state.player.gold.toLocaleString();
    document.getElementById('ui-atk').innerText = state.player.atk;
};

// 7. KH·ªûI CH·∫†Y (INITIALIZATION)
const initGame = () => {
    // Render m√¥n ph√°i
    const picker = document.getElementById('sect-picker');
    Object.keys(SECTS).forEach(key => {
        const sect = SECTS[key];
        const card = document.createElement('div');
        card.className = 'sect-card';
        card.innerHTML = `<h3>${sect.name}</h3><p>H·ªá: ${sect.element}</p>`;
        card.onclick = () => selectSect(key);
        picker.appendChild(card);
    });

    // S·ª± ki·ªán b√†n ph√≠m
    window.onkeydown = (e) => state.keys[e.key] = true;
    window.onkeyup = (e) => state.keys[e.key] = false;

    // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p
    update();
    
    // T·∫°o qu√°i v·∫≠t xung quanh
    for(let i=0; i<20; i++) {
        spawnAI_NPC('monster', state.player.x + (Math.random()-0.5)*2000, state.player.y + (Math.random()-0.5)*2000);
    }
};

const selectSect = (key) => {
    state.player.sect = key;
    const sect = SECTS[key];
    state.player.maxHp = sect.hp;
    state.player.hp = sect.hp;
    state.player.atk = sect.atk;
    state.player.spd = sect.spd;
    
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('stage').style.display = 'block';
    document.getElementById('ui-sect-icon-box').innerText = sect.name[0];
    showToast(`Ch√†o m·ª´ng ƒë·∫°i hi·ªáp gia nh·∫≠p ${sect.name}!`, "#f1c40f");
    updateUI();
};

const showToast = (msg, color) => {
    const t = document.createElement('div');
    t.className = 'toast';
    t.style.background = color || 'rgba(0,0,0,0.8)';
    t.innerText = msg;
    document.getElementById('toast-container').appendChild(t);
    setTimeout(() => t.remove(), 3000);
};

// Ch·∫°y kh·ªüi t·∫°o
initGame();
    </script>

    <script id="game-logic-part-4">
// 1. DATABASE TRANG B·ªä SI√äU C·∫§P (EQUIPMENT DATABASE)
const ITEM_RARITY = {
    COMMON: { name: "Th∆∞·ªùng", color: "#ffffff", power: 1 },
    RARE: { name: "Hi·∫øm", color: "#3498db", power: 1.5 },
    EPIC: { name: "C·ª±c Ph·∫©m", color: "#9b59b6", power: 2.2 },
    LEGEND: { name: "HO√ÄNG KIM", color: "#f1c40f", power: 4 }
};

const EQUIPMENT_DB = [
    { id: 'w1', name: "Tr√∫c Ki·∫øm", type: 'weapon', baseAtk: 20 },
    { id: 'w2', name: "B√≠ch Huy·∫øt Ki·∫øm", type: 'weapon', baseAtk: 150 },
    { id: 'w3', name: "·ª∂ Thi√™n Ki·∫øm", type: 'weapon', baseAtk: 500 },
    { id: 'w4', name: "ƒê·ªì Long ƒêao", type: 'weapon', baseAtk: 550 },
    { id: 'a1', name: "B·ªë Y", type: 'armor', baseDef: 10 },
    { id: 'a2', name: "Huy·ªÅn V≈© Gi√°p", type: 'armor', baseDef: 120 },
    { id: 'a3', name: "Minh Ph∆∞·ª£ng Kim Y", type: 'armor', baseDef: 400 }
];

// 2. BI·∫æN TR·∫†NG TH√ÅI B·ªî SUNG
state.inventory = [];
state.equipped = { weapon: null, armor: null };
state.activeBoss = null;

// 3. H·ªÜ TH·ªêNG R∆†I ƒê·ªí (ADVANCED LOOT SYSTEM)
const dropLoot = (x, y, isBoss = false) => {
    const dropCount = isBoss ? 8 : 1;
    
    for (let i = 0; i < dropCount; i++) {
        const rand = Math.random();
        let rarity = ITEM_RARITY.COMMON;
        if (rand < 0.05) rarity = ITEM_RARITY.LEGEND;
        else if (rand < 0.15) rarity = ITEM_RARITY.EPIC;
        else if (rand < 0.4) rarity = ITEM_RARITY.RARE;

        const baseItem = EQUIPMENT_DB[Math.floor(Math.random() * EQUIPMENT_DB.length)];
        const newItem = {
            ...baseItem,
            uuid: 'item_' + Date.now() + Math.random(),
            rarity: rarity,
            atk: baseItem.baseAtk ? Math.floor(baseItem.baseAtk * rarity.power) : 0,
            def: baseItem.baseDef ? Math.floor(baseItem.baseDef * rarity.power) : 0,
            level: 0
        };

        createLootVFX(x + (Math.random() - 0.5) * 100, y + (Math.random() - 0.5) * 100, newItem);
    }
};

const createLootVFX = (x, y, item) => {
    const lootEl = document.createElement('div');
    lootEl.className = 'loot-item-vfx';
    lootEl.style.cssText = `
        position: absolute; left: ${x}px; top: ${y}px;
        width: 40px; height: 40px; background: rgba(0,0,0,0.6);
        border: 2px solid ${item.rarity.color}; border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; z-index: 100; animation: lootFloat 2s infinite ease-in-out;
        box-shadow: 0 0 15px ${item.rarity.color};
    `;
    lootEl.innerHTML = `<span style="font-size: 20px;">${item.type === 'weapon' ? '‚öîÔ∏è' : 'üõ°Ô∏è'}</span>`;
    
    lootEl.onclick = () => {
        if (state.inventory.length >= 20) {
            showToast("H√†nh trang ƒë√£ ƒë·∫ßy!", "#e74c3c");
            return;
        }
        state.inventory.push(item);
        showToast(`Nh·∫∑t ƒë∆∞·ª£c ${item.name} (${item.rarity.name})`, item.rarity.color);
        lootEl.remove();
        renderInventory();
    };

    document.getElementById('loot-drop-pool').appendChild(lootEl);
    setTimeout(() => { if(lootEl) lootEl.style.opacity = '0.5'; }, 10000);
    setTimeout(() => { if(lootEl) lootEl.remove(); }, 20000);
};

// 4. H·ªÜ TH·ªêNG BOSS TH·∫æ GI·ªöI (WORLD BOSS AI)
const spawnWorldBoss = () => {
    if (state.activeBoss) return;

    const boss = {
        id: 'boss_fire_demon',
        name: 'H·ªéA DI·ªÜM MA QU√ÇN',
        x: state.player.x + 500,
        y: state.player.y,
        hp: 10000, maxHp: 10000,
        atk: 250, phase: 1,
        lastSkill: 0,
        el: null
    };

    const div = document.createElement('div');
    div.className = 'entity boss-entity';
    div.innerHTML = `
        <div class="boss-aura"></div>
        <div class="overhead-hud" style="transform: scale(0.5) translateY(-200px);">
            <div class="name-tag" style="font-size: 40px; color: #ff4757;">üî• ${boss.name} üî•</div>
            <div class="hp-bar-boss"><div id="boss-hp-fill" class="fill" style="width:100%; background: linear-gradient(90deg, #ff4e50, #f9d423);"></div></div>
        </div>
        <div class="stick-rig boss-rig">
            <div class="rig-head" style="width: 50px; height: 50px; background: #000; border-color: #ff4757;"></div>
            <div class="rig-torso" style="height: 80px; width: 6px;"></div>
        </div>
    `;
    document.getElementById('boss-spawn-pool').appendChild(div);
    boss.el = div;
    state.activeBoss = boss;
    
    showToast("‚ö†Ô∏è C·∫¢NH B√ÅO: H·ªéA DI·ªÜM MA QU√ÇN ƒê√É XU·∫§T HI·ªÜN! ‚ö†Ô∏è", "#ff4757");
};

const updateBossAI = () => {
    if (!state.activeBoss) return;
    const b = state.activeBoss;
    const dist = Math.hypot(state.player.x - b.x, state.player.y - b.y);

    // AI Di chuy·ªÉn
    if (dist > 150) {
        b.x += (state.player.x - b.x) / 100;
        b.y += (state.player.y - b.y) / 100;
    }

    // AI K·ªπ nƒÉng (AOE Skill)
    const now = Date.now();
    if (now - b.lastSkill > 4000) {
        if (dist < 500) {
            performBossSkill(b);
            b.lastSkill = now;
        }
    }

    // X·ª≠ l√Ω Boss ch·∫øt
    if (b.hp <= 0) {
        dropLoot(b.x, b.y, true);
        showToast("CH√öC M·ª™NG! ƒê√É TI√äU DI·ªÜT BOSS HO√ÄNG KIM!", "#f1c40f");
        b.el.remove();
        state.activeBoss = null;
    }

    b.el.style.transform = `translate(${b.x}px, ${b.y}px)`;
};

const performBossSkill = (boss) => {
    const skillEl = document.createElement('div');
    skillEl.className = 'boss-aoe-vfx';
    skillEl.style.cssText = `
        position: absolute; left: ${boss.x - 250}px; top: ${boss.y - 250}px;
        width: 500px; height: 500px; border-radius: 50%;
        background: radial-gradient(circle, rgba(231,76,60,0.6) 0%, transparent 70%);
        border: 2px solid #e74c3c; animation: bossAoeExpand 1s forwards;
        z-index: 50;
    `;
    document.getElementById('skill-vfx-surface').appendChild(skillEl);

    // AI C√† kh·ªãa khi tung chi√™u
    handleAIChat(boss, AI_QUOTES.BOSS_LAUGH);

    setTimeout(() => {
        const d = Math.hypot(state.player.x - boss.x, state.player.y - boss.y);
        if (d < 250) {
            damagePlayer(150);
            showToast("B·∫†N TR√öNG CHI√äU H·ªéA DI·ªÜM PHI√äU MI·ªÑU!", "#e74c3c");
        }
        skillEl.remove();
    }, 1000);
};

// 5. GIAO DI·ªÜN H√ÄNH TRANG & C∆Ø·ªúNG H√ìA (INVENTORY & FORGE)
const renderInventory = () => {
    const target = document.getElementById('modal-render-area');
    if (!target) return;

    let html = `
        <div class="inventory-container" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 20px;">
    `;
    
    state.inventory.forEach(item => {
        html += `
            <div class="inv-slot" onclick="equipItem('${item.uuid}')" style="border: 2px solid ${item.rarity.color}; background: #111; padding: 10px; position: relative; cursor: pointer;">
                <div style="font-size: 24px; text-align: center;">${item.type === 'weapon' ? '‚öîÔ∏è' : 'üõ°Ô∏è'}</div>
                <div style="font-size: 10px; color: ${item.rarity.color}; text-align: center;">${item.name}</div>
                ${item.level > 0 ? `<div style="position: absolute; top: 0; right: 2px; color: #f1c40f;">+${item.level}</div>` : ''}
            </div>
        `;
    });

    html += `</div>
        <div class="stats-overview" style="padding: 20px; border-top: 1px solid #444; color: #fff;">
            <h3>CH·ªà S·ªê NH√ÇN V·∫¨T</h3>
            <p>V≈© kh√≠: ${state.equipped.weapon ? `<span style="color:${state.equipped.weapon.rarity.color}">${state.equipped.weapon.name} (+${state.equipped.weapon.atk} ATK)</span>` : 'Ch∆∞a m·∫∑c'}</p>
            <p>Gi√°p tr·ª•: ${state.equipped.armor ? `<span style="color:${state.equipped.armor.rarity.color}">${state.equipped.armor.name} (+${state.equipped.armor.def} DEF)</span>` : 'Ch∆∞a m·∫∑c'}</p>
        </div>
    `;
    target.innerHTML = html;
};

const equipItem = (uuid) => {
    const item = state.inventory.find(i => i.uuid === uuid);
    if (!item) return;

    if (item.type === 'weapon') state.equipped.weapon = item;
    if (item.type === 'armor') state.equipped.armor = armor;

    // C·∫≠p nh·∫≠t s·ª©c m·∫°nh ng∆∞·ªùi ch∆°i
    calculateTotalStats();
    showToast(`Trang b·ªã th√†nh c√¥ng: ${item.name}`, item.rarity.color);
    renderInventory();
};

const calculateTotalStats = () => {
    let bonusAtk = state.equipped.weapon ? state.equipped.weapon.atk : 0;
    let bonusDef = state.equipped.armor ? state.equipped.armor.def : 0;
    
    // Gi·∫£ s·ª≠ base stats l·∫•y t·ª´ m√¥n ph√°i ·ªü Ph·∫ßn 3
    const sect = SECTS[state.player.sect] || { atk: 100, def: 50 };
    state.player.atk = sect.atk + bonusAtk;
    state.player.def = (sect.def || 50) + bonusDef;
    updateUI();
};

// 6. G·∫ÆN V√ÄO CORE ENGINE (INJECTION)
const originalUpdate = update;
update = () => {
    originalUpdate();
    updateBossAI();
};

// T·ª± ƒë·ªông h·ªìi Boss sau m·ªói 60 gi√¢y n·∫øu ƒë√£ ch·∫øt
setInterval(() => {
    if (!state.activeBoss) spawnWorldBoss();
}, 60000);

// Global UI Hook
window.uiControl = {
    openModal: (type) => {
        document.getElementById('global-modal-overlay').classList.remove('modal-hidden');
        if (type === 'inventory') renderInventory();
    },
    closeModal: () => {
        document.getElementById('global-modal-overlay').classList.add('modal-hidden');
    }
};
        
    </script>

    <script id="game-logic-part-5">
// 1. C·∫§U H√åNH CHI·∫æN TR∆Ø·ªúNG (WAR CONFIGURATION)
const WAR_DATA = {
    SIDE_TONG: { name: "ƒê·∫°i T·ªëng", color: "#3498db", spawnX: 999000, spawnY: 999000 },
    SIDE_KIM: { name: "ƒê·∫°i Kim", color: "#e74c3c", spawnX: 1001000, spawnY: 1001000 },
    TITLES: ["Binh Nh√¨", "Hi·ªáu √öy", "Th·ªëng Lƒ©nh", "ƒê·∫°i T∆∞·ªõng Qu√¢n", "V√µ L√¢m Ch√≠ T√¥n"],
    COMBO_MSGS: ["NH·∫§T K√çCH!", "SONG S√ÅT!", "TAM S√ÅT!", "LI√äN TR·∫¢M!", "CU·ªíNG S√ÅT!", "TH·∫¶N S√ÅT!"]
};

// 2. TR·∫†NG TH√ÅI PK & CHI·∫æN TR∆Ø·ªúNG
state.war = {
    isActive: false,
    playerSide: null,
    scoreTong: 0,
    scoreKim: 0,
    killCount: 0,
    combo: 0,
    lastKillTime: 0,
    pkMode: 'peace' // 'peace', 'war', 'murder' (ƒë·ªì s√°t)
};

// 3. H·ªÜ TH·ªêNG PK CH·ªÆ ƒê·ªé (MURDER SYSTEM)
const togglePKMode = () => {
    const modes = ['peace', 'war', 'murder'];
    const currentIndex = modes.indexOf(state.war.pkMode);
    state.war.pkMode = modes[(currentIndex + 1) % modes.length];
    
    const nameEl = document.getElementById('hero-display-name');
    if (state.war.pkMode === 'murder') {
        nameEl.style.color = '#ff0000';
        showToast("‚öîÔ∏è ƒê√É B·∫¨T CH·∫æ ƒê·ªò ƒê·ªí S√ÅT! C·∫®N TH·∫¨N C·ª¨A QUAN!", "#ff0000");
        createVFX(state.player.x, state.player.y, 'murder-aura');
    } else if (state.war.pkMode === 'war') {
        nameEl.style.color = '#f1c40f';
        showToast("üõ°Ô∏è ƒê√É B·∫¨T CH·∫æ ƒê·ªò CHI·∫æN ƒê·∫§U PHE!", "#f1c40f");
    } else {
        nameEl.style.color = '#ffffff';
        showToast("üïäÔ∏è ƒê√É TR·ªû V·ªÄ CH·∫æ ƒê·ªò H√íA B√åNH.", "#2ecc71");
    }
};

// 4. K√çCH HO·∫†T CHI·∫æN TR∆Ø·ªúNG T·ªêNG KIM (START WAR)
const startTongKimWar = (chosenSide) => {
    state.war.isActive = true;
    state.war.playerSide = chosenSide;
    state.war.scoreTong = 0;
    state.war.scoreKim = 0;
    state.war.killCount = 0;
    
    // UI Chi·∫øn Tr∆∞·ªùng
    const warHud = document.createElement('div');
    warHud.id = 'war-hud-overlay';
    warHud.style.cssText = `
        position: fixed; top: 120px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.8); border: 2px solid #f1c40f;
        padding: 10px 40px; border-radius: 0 0 20px 20px;
        color: #fff; font-weight: bold; display: flex; gap: 40px; z-index: 1000;
    `;
    warHud.innerHTML = `
        <div style="color:${WAR_DATA.SIDE_TONG.color}">T·ªêNG: <span id="w-tong">0</span></div>
        <div id="w-timer" style="color:#f1c40f">10:00</div>
        <div style="color:${WAR_DATA.SIDE_KIM.color}">KIM: <span id="w-kim">0</span></div>
    `;
    document.body.appendChild(warHud);

    // Sinh ra qu√¢n l√≠nh 2 b√™n
    spawnWarLegions();
    showToast(`üî• CHI·∫æN TR∆Ø·ªúNG KHAI M·ªû! B·∫†N THU·ªòC PHE ${chosenSide === 'tong' ? 'T·ªêNG' : 'KIM'}!`, "#fff");
};

const spawnWarLegions = () => {
    for(let i=0; i<30; i++) {
        spawnWarNPC('tong', 999000 + (Math.random()*1000), 999000 + (Math.random()*1000));
        spawnWarNPC('kim', 1001000 - (Math.random()*1000), 1001000 - (Math.random()*1000));
    }
};

const spawnWarNPC = (side, x, y) => {
    const config = side === 'tong' ? WAR_DATA.SIDE_TONG : WAR_DATA.SIDE_KIM;
    const npc = {
        id: 'war_' + Math.random(),
        side: side,
        x: x, y: y,
        hp: 500, maxHp: 500,
        atk: 40,
        lastChat: 0,
        el: null
    };

    const div = document.createElement('div');
    div.className = `entity mob-base war-unit side-${side}`;
    div.innerHTML = `
        <div class="overhead-hud">
            <div class="name-tag" style="color:${config.color}">[${config.name}] Binh Sƒ©</div>
            <div class="hp-mini-box"><div class="fill" style="background:${config.color}; width:100%"></div></div>
        </div>
        <div class="stick-rig">
            <div class="rig-head" style="border-color:${config.color}"></div>
            <div class="rig-torso" style="background:${config.color}"></div>
        </div>
    `;
    document.getElementById('mobs-container').appendChild(div);
    npc.el = div;
    state.mobs.push(npc);
};

// 5. H·ªÜ TH·ªêNG KILLSTREAK & ANNOUNCER (COMBO AI)
const processKill = (victim) => {
    if (!state.war.isActive) return;

    const now = Date.now();
    if (now - state.war.lastKillTime < 5000) {
        state.war.combo++;
    } else {
        state.war.combo = 1;
    }
    state.war.lastKillTime = now;
    state.war.killCount++;

    // ƒêi·ªÉm th∆∞·ªüng cho phe
    if (state.war.playerSide === 'tong' && victim.side === 'kim') state.war.scoreTong += 10;
    if (state.war.playerSide === 'kim' && victim.side === 'tong') state.war.scoreKim += 10;
    
    updateWarUI();
    announceKillstreak(state.war.combo);
};

const announceKillstreak = (count) => {
    const msgIndex = Math.min(count - 1, WAR_DATA.COMBO_MSGS.length - 1);
    const msg = WAR_DATA.COMBO_MSGS[msgIndex];
    
    const announceEl = document.createElement('div');
    announceEl.className = 'killstreak-popup';
    announceEl.style.cssText = `
        position: fixed; top: 25%; left: 50%; transform: translate(-50%, -50%);
        font-size: 60px; font-weight: 900; color: #f1c40f; text-shadow: 0 0 20px #ff0000;
        z-index: 10000; animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        pointer-events: none;
    `;
    announceEl.innerText = msg;
    document.body.appendChild(announceEl);

    // AI Voice-over (Gi·∫£ l·∫≠p)
    if (count >= 5) {
        showToast(`üí• KH√îNG TH·ªÇ C·∫¢N PH√Å! ƒê·∫†I HI·ªÜP ƒêANG ${msg}!`, "#ff4757");
    }

    setTimeout(() => {
        announceEl.style.opacity = '0';
        announceEl.style.transform = 'translate(-50%, -100%)';
        setTimeout(() => announceEl.remove(), 500);
    }, 1500);
};

const updateWarUI = () => {
    if (document.getElementById('w-tong')) {
        document.getElementById('w-tong').innerText = state.war.scoreTong;
        document.getElementById('w-kim').innerText = state.war.scoreKim;
    }
};

// 6. TUY·ªÜT K·ª∏ N·ªò (ULTIMATE SKILLS REAL LOGIC)
const castUltimate = () => {
    if (state.player.mp < 200) {
        showToast("‚ö†Ô∏è N·ªòI L·ª∞C KH√îNG ƒê·ª¶ ƒê·ªÇ XU·∫§T CHI√äU!", "#3498db");
        return;
    }

    state.player.mp -= 200;
    updateUI();

    const ultVFX = document.createElement('div');
    ultVFX.className = 'vfx-ultimate-screen';
    ultVFX.style.cssText = `
        position: fixed; inset: 0; background: rgba(255,255,255,0.3);
        z-index: 9999; animation: flash 0.5s forwards;
    `;
    document.body.appendChild(ultVFX);

    // S√°t th∆∞∆°ng di·ªán r·ªông (AOE)
    state.mobs.forEach(m => {
        const d = Math.hypot(state.player.x - m.x, state.player.y - m.y);
        if (d < 600) {
            const damage = state.player.atk * 5;
            m.hp -= damage;
            showDamage(m.x, m.y, damage, true);
            
            // Hi·ªáu ·ª©ng ƒë·∫©y l√πi
            m.x += (m.x - state.player.x) / d * 150;
            m.y += (m.y - state.player.y) / d * 150;

            if (m.hp <= 0 && m.side) processKill(m);
        }
    });

    setTimeout(() => ultVFX.remove(), 500);
};

// 7. GIAO DI·ªÜN X·∫æP H·∫†NG (RANKING SYSTEM)
const renderRanking = () => {
    const target = document.getElementById('modal-render-area');
    target.innerHTML = `
        <div style="padding: 20px; color: #fff;">
            <h2 style="color:#f1c40f; text-align:center;">B·∫¢NG X·∫æP H·∫†NG CAO TH·ª¶</h2>
            <table style="width:100%; border-collapse: collapse; margin-top:20px;">
                <tr style="border-bottom: 2px solid #444;">
                    <th>H·∫°ng</th><th>Danh Hi·ªáu</th><th>T√™n</th><th>Chi·∫øn C√¥ng</th>
                </tr>
                <tr style="color:#f1c40f;">
                    <td>1</td><td>${WAR_DATA.TITLES[4]}</td><td>ƒê·∫°i Hi·ªáp (B·∫°n)</td><td>${state.war.killCount}</td>
                </tr>
                <tr><td>2</td><td>${WAR_DATA.TITLES[3]}</td><td>ƒê·ªôc C√¥ C·∫ßu B·∫°i</td><td>999</td></tr>
                <tr><td>3</td><td>${WAR_DATA.TITLES[3]}</td><td>L·ªánh H·ªì Xung</td><td>850</td></tr>
            </table>
        </div>
    `;
};

// 8. K·∫æT N·ªêI V·ªöI UI (HOOKS)
document.getElementById('btn-s4-ult').onclick = castUltimate;
document.getElementById('btn-fly').onclick = togglePKMode;
document.getElementById('btn-s1').onclick = () => {
    if (!state.war.isActive) startTongKimWar('tong');
    else showToast("TR·∫¨N ƒê·∫§U ƒêANG DI·ªÑN RA!", "#f1c40f");
};

// CSS B·ªî SUNG CHO PH·∫¶N 5
const p5Style = document.createElement('style');
p5Style.innerHTML = `
    @keyframes bounceIn {
        0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
        50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    .side-tong { filter: drop-shadow(0 0 5px #3498db); }
    .side-kim { filter: drop-shadow(0 0 5px #e74c3c); }
    .vfx-ultimate-screen { pointer-events: none; }
`;
document.head.appendChild(p5Style);
        
    </script>

</body>
                        </html>
                        
