<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>THI√äN GI·ªöI V√î T·∫¨N: V·∫†N PH√ÅI TRANH H√ôNG</title>
    <style>
        :root {
            --cyan: #00ffff; --gold: #f1c40f; --red: #ff4757; 
            --purple: #a29bfe; --bg: #050505; --ui-bg: rgba(0, 0, 0, 0.85);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; padding: 0; background: #000; overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; user-select: none; 
        }

        #game-wrapper { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        canvas { display: block; background: #000; }

        .hud { position: absolute; inset: 0; pointer-events: none; }
        .hud * { pointer-events: auto; }

        /* Th√¥ng tin nh√¢n v·∫≠t */
        .player-header {
            position: absolute; top: 10px; left: 10px;
            display: flex; gap: 10px; background: var(--ui-bg);
            padding: 8px; border-radius: 40px 10px 10px 40px; border: 1px solid #444;
        }
        .avatar { width: 50px; height: 50px; background: #222; border: 2px solid var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .stats { display: flex; flex-direction: column; justify-content: center; }
        .hp-bar-bg { width: 150px; height: 8px; background: #222; border-radius: 4px; margin: 3px 0; overflow: hidden; }
        .hp-bar-fill { height: 100%; background: var(--red); width: 100%; transition: 0.3s; }

        /* Mini Map */
        .map-container {
            position: absolute; top: 10px; right: 10px;
            width: 140px; height: 140px; background: #000;
            border: 2px solid #555; border-radius: 8px; overflow: hidden;
        }
        #radar { width: 100%; height: 100%; }
        .map-btns { position: absolute; bottom: 2px; right: 2px; display: flex; gap: 2px; }
        .map-btn { width: 22px; height: 22px; background: #333; color: #fff; border: none; font-size: 14px; border-radius: 3px; }

        /* Joysticks */
        #touch-move-area {
            position: absolute; bottom: 30px; left: 30px;
            width: 140px; height: 140px; background: rgba(255,255,255,0.05);
            border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);
        }
        #joystick-stick {
            position: absolute; top: 50%; left: 50%;
            width: 50px; height: 50px; margin: -25px;
            background: rgba(255,255,255,0.2); border-radius: 50%;
        }

        /* H·ªá th·ªëng k·ªπ nƒÉng m·ªü r·ªông (14 ph√≠m) */
        .skill-container { 
            position: absolute; bottom: 10px; right: 10px; 
            width: 380px; height: 380px; pointer-events: none;
        }
        .btn-main-atk {
            position: absolute; bottom: 30px; right: 30px;
            width: 85px; height: 85px; background: var(--cyan);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 35px; box-shadow: 0 0 15px var(--cyan); border: 3px solid #fff; pointer-events: auto;
        }
        .skill-btn {
            position: absolute; width: 42px; height: 42px;
            background: var(--ui-bg); border: 1px solid #666; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; filter: grayscale(1); transition: 0.2s; pointer-events: auto;
        }
        .skill-btn.unlocked { filter: grayscale(0); border-color: var(--gold); }
        .skill-btn .cd-overlay { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); height: 0%; border-radius: 50%; }

        /* T·ªça ƒë·ªô 14 k·ªπ nƒÉng x·∫øp t·∫ßng v√≤ng cung */
        #sk-0 { bottom: 130px; right: 15px; }
        #sk-1 { bottom: 120px; right: 70px; }
        #sk-2 { bottom: 90px; right: 120px; }
        #sk-3 { bottom: 40px; right: 140px; }
        #sk-4 { bottom: -10px; right: 130px; }
        #sk-5 { bottom: 180px; right: 15px; }
        #sk-6 { bottom: 170px; right: 65px; }
        #sk-7 { bottom: 145px; right: 110px; }
        #sk-8 { bottom: 105px; right: 165px; }
        #sk-9 { bottom: 55px; right: 195px; }
        #sk-10 { bottom: 5px; right: 190px; }
        #sk-11 { bottom: 230px; right: 30px; }
        #sk-12 { bottom: 215px; right: 90px; }
        #sk-13 { bottom: 185px; right: 145px; }

        /* Shop UI */
        #shop-ui {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 350px; height: 450px; background: var(--ui-bg); border: 2px solid var(--gold);
            padding: 20px; border-radius: 12px; display: none; z-index: 1000; overflow-y: auto;
        }
        .shop-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; }
        .buy-btn { background: var(--gold); border: none; padding: 5px 10px; font-weight: bold; border-radius: 4px; color: #000; }

        #chat-box {
            position: absolute; bottom: 10px; left: 190px; width: 220px; height: 80px;
            background: rgba(0,0,0,0.3); font-size: 10px; padding: 5px; overflow-y: auto;
            pointer-events: none; border-radius: 5px; color: #ccc;
        }

        #exit-sect-btn {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 10px 25px; background: var(--red); color: white; border: none;
            border-radius: 20px; font-weight: bold; display: none; z-index: 100;
        }

        #start-screen {
            position: fixed; inset: 0; background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .sect-btn {
            padding: 12px 30px; margin: 5px; background: #111; border: 1px solid #444;
            color: white; border-radius: 8px; width: 220px; text-align: center;
        }
        .sect-btn.active { border-color: var(--cyan); background: rgba(0,255,255,0.1); }
    </style>
</head>
<body>
<div id="game-wrapper">
    <div id="start-screen">
        <h1 style="color:var(--cyan);">THI√äN GI·ªöI V√î T·∫¨N</h1>
        <p style="font-size: 11px; color: #888;">H·ªÜ TH·ªêNG 14 TUY·ªÜT K·ª∏ - T√îNG M√îN N·ªòI VI</p>
        <div id="sect-picker"></div>
        <button onclick="startGame()" style="margin-top:20px; padding:15px 60px; background:var(--cyan); border:none; font-weight:bold; border-radius:30px;">XU·∫§T TH·∫æ</button>
    </div>

    <div id="shop-ui">
        <h3 id="shop-title" style="text-align:center; color:var(--gold);">TR∆Ø·ªûNG M√îN TRUY·ªÄN D·∫†Y</h3>
        <div id="shop-items"></div>
        <button onclick="closeShop()" style="width:100%; margin-top:15px; padding:10px; background: #444; border:none; color:white;">LUI RA</button>
    </div>

    <button id="exit-sect-btn" onclick="exitSect()">R·ªúI KH·ªéI T√îNG M√îN</button>
    <canvas id="mainCanvas"></canvas>

    <div class="hud">
        <div class="player-header">
            <div class="avatar" id="p-avatar">üë§</div>
            <div class="stats">
                <div style="font-size:12px; font-weight:bold;"><span id="ui-sect">Ph√°i</span></div>
                <div class="hp-bar-bg"><div id="hp-bar" class="hp-bar-fill"></div></div>
                <div style="font-size:11px; color:var(--gold)">üí∞ Linh th·∫°ch: <span id="ui-gold">0</span></div>
            </div>
        </div>
        <div class="map-container">
            <canvas id="radar"></canvas>
            <div class="map-btns"><button class="map-btn" onclick="mapZoom(0.8)">-</button><button class="map-btn" onclick="mapZoom(1.2)">+</button></div>
            <div style="position:absolute; top:2px; left:5px; font-size:9px; color:#aaa;" id="ui-coords">0,0</div>
        </div>
        <div id="chat-box"></div>
        <div id="touch-move-area"><div id="joystick-stick"></div></div>
        <div class="skill-container">
            <div class="btn-main-atk" id="btn-atk">‚öîÔ∏è</div>
            <div id="skills-sub-group"></div>
        </div>
    </div>
</div>
<script>
    // C·∫•u h√¨nh 14 tuy·ªát k·ªπ cho m·ªói m√¥n ph√°i (Ph√¢n t·∫ßng t·ª´ c∆° b·∫£n ƒë·∫øn th∆∞·ª£ng c·ªï)
    const SECT_CONFIG = {
        "V√µ ƒêang": { 
            color: "#3498db", icon: "‚òØÔ∏è", 
            skills: [
                {n: "Th√°i C·ª±c Ki·∫øm", icon: "üó°Ô∏è", cost: 500, cd: 2, dmg: 80},
                {n: "B√°t Qu√°i Ch∆∞·ªüng", icon: "üëê", cost: 1500, cd: 4, dmg: 120},
                {n: "Thanh Phong B·ªô", icon: "üçÉ", cost: 5000, cd: 10, dmg: 0},
                {n: "Th·∫ßn M√¥n Ki·∫øm", icon: "‚öîÔ∏è", cost: 10000, cd: 5, dmg: 200},
                {n: "H·ªï Tr·∫£o Th·ªß", icon: "üêæ", cost: 25000, cd: 7, dmg: 350},
                {n: "V√¥ C·ª±c C√¥ng", icon: "üåÄ", cost: 50000, cd: 15, dmg: 500},
                {n: "Th√°i C·ª±c Tr·∫≠n", icon: "üéá", cost: 100000, cd: 30, dmg: 1200},
                {n: "Huy·ªÅn V≈© C√¥ng", icon: "üê¢", cost: 200000, cd: 40, dmg: 1500},
                {n: "Th√°i H∆∞ Ki·∫øm", icon: "‚ú®", cost: 400000, cd: 25, dmg: 2500},
                {n: "L∆∞·ª°ng Nghi ·∫§n", icon: "üåó", cost: 800000, cd: 20, dmg: 4000},
                {n: "Ch√¢n V≈© Ki·∫øm", icon: "üî±", cost: 1500000, cd: 50, dmg: 10000},
                {n: "ƒê·∫°o Ph√°p T·ª± Nhi√™n", icon: "üìú", cost: 3000000, cd: 60, dmg: 25000},
                {n: "V√¥ Th∆∞·ª£ng Th√°i C·ª±c", icon: "üåå", cost: 7000000, cd: 80, dmg: 60000},
                {n: "Nh√¢n Ki·∫øm H·ª£p Nh·∫•t", icon: "‚õ©Ô∏è", cost: 15000000, cd: 120, dmg: 200000}
            ]
        },
        "Thi·∫øu L√¢m": { 
            color: "#f1c40f", icon: "üìø", 
            skills: [
                {n: "La H√°n Quy·ªÅn", icon: "‚úä", cost: 500, cd: 2, dmg: 90},
                {n: "ƒê·∫£ C·∫©u B·ªïng", icon: "ü¶Ø", cost: 1500, cd: 3, dmg: 130},
                {n: "Vi ƒê√† Ch∆∞·ªüng", icon: "‚úã", cost: 5000, cd: 5, dmg: 250},
                {n: "S∆∞ T·ª≠ H·ªëng", icon: "ü¶Å", cost: 10000, cd: 12, dmg: 500},
                {n: "Kim Cang Ph·ª•c Ma", icon: "‚õìÔ∏è", cost: 25000, cd: 10, dmg: 700},
                {n: "Long Tr·∫£o Th·ªß", icon: "üêâ", cost: 50000, cd: 8, dmg: 900},
                {n: "B√°t Nh√£ Ch∆∞·ªüng", icon: "üßø", cost: 100000, cd: 15, dmg: 2000},
                {n: "D·ªãch C√¢n Kinh", icon: "üß¨", cost: 200000, cd: 60, dmg: 0},
                {n: "ƒê·∫°i Bi Ch√∫", icon: "üïç", cost: 400000, cd: 45, dmg: 3500},
                {n: "Thi√™n Th·ªß Quan √Çm", icon: "üôå", cost: 800000, cd: 35, dmg: 6000},
                {n: "B·ªì ƒê·ªÅ C√¥ng", icon: "üå≥", cost: 1500000, cd: 55, dmg: 12000},
                {n: "Kim Cang B·∫•t Ho·∫°i", icon: "üõ°Ô∏è", cost: 3000000, cd: 100, dmg: 0},
                {n: "Nh∆∞ Lai Th·∫ßn Ch∆∞·ªüng", icon: "üñêÔ∏è", cost: 7000000, cd: 90, dmg: 75000},
                {n: "V·∫°n Ph·∫≠t Tri·ªÅu T√¥ng", icon: "‚ò∏Ô∏è", cost: 15000000, cd: 150, dmg: 250000}
            ]
        },
        "ƒê∆∞·ªùng M√¥n": { 
            color: "#2ecc71", icon: "üèπ", 
            skills: [
                {n: "Xuy√™n T√¢m Ti·ªÖn", icon: "üìç", cost: 500, cd: 1.5, dmg: 70},
                {n: "ƒê·ªôc Th√≠ch", icon: "üß™", cost: 1500, cd: 3, dmg: 150},
                {n: "ƒêo·∫°t M·ªánh Ti√™u", icon: "ü™Å", cost: 5000, cd: 4, dmg: 300},
                {n: "M√™ ·∫¢nh B·ªô", icon: "üë£", cost: 10000, cd: 12, dmg: 0},
                {n: "T√°n Hoa Ti√™u", icon: "üå∏", cost: 25000, cd: 6, dmg: 800},
                {n: "Phi Tinh Th·∫ßn Th·ªß", icon: "üß§", cost: 50000, cd: 8, dmg: 1100},
                {n: "B·∫°o V≈© L√™ Hoa", icon: "üí•", cost: 100000, cd: 15, dmg: 3000},
                {n: "M√£n Thi√™n Hoa V≈©", icon: "üå¶Ô∏è", cost: 200000, cd: 20, dmg: 5000},
                {n: "ƒêo·∫°t Ph√°ch C√¢u", icon: "ü™ù", cost: 400000, cd: 18, dmg: 7000},
                {n: "V·∫°n ƒê·ªôc C√†n Kh√¥n", icon: "ü§Æ", cost: 800000, cd: 40, dmg: 12000},
                {n: "Di√™m V∆∞∆°ng Thi·∫øp", icon: "üíÄ", cost: 1500000, cd: 30, dmg: 20000},
                {n: "Qu·ª∑ ·∫¢nh M√™ Tung", icon: "üëª", cost: 3000000, cd: 50, dmg: 0},
                {n: "Ph·∫≠t N·ªô ƒê∆∞·ªùng Li√™n", icon: "üå∫", cost: 7000000, cd: 100, dmg: 90000},
                {n: "√Åm Kh√≠ T√¥ng S∆∞", icon: "üéØ", cost: 15000000, cd: 180, dmg: 300000}
            ]
        }
 "Minh Gi√°o": {
        color: "#e67e22", icon: "üî•",
        skills: [
            {n: "H·ªèa Long Ch∆∞·ªüng", icon: "üî•", cost: 500, cd: 2, dmg: 100},
            {n: "∆Øng Tr·∫£o C√¥ng", icon: "ü¶Ö", cost: 1500, cd: 4, dmg: 160},
            {n: "Th√°nh H·ªèa L·ªánh", icon: "üèÆ", cost: 5000, cd: 6, dmg: 350},
            {n: "Quang Minh Th·ªß", icon: "‚ú®", cost: 10000, cd: 8, dmg: 550},
            {n: "H√†n BƒÉng Mi√™n Ch∆∞·ªüng", icon: "‚ùÑÔ∏è", cost: 25000, cd: 10, dmg: 900},
            {n: "H·∫•p Tinh C√¥ng", icon: "üï≥Ô∏è", cost: 50000, cd: 15, dmg: 1200},
            {n: "C√†n Kh√¥n ƒê·∫°i Na Di", icon: "üåÄ", cost: 100000, cd: 20, dmg: 4000},
            {n: "C·ª≠u D∆∞∆°ng Th·∫ßn C√¥ng", icon: "‚òÄÔ∏è", cost: 200000, cd: 50, dmg: 6000},
            {n: "L·ª≠a Thi√™ng T·∫©y L·ªÖ", icon: "üåã", cost: 400000, cd: 30, dmg: 9000},
            {n: "Huy·∫øt S√°t Th·ªß", icon: "ü©∏", cost: 800000, cd: 40, dmg: 15000},
            {n: "Quang Minh ƒê·ªânh ·∫§n", icon: "üèîÔ∏è", cost: 1500000, cd: 60, dmg: 30000},
            {n: "√Çm D∆∞∆°ng T·∫ø L·ªÖ", icon: "üåó", cost: 3000000, cd: 80, dmg: 70000},
            {n: "H·ªèa Ph·∫ßn Thi√™n H·∫°", icon: "‚òÑÔ∏è", cost: 7000000, cd: 110, dmg: 120000},
            {n: "Th√°nh H·ªèa Vi√™m Th·∫ßn", icon: "üî±", cost: 15000000, cd: 180, dmg: 350000}
        ]
    },
    "C√°i Bang": {
        color: "#8e44ad", icon: "üçñ",
        skills: [
            {n: "ƒê·∫£ C·∫©u B·ªïng Ph√°p", icon: "ü•¢", cost: 500, cd: 2, dmg: 85},
            {n: "H√†ng Long Th·∫≠p B√°t", icon: "üêâ", cost: 1500, cd: 5, dmg: 200},
            {n: "Ti√™u Dao Du", icon: "üïäÔ∏è", cost: 5000, cd: 12, dmg: 0},
            {n: "Th·∫ßn Long B√°i Vƒ©", icon: "üêï", cost: 10000, cd: 6, dmg: 450},
            {n: "Phi Long T·∫°i Thi√™n", icon: "‚òÅÔ∏è", cost: 25000, cd: 10, dmg: 850},
            {n: "Khang Long H·ªØu H·ªëi", icon: "üí•", cost: 50000, cd: 15, dmg: 1500},
            {n: "Kh·ªën Long Tr·∫≠n", icon: "üï∏Ô∏è", cost: 100000, cd: 25, dmg: 2500},
            {n: "T√∫y Quy·ªÅn", icon: "üç∂", cost: 200000, cd: 8, dmg: 3500},
            {n: "Long Chi·∫øn Vu D√£", icon: "‚öîÔ∏è", cost: 400000, cd: 45, dmg: 8000},
            {n: "Song Long Th·ªß", icon: "üëê", cost: 800000, cd: 30, dmg: 15000},
            {n: "Thi√™n H·∫° V√¥ C·∫©u", icon: "üßπ", cost: 1500000, cd: 50, dmg: 35000},
            {n: "H·ªón Nguy√™n C√¥ng", icon: "üå™Ô∏è", cost: 3000000, cd: 70, dmg: 60000},
            {n: "V·∫°n Long Tri·ªÅu B√°i", icon: "üéá", cost: 7000000, cd: 120, dmg: 150000},
            {n: "Ch√¢n Long Gi√°ng Th·∫ø", icon: "üê≤", cost: 15000000, cd: 200, dmg: 400000}
        ]
    },
    "Nga Mi": {
        color: "#fd79a8", icon: "üå∏",
        skills: [
            {n: "Nga Mi Ki·∫øm", icon: "üó°Ô∏è", cost: 500, cd: 2, dmg: 75},
            {n: "Hoa Khai Ki·∫øn Ph·∫≠t", icon: "üèµÔ∏è", cost: 1500, cd: 4, dmg: 140},
            {n: "Th·∫ßn Ph·ª• B·ªô", icon: "üëó", cost: 5000, cd: 12, dmg: 0},
            {n: "C·ª≠u √Çm B·∫°ch C·ªët", icon: "üíÄ", cost: 10000, cd: 6, dmg: 500},
            {n: "Di·ªát Tuy·ªát Ki·∫øm", icon: "üõë", cost: 25000, cd: 8, dmg: 1000},
            {n: "Ph·∫≠t Quang Ph·ªï Chi·∫øu", icon: "üîÖ", cost: 50000, cd: 20, dmg: 2000},
            {n: "Thanh T√¢m Ch√∫", icon: "üßº", cost: 100000, cd: 40, dmg: 0},
            {n: "V·∫°n Hoa Tr·∫≠n", icon: "üíê", cost: 200000, cd: 30, dmg: 4500},
            {n: "Ng·ªçc N·ªØ T√¢m Kinh", icon: "üìñ", cost: 400000, cd: 50, dmg: 9000},
            {n: "Chu Ch·ªâ Nh∆∞·ª£c ·∫§n", icon: "üíÖ", cost: 800000, cd: 35, dmg: 18000},
            {n: "T·ª≠ Kh√≠ ƒê√¥ng Lai", icon: "üü£", cost: 1500000, cd: 55, dmg: 35000},
            {n: "Ph·∫≠t Ph√°p V√¥ Bi√™n", icon: "üïâÔ∏è", cost: 3000000, cd: 80, dmg: 80000},
            {n: "Th√°i √Çm C√¥ng", icon: "üåô", cost: 7000000, cd: 100, dmg: 150000},
            {n: "V·∫°n Ki·∫øp Lu√¢n H·ªìi", icon: "üåÄ", cost: 15000000, cd: 150, dmg: 380000}
        ]
    },
    "Ti√™u Dao": {
        color: "#55efc4", icon: "üß™",
        skills: [
            {n: "B·∫Øc Minh Th·∫ßn C√¥ng", icon: "üåÄ", cost: 500, cd: 3, dmg: 100},
            {n: "LƒÉng Ba Vi B·ªô", icon: "üí®", cost: 1500, cd: 15, dmg: 0},
            {n: "Ti·ªÉu Th·ª´a C√¥ng", icon: "üìâ", cost: 5000, cd: 5, dmg: 300},
            {n: "Sinh T·ª≠ Ph√π", icon: "‚ùÑÔ∏è", cost: 10000, cd: 10, dmg: 600},
            {n: "Thi√™n S∆°n Chi·∫øt Mai", icon: "üñêÔ∏è", cost: 25000, cd: 8, dmg: 1200},
            {n: "L·ª•c D∆∞∆°ng Ch∆∞·ªüng", icon: "‚òÄÔ∏è", cost: 50000, cd: 12, dmg: 2500},
            {n: "Ti√™u Dao B·ªô", icon: "üé†", cost: 100000, cd: 10, dmg: 0},
            {n: "B·∫°ch H·ªìng Qu√°n Nh·∫≠t", icon: "üåà", cost: 200000, cd: 20, dmg: 5500},
            {n: "B·∫•t L√£o Tr∆∞·ªùng Xu√¢n", icon: "üß™", cost: 400000, cd: 60, dmg: 0},
            {n: "Ph∆∞·ª£ng Ho√†ng Tri·ªÅu", icon: "ü¶ö", cost: 800000, cd: 40, dmg: 20000},
            {n: "ƒê·ªôc C√¥ C·ª≠u Ki·∫øm", icon: "‚öîÔ∏è", cost: 1500000, cd: 25, dmg: 40000},
            {n: "Ti√™n Phong ƒê·∫°o C·ªët", icon: "üéë", cost: 3000000, cd: 90, dmg: 90000},
            {n: "H√≥a C√¥ng ƒê·∫°i Ph√°p", icon: "‚ò†Ô∏è", cost: 7000000, cd: 110, dmg: 180000},
            {n: "Thi√™n Nh√¢n H·ª£p Nh·∫•t", icon: "üõ∏", cost: 15000000, cd: 200, dmg: 500000}
        ]
            }
                
    };

    let game = {
        state: 'WORLD', 
        p: {
            x: 0, y: 0, speed: 2.2, 
            hp: 1000, maxHp: 1000, gold: 0,
            sect: null, skills: [], lastS: Array(14).fill(0)
        },
        world: { chunks: new Set(), entities: [], zoom: 0.03 },
        input: { joyX: 0, joyY: 0 },
        lastWorldPos: { x: 0, y: 0 },
        dialogues: [
            "ƒê·∫°o h·ªØu c√≥ th·∫•y linh kh√≠ dao ƒë·ªông?", "T√¥ng m√¥n s·∫Øp c√≥ bi·∫øn l·ªõn...", 
            "Linh th·∫°ch n√†y th·∫≠t gi·∫£ kh√≥ ph√¢n.", "C√†y cu·ªëc bao gi·ªù m·ªõi ƒë·ªß 15 tri·ªáu v√†ng?", 
            "C·∫©n th·∫≠n qu√°i v·∫≠t ph√≠a tr∆∞·ªõc!"
        ]
    };

    // Ti·∫øp t·ª•c kh·ªüi t·∫°o Canvas
    let canvas = document.getElementById('mainCanvas');
    let ctx = canvas.getContext('2d');
    let rCanvas = document.getElementById('radar');
    let rCtx = rCanvas.getContext('2d');
        /** --- LOGIC KH·ªûI T·∫†O B·∫¢N ƒê·ªí --- **/
    function initPicker() {
        const root = document.getElementById('sect-picker');
        Object.keys(SECT_CONFIG).forEach(s => {
            const btn = document.createElement('div');
            btn.className = 'sect-btn';
            btn.innerText = s;
            btn.onclick = () => {
                game.p.sect = s;
                document.querySelectorAll('.sect-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            };
            root.appendChild(btn);
        });
        resize();
    }

    /** --- H·ªÜ TH·ªêNG AI & DI CHUY·ªÇN NPC --- **/
    function updateNPC(en) {
        let now = Date.now();
        // AI Chat t·ª± ƒë·ªông
        if(now - en.lastTalk > 8000) {
            en.msg = game.dialogues[Math.floor(Math.random()*game.dialogues.length)];
            en.lastTalk = now;
            setTimeout(() => en.msg = "", 4000);
        }

        // AI Chi·∫øn ƒë·∫•u & Di chuy·ªÉn
        if(en.isHostile) {
            let angle = Math.atan2(game.p.y - en.y, game.p.x - en.x);
            en.x += Math.cos(angle) * 2.8;
            en.y += Math.sin(angle) * 2.8;
            // G√¢y s√°t th∆∞∆°ng n·∫øu ch·∫°m ng∆∞·ªùi ch∆°i
            if(Math.sqrt((en.x - game.p.x)**2 + (en.y - game.p.y)**2) < 40 && now % 120 < 10) {
                game.p.hp -= 15;
                addLog(`<span style="color:red">NPC ${en.name} t·∫•n c√¥ng b·∫°n!</span>`);
            }
        } else {
            // NPC di chuy·ªÉn tu·∫ßn tra ng·∫´u nhi√™n
            if(now - en.lastMove > 5000) {
                en.vx = (Math.random() - 0.5) * 1.5;
                en.vy = (Math.random() - 0.5) * 1.5;
                en.lastMove = now;
            }
            en.x += en.vx;
            en.y += en.vy;
        }
    }

    /** --- CHUY·ªÇN C·∫¢NH T√îNG M√îN --- **/
    function enterSect(name) {
        if(game.p.sect !== name) return addLog("H·ªá th·ªëng: B·∫°n kh√¥ng thu·ªôc " + name + "!");
        game.lastWorldPos = { x: game.p.x, y: game.p.y };
        game.state = 'SECT';
        game.p.x = 500; game.p.y = 650; // V·ªã tr√≠ c·ª≠a v√†o t√¥ng m√¥n
        document.getElementById('exit-sect-btn').style.display = 'block';
        addLog(`C·ªïng kh√¥ng gian: ƒêang ti·∫øn v√†o l√£nh ƒë·ªãa ${name}...`);
    }

    function exitSect() {
        game.state = 'WORLD';
        game.p.x = game.lastWorldPos.x;
        game.p.y = game.lastWorldPos.y;
        document.getElementById('exit-sect-btn').style.display = 'none';
        addLog("C·ªïng kh√¥ng gian: ƒê√£ tr·ªü v·ªÅ th·∫ø gi·ªõi ngo√†i.");
    }
        /** --- V√íNG L·∫∂P RENDER CH√çNH --- **/
    function loop() {
        // X√≥a m√†n h√¨nh
        ctx.fillStyle = "#050505"; ctx.fillRect(0,0,canvas.width,canvas.height);
        let camX = canvas.width/2 - game.p.x, camY = canvas.height/2 - game.p.y;

        if(game.state === 'WORLD') {
            // C·∫≠p nh·∫≠t v·ªã tr√≠ Th·∫ø gi·ªõi ngo√†i
            game.p.x += game.input.joyX * game.p.speed;
            game.p.y += game.input.joyY * game.p.speed;
            
            updateWorld(); // Sinh qu√°i v√† NPC
            drawGrid(camX, camY);
            
            // V·∫Ω Th·ª±c th·ªÉ (Qu√°i, NPC, C·ªïng ph√°i)
            game.world.entities.forEach(en => {
                let dx = en.x + camX, dy = en.y + camY;
                if(dx < -100 || dx > canvas.width+100 || dy < -100 || dy > canvas.height+100) return;

                if(en.type === 'sect-portal') {
                    ctx.font = "45px Arial"; ctx.fillText("üè∞", dx-22, dy);
                    ctx.fillStyle = varColor('--gold'); ctx.font = "bold 12px Arial"; 
                    ctx.fillText(en.name, dx-20, dy+25);
                    // Va ch·∫°m c·ªïng d·ªãch chuy·ªÉn
                    if(Math.sqrt((en.x-game.p.x)**2+(en.y-game.p.y)**2) < 90) enterSect(en.name);
                } else if(en.type === 'npc') {
                    updateNPC(en);
                    ctx.font = "38px Arial"; ctx.fillText(en.isHostile ? "üò†" : "üë§", dx-18, dy);
                    if(en.msg) { 
                        ctx.fillStyle = "white"; ctx.fillRect(dx-45, dy-65, 90, 22);
                        ctx.fillStyle="black"; ctx.font="10px Arial"; ctx.fillText(en.msg, dx-40, dy-50); 
                    }
                } else {
                    ctx.fillStyle = en.color; ctx.beginPath(); ctx.arc(dx, dy, 13, 0, Math.PI*2); ctx.fill();
                    // Thanh m√°u qu√°i v·∫≠t
                    ctx.fillStyle = "#222"; ctx.fillRect(dx-15, dy-25, 30, 4);
                    ctx.fillStyle = "red"; ctx.fillRect(dx-15, dy-25, (en.hp/150)*30, 4);
                }
            });
        } else {
            // C·∫≠p nh·∫≠t v·ªã tr√≠ Trong T√¥ng M√¥n (T·ªëc ƒë·ªô nhanh h∆°n ch√∫t)
            game.p.x += game.input.joyX * 3.5;
            game.p.y += game.input.joyY * 3.5;
            drawSectRoom(camX, camY);
        }

        drawPlayer(canvas.width/2, canvas.height/2);
        updateUI();
        drawRadar();
        requestAnimationFrame(loop);
    }

    /** --- V·∫º N·ªòI VI T√îNG M√îN --- **/
    function drawSectRoom(cx, cy) {
        // Gi·ªõi h·∫°n ph√≤ng T√¥ng m√¥n
        ctx.fillStyle = "#1e1e1e"; ctx.fillRect(100+cx, 100+cy, 800, 800);
        ctx.strokeStyle = varColor('--gold'); ctx.lineWidth = 5; ctx.strokeRect(100+cx, 100+cy, 800, 800);
        
        // Ch·∫∑n t∆∞·ªùng
        game.p.x = Math.max(120, Math.min(880, game.p.x));
        game.p.y = Math.max(120, Math.min(880, game.p.y));

        const sectNPCs = [
            {n: "S∆∞ Ph·ª•", x: 350, y: 350, i: "üßô‚Äç‚ôÇÔ∏è", r: "QUEST"}, 
            {n: "Tr∆∞·ªüng M√¥n", x: 650, y: 350, i: "üßù‚Äç‚ôÇÔ∏è", r: "SKILL"}
        ];

        sectNPCs.forEach(n => {
            let dx = n.x+cx, dy = n.y+cy;
            ctx.font = "55px Arial"; ctx.fillText(n.i, dx-27, dy);
            ctx.fillStyle = "white"; ctx.font = "bold 15px Arial"; ctx.fillText(n.n, dx-25, dy+35);
            
            let dist = Math.sqrt((n.x-game.p.x)**2+(n.y-game.p.y)**2);
            if(dist < 100) {
                ctx.fillStyle = varColor('--cyan'); ctx.font = "11px Arial"; ctx.fillText("CH·∫†M ƒê·ªÇ B√ÅI KI·∫æN", dx-45, dy-70);
                // B·∫Øt s·ª± ki·ªán ch·∫°m t∆∞∆°ng t√°c
                canvas.ontouchstart = (e) => {
                    const touch = e.touches[0];
                    if(touch.clientX > canvas.width/4) openShop(n.r);
                };
            }
        });
    }

    /** --- H√ÄM V·∫º L∆Ø·ªöI GRID --- **/
    function drawGrid(cx, cy) {
        ctx.strokeStyle = "#121212"; ctx.lineWidth = 1;
        let sX = Math.floor(game.p.x/100)*100-1000, sY = Math.floor(game.p.y/100)*100-1000;
        for(let x=sX; x<sX+2000; x+=100) { ctx.beginPath(); ctx.moveTo(x+cx, 0); ctx.lineTo(x+cx, canvas.height); ctx.stroke(); }
        for(let y=sY; y<sY+2000; y+=100) { ctx.beginPath(); ctx.moveTo(0, y+cy); ctx.lineTo(canvas.width, y+cy); ctx.stroke(); }
    }

    /** --- H·ªÜ TH·ªêNG C·ª¨A H√ÄNG K·ª∏ NƒÇNG --- **/
    function openShop(role) {
        const root = document.getElementById('shop-items');
        const title = document.getElementById('shop-title');
        root.innerHTML = '';
        if(role === 'SKILL') {
            title.innerText = "TR∆Ø·ªûNG M√îN: TRUY·ªÄN D·∫†Y";
            game.p.skills.forEach((s, i) => {
                if(!s.unlocked) {
                    const row = document.createElement('div');
                    row.className = 'shop-row';
                    row.innerHTML = `
                        <div style="font-size:13px"><b>${s.n}</b><br><small>ST: ${s.dmg}</small></div>
                        <button class="buy-btn" onclick="buySkill(${i})">${s.cost.toLocaleString()}üí∞</button>
                    `;
                    root.appendChild(row);
                }
            });
        } else {
            title.innerText = "S∆Ø PH·ª§: NHI·ªÜM V·ª§";
            root.innerHTML = `
                <div style="padding:15px; text-align:center;">
                    <p>"Con c·∫ßn t√≠ch l≈©y th√™m Linh Th·∫°ch b·∫±ng c√°ch tr·ª´ y√™u di·ªát ma ngo√†i kia."</p>
                    <p style="color:var(--gold)">M·ª•c ti√™u: ƒê·ªß Linh Th·∫°ch ƒë·ªÉ h·ªçc Tuy·ªát K·ªπ!</p>
                </div>`;
        }
        document.getElementById('shop-ui').style.display = 'block';
    }

    function buySkill(i) {
        let s = game.p.skills[i];
        if(game.p.gold >= s.cost) {
            game.p.gold -= s.cost;
            game.p.skills[i].unlocked = true;
            addLog(`Ch√∫c m·ª´ng! B·∫°n ƒë√£ ng·ªô ƒë∆∞·ª£c [${s.n}]`);
            updateUI(); openShop('SKILL');
        } else {
            alert("Linh th·∫°ch kh√¥ng ƒë·ªß ƒë·ªÉ b√°i s∆∞ h·ªçc ƒë·∫°o!");
        }
    }

    /** --- SINH QU√ÅI V·∫¨T T·ª∞ ƒê·ªòNG --- **/
    function updateWorld() {
        let cx = Math.floor(game.p.x / 2500), cy = Math.floor(game.p.y / 2500);
        for(let i=-1; i<=1; i++) {
            for(let j=-1; j<=1; j++) {
                let key = `${cx+i},${cy+j}`;
                if(!game.world.chunks.has(key)) {
                    game.world.chunks.add(key);
                    spawnChunk(cx+i, cy+j);
                }
            }
        }
    }

    function spawnChunk(cx, cy) {
        let bx = cx * 2500, by = cy * 2500;
        // C·ªïng T√¥ng M√¥n
        Object.keys(SECT_CONFIG).forEach((sName, idx) => {
            if(Math.random() > 0.85) {
                game.world.entities.push({
                    type: 'sect-portal', x: bx + Math.random()*2000, y: by + Math.random()*2000, name: sName
                });
            }
        });
        // Qu√°i v·∫≠t
        for(let k=0; k<8; k++) {
            game.world.entities.push({
                type: 'mob', x: bx + Math.random()*2500, y: by + Math.random()*2500, hp: 150, color: '#ff4757'
            });
        }
        // NPC ƒëi d·∫°o
        if(Math.random() > 0.7) {
            game.world.entities.push({
                type: 'npc', x: bx + 1200, y: by + 1200, hp: 1000, 
                name: "ƒê·∫°o H·ªØu", isHostile: false, lastMove: 0, lastTalk: 0, msg: ""
            });
        }
    }

    /** --- C√ÅC H√ÄM H·ªñ TR·ª¢ --- **/
    function drawPlayer(x, y) {
        ctx.strokeStyle = SECT_CONFIG[game.p.sect].color; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(x, y-40, 9, 0, Math.PI*2); ctx.stroke(); // ƒê·∫ßu
        ctx.beginPath(); ctx.moveTo(x, y-31); ctx.lineTo(x, y-10); ctx.stroke(); // Th√¢n
        ctx.beginPath(); ctx.moveTo(x, y-28); ctx.lineTo(x-18, y-15); ctx.stroke(); // Tay
        ctx.beginPath(); ctx.moveTo(x, y-28); ctx.lineTo(x+18, y-15); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x, y-10); ctx.lineTo(x-12, y+8); ctx.stroke(); // Ch√¢n
        ctx.beginPath(); ctx.moveTo(x, y-10); ctx.lineTo(x+12, y+8); ctx.stroke();
    }

    function drawRadar() {
        rCtx.fillStyle = "#000"; rCtx.fillRect(0,0,140,140);
        if(game.state !== 'WORLD') return;
        game.world.entities.forEach(en => {
            let rx = 70+(en.x-game.p.x)*game.world.zoom, ry = 70+(en.y-game.p.y)*game.world.zoom;
            if(rx>0&&rx<140&&ry>0&&ry<140) {
                rCtx.fillStyle = en.type==='sect-portal'?'gold':(en.type==='npc'?'white':'red');
                rCtx.beginPath(); rCtx.arc(rx,ry,en.type==='sect-portal'?4:1.8,0,Math.PI*2); rCtx.fill();
            }
        });
        rCtx.fillStyle = varColor('--cyan'); rCtx.beginPath(); rCtx.arc(70,70,3,0,Math.PI*2); rCtx.fill();
    }

    function updateUI() {
        document.getElementById('ui-gold').innerText = game.p.gold.toLocaleString();
        document.getElementById('ui-coords').innerText = `${Math.floor(game.p.x)},${Math.floor(game.p.y)}`;
        document.getElementById('hp-bar').style.width = (game.p.hp/game.p.maxHp*100) + "%";
        game.p.skills.forEach((s, i) => { if(s.unlocked) document.getElementById(`sk-${i}`).classList.add('unlocked'); });
    }

    function addLog(m) {
        const box = document.getElementById('chat-box');
        box.innerHTML += `<div>${m}</div>`; box.scrollTop = box.scrollHeight;
    }

    function closeShop() { document.getElementById('shop-ui').style.display = 'none'; canvas.ontouchstart = null; }
    function mapZoom(v) { game.world.zoom = Math.max(0.005, Math.min(0.1, game.world.zoom * v)); }
    function varColor(n) { return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); }

    initPicker();
</script>
</body>
</html>
