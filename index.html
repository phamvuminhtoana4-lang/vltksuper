<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>THI√äN GI·ªöI V√î T·∫¨N - CHI·∫æN THU·∫¨T TAM K·ª∏</title>
    <style>
        :root {
            --cyan: #00ffff; --gold: #f1c40f; --red: #ff4757; 
            --purple: #a29bfe; --bg: #050505; --ui-bg: rgba(10, 10, 10, 0.95);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            margin: 0; padding: 0; background: #000; overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; user-select: none; 
        }

        #game-wrapper { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        canvas { display: block; filter: contrast(1.1) brightness(1.1); }

        /* HUD - Th√¥ng tin nh√¢n v·∫≠t */
        .hud-header {
            position: absolute; top: 15px; left: 15px;
            display: flex; gap: 15px; background: var(--ui-bg);
            padding: 12px; border-radius: 60px 20px 20px 60px;
            border: 2px solid #333; pointer-events: none; z-index: 10;
        }
        .avatar { 
            width: 65px; height: 65px; background: #1a1a1a; 
            border: 3px solid var(--gold); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 32px; 
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.3);
        }
        .stats-box { display: flex; flex-direction: column; justify-content: center; }
        .hp-bar-outer { width: 180px; height: 12px; background: #222; border-radius: 6px; margin: 5px 0; border: 1px solid #444; }
        #hp-fill { height: 100%; background: linear-gradient(90deg, #ff4757, #ff6b81); width: 100%; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .gold-txt { font-size: 13px; color: var(--gold); font-weight: bold; text-shadow: 1px 1px #000; }

        /* B·∫£n ƒë·ªì & T·ªça ƒë·ªô */
        .map-box {
            position: absolute; top: 15px; right: 15px;
            width: 140px; height: 140px; background: #000;
            border: 2px solid #444; border-radius: 12px; overflow: hidden; z-index: 10;
        }
        #radar { width: 100%; height: 100%; }
        #coords { position: absolute; bottom: 5px; left: 5px; font-size: 10px; color: #aaa; background: rgba(0,0,0,0.5); padding: 2px 5px; }

        /* JOYSTICK B√äN TR√ÅI */
        #joy-container {
            position: absolute; bottom: 50px; left: 50px;
            width: 160px; height: 160px; background: rgba(255,255,255,0.02);
            border-radius: 50%; border: 2px solid rgba(255,255,255,0.08); z-index: 20;
        }
        #joy-stick {
            position: absolute; top: 50%; left: 50%;
            width: 70px; height: 70px; margin: -35px;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 50%; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2);
        }

        /* H·ªÜ TH·ªêNG 3 K·ª∏ NƒÇNG X·∫æP QUANH N√öT ƒê√ÅNH */
        .action-zone {
            position: absolute; bottom: 30px; right: 30px;
            width: 250px; height: 250px; pointer-events: none; z-index: 20;
        }
        .main-atk {
            position: absolute; bottom: 20px; right: 20px;
            width: 100px; height: 100px; background: var(--cyan);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 45px; border: 4px solid #fff; pointer-events: auto;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.4); z-index: 25;
            transition: transform 0.1s;
        }
        .main-atk:active { transform: scale(0.9); }

        .slot {
            position: absolute; width: 60px; height: 60px;
            background: var(--ui-bg); border: 2px solid #555; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; pointer-events: auto; transition: 0.2s;
        }
        .slot.ready { border-color: var(--gold); box-shadow: 0 0 10px var(--gold); }
        .slot .cd { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.8); height: 0%; border-radius: 50%; }
        
        /* T·ªça ƒë·ªô 3 k·ªπ nƒÉng trang b·ªã xung quanh n√∫t ƒë√°nh */
        #slot-0 { bottom: 125px; right: 15px; }  /* Ph√≠a tr√™n */
        #slot-1 { bottom: 100px; right: 100px; } /* Ch√©o tr√™n tr√°i */
        #slot-2 { bottom: 15px; right: 125px; }  /* B√™n tr√°i */

        /* UI QU·∫¢N L√ù T√îNG M√îN / TRANG B·ªä */
        #sect-ui {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px; height: 85vh; background: var(--ui-bg);
            border: 2px solid var(--gold); border-radius: 20px; display: none; z-index: 1000;
            padding: 25px; flex-direction: column;
        }
        .skill-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
            overflow-y: auto; flex-grow: 1; margin: 15px 0; padding-right: 5px;
        }
        .skill-card {
            background: #1a1a1a; border: 1px solid #444; padding: 10px;
            border-radius: 12px; display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .skill-card.unlocked { border-color: var(--cyan); }
        .skill-card button {
            width: 100%; padding: 6px; border: none; border-radius: 5px; font-weight: bold; font-size: 11px;
        }
        .btn-learn { background: var(--gold); color: #000; }
        .btn-equip { background: var(--cyan); color: #000; }
        
        .tab-btn { padding: 10px 20px; background: #222; border: 1px solid #444; color: white; border-radius: 10px; }
        .tab-btn.active { background: var(--gold); color: #000; }

        /* Log H·ªá th·ªëng */
        #log-box {
            position: absolute; bottom: 20px; left: 230px; width: 280px; height: 110px;
            background: rgba(0,0,0,0.4); font-size: 11px; padding: 10px; 
            pointer-events: none; border-radius: 10px; color: #ddd; overflow: hidden;
        }

        #exit-btn {
            position: absolute; top: 25px; left: 50%; transform: translateX(-50%);
            padding: 12px 35px; background: var(--red); color: white; border: none;
            border-radius: 30px; font-weight: bold; display: none; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* M√†n h√¨nh ch·ªçn ph√°i */
        #start-screen {
            position: fixed; inset: 0; background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
        }
        .sect-item {
            padding: 15px; margin: 6px; background: #111; border: 1px solid #333;
            color: white; border-radius: 12px; width: 280px; text-align: center; font-weight: bold;
        }
        .sect-item.active { border-color: var(--gold); background: rgba(241, 196, 15, 0.1); box-shadow: 0 0 15px var(--gold); }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="start-screen">
        <h1 style="color:var(--gold); letter-spacing: 5px; margin-bottom: 5px;">THI√äN GI·ªöI V√î T·∫¨N</h1>
        <p style="color:#666; font-size: 12px; margin-bottom: 30px;">H·ªÜ TH·ªêNG TAM K·ª∏ - TH·∫¨P ƒê·∫†I T√îNG M√îN</p>
        <div id="sect-list"></div>
        <button onclick="startGame()" style="margin-top:40px; padding:18px 80px; background:var(--gold); border:none; font-weight:bold; border-radius:40px; color:#000; font-size:16px;">XU·∫§T TH·∫æ</button>
    </div>

    <div id="sect-ui">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h2 id="ui-title" style="color:var(--gold); margin:0;">T√îNG M√îN</h2>
            <div style="color:var(--cyan); font-weight:bold;">üí∞ <span id="ui-gold-shop">0</span></div>
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom: 15px;">
            <button class="tab-btn active" id="tab-learn">H·ªåC ƒê·∫†O</button>
            <button class="tab-btn" id="tab-equip">TRANG B·ªä</button>
        </div>

        <div id="skill-grid" class="skill-grid"></div>
        
        <button onclick="closeUI()" style="width:100%; padding:15px; background:#333; border:none; color:white; border-radius:12px; font-weight:bold;">LUI RA</button>
    </div>

    <button id="exit-btn" onclick="leaveSect()">R·ªúI KH·ªéI T√îNG M√îN</button>

    <canvas id="gameCanvas"></canvas>

    <div class="hud-header">
        <div class="avatar" id="p-avatar">üë§</div>
        <div class="stats-box">
            <div style="font-size:14px; font-weight:bold; color:var(--cyan);"><span id="p-sect-name">K·∫ª v√¥ danh</span></div>
            <div class="hp-bar-outer"><div id="hp-fill"></div></div>
            <div class="gold-txt">üí∞ Linh th·∫°ch: <span id="p-gold">0</span></div>
        </div>
    </div>

    <div class="map-box">
        <canvas id="radar"></canvas>
        <div id="coords">0, 0</div>
    </div>

    <div id="log-box"></div>

    <div id="joy-container"><div id="joy-stick"></div></div>

    <div class="action-zone">
        <div class="main-atk" id="btn-atk">‚öîÔ∏è</div>
        <div class="slot" id="slot-0">üîí<div class="cd" id="cd-0"></div></div>
        <div class="slot" id="slot-1">üîí<div class="cd" id="cd-1"></div></div>
        <div class="slot" id="slot-2">üîí<div class="cd" id="cd-2"></div></div>
    </div>
</div>
<script>
    // C·∫•u h√¨nh 10 T√¥ng m√¥n - M·ªói m√¥n 14 chi√™u t·ª´ s∆° c·∫•p ƒë·∫øn th·∫ßn c·∫•p
    const SECT_DATA = {
        "V√µ ƒêang": { color: "#3498db", icon: "‚òØÔ∏è", skills: [
            {n: "Th√°i C·ª±c Ki·∫øm", i: "üó°Ô∏è", cost: 500, cd: 2, dmg: 100},
            {n: "B√°t Qu√°i Ch∆∞·ªüng", i: "üëê", cost: 2000, cd: 4, dmg: 250},
            {n: "Thanh Phong B·ªô", i: "üçÉ", cost: 8000, cd: 12, dmg: 0},
            {n: "V√¥ C·ª±c C√¥ng", i: "üåÄ", cost: 25000, cd: 10, dmg: 600},
            {n: "H·ªï Tr·∫£o Th·ªß", i: "üêæ", cost: 60000, cd: 8, dmg: 900},
            {n: "Th√°i C·ª±c Tr·∫≠n", i: "üéá", cost: 150000, cd: 25, dmg: 2500},
            {n: "Huy·ªÅn V≈© C√¥ng", i: "üê¢", cost: 400000, cd: 40, dmg: 4500},
            {n: "Th√°i H∆∞ Ki·∫øm", i: "‚ú®", cost: 900000, cd: 20, dmg: 8000},
            {n: "L∆∞·ª°ng Nghi ·∫§n", i: "üåó", cost: 2000000, cd: 30, dmg: 15000},
            {n: "Ch√¢n V≈© Ki·∫øm", i: "üî±", cost: 4500000, cd: 45, dmg: 35000},
            {n: "ƒê·∫°o Ph√°p T·ª± Nhi√™n", i: "üìú", cost: 8000000, cd: 60, dmg: 80000},
            {n: "V√¥ Th∆∞·ª£ng Th√°i C·ª±c", i: "üåå", cost: 15000000, cd: 80, dmg: 200000},
            {n: "Nh√¢n Ki·∫øm H·ª£p Nh·∫•t", i: "‚õ©Ô∏è", cost: 30000000, cd: 100, dmg: 500000},
            {n: "Th√°i C·ª±c ƒê·∫°o T·ªï", i: "üëë", cost: 70000000, cd: 150, dmg: 1200000}
        ]},
        "Thi·∫øu L√¢m": { color: "#f1c40f", icon: "üìø", skills: [
            {n: "La H√°n Quy·ªÅn", i: "‚úä", cost: 500, cd: 2, dmg: 120},
            {n: "Vi ƒê√† Ch∆∞·ªüng", i: "‚úã", cost: 2000, cd: 3.5, dmg: 280},
            {n: "S∆∞ T·ª≠ H·ªëng", i: "ü¶Å", cost: 8000, cd: 15, dmg: 700},
            {n: "Kim Cang C√¥ng", i: "üõ°Ô∏è", cost: 25000, cd: 30, dmg: 0},
            {n: "Long Tr·∫£o Th·ªß", i: "üêâ", cost: 60000, cd: 7, dmg: 1100},
            {n: "D·ªãch C√¢n Kinh", i: "üß¨", cost: 150000, cd: 60, dmg: 0},
            {n: "B√°t Nh√£ Ch∆∞·ªüng", i: "üßø", cost: 400000, cd: 20, dmg: 5000},
            {n: "ƒê·∫°i Bi Ch√∫", i: "üïç", cost: 900000, cd: 50, dmg: 10000},
            {n: "Thi√™n Th·ªß Quan √Çm", i: "üôå", cost: 2000000, cd: 40, dmg: 22000},
            {n: "B·ªì ƒê·ªÅ C√¥ng", i: "üå≥", cost: 4500000, cd: 55, dmg: 45000},
            {n: "Nh∆∞ Lai Th·∫ßn Ch∆∞·ªüng", i: "üñêÔ∏è", cost: 8000000, cd: 80, dmg: 100000},
            {n: "Kim Cang B·∫•t Ho·∫°i", i: "‚ú®", cost: 15000000, cd: 120, dmg: 0},
            {n: "V·∫°n Ph·∫≠t Tri·ªÅu T√¥ng", i: "‚ò∏Ô∏è", cost: 30000000, cd: 150, dmg: 600000},
            {n: "T·ªï S∆∞ Thi·ªÅn", i: "üßò", cost: 70000000, cd: 200, dmg: 1500000}
        ]},
        "Minh Gi√°o": { color: "#e67e22", icon: "üî•", skills: [
            {n: "H·ªèa Long Ch∆∞·ªüng", i: "üî•", cost: 500, cd: 2, dmg: 130},
            {n: "Th√°nh H·ªèa L·ªánh", i: "üèÆ", cost: 2500, cd: 5, dmg: 350},
            {n: "C√†n Kh√¥n ƒê·∫°i Na Di", i: "üåÄ", cost: 30000, cd: 25, dmg: 1500},
            {n: "C·ª≠u D∆∞∆°ng C√¥ng", i: "‚òÄÔ∏è", cost: 200000, cd: 60, dmg: 5000},
            // ... (Ti·∫øp t·ª•c c·∫•u h√¨nh c√°c ph√°i kh√°c t∆∞∆°ng t·ª± ƒë·ªÉ ƒë·ªß 10 ph√°i)
        ]},
        "C√°i Bang": { color: "#8e44ad", icon: "üçñ", skills: [
            {n: "ƒê·∫£ C·∫©u B·ªïng", i: "ü•¢", cost: 500, cd: 2, dmg: 110},
            {n: "H√†ng Long Th·∫≠p B√°t", i: "üêâ", cost: 10000, cd: 8, dmg: 1200}
        ]},
        "ƒê∆∞·ªùng M√¥n": { color: "#2ecc71", icon: "üèπ", skills: [
            {n: "Xuy√™n T√¢m Ti·ªÖn", i: "üìç", cost: 500, cd: 1.5, dmg: 90},
            {n: "B·∫°o V≈© L√™ Hoa", i: "üí•", cost: 50000, cd: 15, dmg: 4000}
        ]},
        "Nga Mi": { color: "#fd79a8", icon: "üå∏", skills: [
            {n: "Nga Mi Ki·∫øm", i: "üó°Ô∏è", cost: 500, cd: 2, dmg: 95},
            {n: "Thanh T√¢m Ch√∫", i: "üßº", cost: 40000, cd: 40, dmg: 0}
        ]},
        "Hoa S∆°n": { color: "#ecf0f1", icon: "‚õ∞Ô∏è", skills: [
            {n: "Hoa S∆°n Ki·∫øm Ph√°p", i: "‚öîÔ∏è", cost: 500, cd: 2, dmg: 115},
            {n: "ƒê·ªôc C√¥ C·ª≠u Ki·∫øm", i: "ü¶Ö", cost: 1000000, cd: 20, dmg: 15000}
        ]},
        "Ti√™u Dao": { color: "#55efc4", icon: "üß™", skills: [
            {n: "B·∫Øc Minh Th·∫ßn C√¥ng", i: "üåÄ", cost: 1000, cd: 3, dmg: 150},
            {n: "LƒÉng Ba Vi B·ªô", i: "üí®", cost: 5000, cd: 20, dmg: 0}
        ]},
        "To√†n Ch√¢n": { color: "#9b59b6", icon: "üåü", skills: [
            {n: "To√†n Ch√¢n Ki·∫øm", i: "üó°Ô∏è", cost: 500, cd: 2, dmg: 105},
            {n: "Ti√™n Thi√™n C√¥ng", i: "üßò", cost: 500000, cd: 60, dmg: 0}
        ]},
        "Huy·∫øt ƒêao": { color: "#c0392b", icon: "üî™", skills: [
            {n: "Huy·∫øt ƒêao Ph√°p", i: "üî™", cost: 500, cd: 2, dmg: 140},
            {n: "Huy·∫øt S√°t C√¥ng", i: "ü©∏", cost: 100000, cd: 15, dmg: 5000}
        ]}
    };

    // Kh·ªüi t·∫°o c√°c bi·∫øn h·ªá th·ªëng
    let game = {
        state: 'WORLD', // WORLD ho·∫∑c SECT
        p: {
            x: 0, y: 0, vx: 0, vy: 0, speed: 2.3,
            hp: 1200, maxHp: 1200, gold: 0,
            sect: null, 
            skillsOwned: [], // Danh s√°ch c√°c chi√™u ƒë√£ h·ªçc
            equipped: [null, null, null], // 3 √¥ trang b·ªã
            lastCD: [0, 0, 0] // Th·ªùi gian h·ªìi chi√™u cho 3 √¥
        },
        entities: [], // Qu√°i, NPC, Portal
        chunks: new Set(),
        cam: { x: 0, y: 0 },
        joy: { x: 0, y: 0, active: false },
        lastPos: { x: 0, y: 0 }
    };

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const rCanvas = document.getElementById('radar');
    const rCtx = rCanvas.getContext('2d');

    // H√†m kh·ªüi t·∫°o danh s√°ch ph√°i ·ªü m√†n h√¨nh ch·ªù
    function initSectPicker() {
        const container = document.getElementById('sect-list');
        Object.keys(SECT_DATA).forEach(name => {
            let div = document.createElement('div');
            div.className = 'sect-item';
            div.innerHTML = `${SECT_DATA[name].icon} ${name}`;
            div.onclick = () => {
                game.p.sect = name;
                document.querySelectorAll('.sect-item').forEach(e => e.classList.remove('active'));
                div.classList.add('active');
            };
            container.appendChild(div);
        });
    }

    // H√†m Trang b·ªã k·ªπ nƒÉng v√†o √¥ (Slot 0, 1, 2)
    function equipSkill(skillIndex, slot) {
        let skillName = game.p.skillsOwned[skillIndex];
        // Ki·ªÉm tra xem k·ªπ nƒÉng n√†y ƒë√£ trang b·ªã ·ªü √¥ kh√°c ch∆∞a
        if (game.p.equipped.includes(skillName)) {
            let oldSlot = game.p.equipped.indexOf(skillName);
            game.p.equipped[oldSlot] = null;
        }
        game.p.equipped[slot] = skillName;
        updateUI();
        renderSkillGrid('EQUIP');
        addLog(`ƒê√£ trang b·ªã [${skillName}] v√†o √¥ ${slot + 1}`);
    }

    initSectPicker();
             </script>
                 /** --- H·ªÜ TH·ªêNG QU·∫¢N L√ù UI (H·ªåC ƒê·∫†O & TRANG B·ªä) --- **/
    const tabLearn = document.getElementById('tab-learn');
    const tabEquip = document.getElementById('tab-equip');
    let currentTab = 'LEARN';

    tabLearn.onclick = () => { currentTab = 'LEARN'; renderSkillGrid(); tabLearn.classList.add('active'); tabEquip.classList.remove('active'); };
    tabEquip.onclick = () => { currentTab = 'EQUIP'; renderSkillGrid(); tabEquip.classList.add('active'); tabLearn.classList.remove('active'); };

    function renderSkillGrid() {
        const grid = document.getElementById('skill-grid');
        grid.innerHTML = '';
        const allSkills = SECT_DATA[game.p.sect].skills;

        allSkills.forEach((s, idx) => {
            const isOwned = game.p.skillsOwned.includes(s.n);
            const card = document.createElement('div');
            card.className = `skill-card ${isOwned ? 'unlocked' : ''}`;
            
            let actionBtn = '';
            if (currentTab === 'LEARN') {
                actionBtn = isOwned ? 
                    `<button disabled style="background:#222; color:#555">ƒê√É THU·ªòC</button>` : 
                    `<button class="btn-learn" onclick="buySkill(${idx})">H·ªåC (${s.cost}üí∞)</button>`;
            } else if (isOwned) {
                actionBtn = `
                    <div style="display:flex; gap:2px; width:100%">
                        <button class="btn-equip" onclick="equipSkill(${game.p.skillsOwned.indexOf(s.n)}, 0)">√î 1</button>
                        <button class="btn-equip" onclick="equipSkill(${game.p.skillsOwned.indexOf(s.n)}, 1)">√î 2</button>
                        <button class="btn-equip" onclick="equipSkill(${game.p.skillsOwned.indexOf(s.n)}, 2)">√î 3</button>
                    </div>`;
            }

            card.innerHTML = `
                <div style="font-size:24px">${s.i}</div>
                <div style="font-size:11px; font-weight:bold; text-align:center">${s.n}</div>
                <div style="font-size:9px; color:#aaa">ST: ${s.dmg} | H·ªìi: ${s.cd}s</div>
                ${actionBtn}
            `;
            grid.appendChild(card);
        });
    }

    function buySkill(idx) {
        const s = SECT_DATA[game.p.sect].skills[idx];
        if (game.p.gold >= s.cost) {
            game.p.gold -= s.cost;
            game.p.skillsOwned.push(s.n);
            addLog(`<span style="color:var(--gold)">Ng·ªô t√≠nh c·ª±c cao! B·∫°n ƒë√£ h·ªçc ƒë∆∞·ª£c [${s.n}]</span>`);
            updateUI(); renderSkillGrid();
        } else {
            addLog("<span style="color:var(--red)">Linh th·∫°ch kh√¥ng ƒë·ªß, h√£y ƒëi di·ªát qu√°i!</span>");
        }
    }

    /** --- CHUY·ªÇN MAP & KH√îNG GIAN --- **/
    function enterSect(name) {
        if (game.p.sect !== name) {
            addLog(`H·ªá th·ªëng: B·∫°n kh√¥ng ph·∫£i ƒë·ªá t·ª≠ ${name}, kh√¥ng th·ªÉ v√†o!`);
            game.p.x -= 50; return; 
        }
        game.lastPos = { x: game.p.x, y: game.p.y };
        game.state = 'SECT';
        game.p.x = 500; game.p.y = 700;
        document.getElementById('exit-btn').style.display = 'block';
        addLog(`ƒêang ti·∫øn v√†o th√°nh ƒë·ªãa ${name}...`);
    }

    function leaveSect() {
        game.state = 'WORLD';
        game.p.x = game.lastPos.x; game.p.y = game.lastPos.y + 50;
        document.getElementById('exit-btn').style.display = 'none';
        addLog("ƒê√£ tr·ªü l·∫°i h·ªìng tr·∫ßn.");
    }

    /** --- V√íNG L·∫∂P RENDER (PART 1) --- **/
    function update() {
        // C·∫≠p nh·∫≠t t·ªça ƒë·ªô theo Joystick
        if (game.joy.active) {
            game.p.x += game.joy.x * game.p.speed;
            game.p.y += game.joy.y * game.p.speed;
        }

        // Camera b√°m s√°t nh√¢n v·∫≠t
        game.cam.x = canvas.width / 2 - game.p.x;
        game.cam.y = canvas.height / 2 - game.p.y;

        // X·ª≠ l√Ω va ch·∫°m Th·∫ø gi·ªõi
        if (game.state === 'WORLD') {
            updateWorld();
        } else {
            // Gi·ªõi h·∫°n trong T√¥ng m√¥n
            game.p.x = Math.max(150, Math.min(850, game.p.x));
            game.p.y = Math.max(150, Math.min(850, game.p.y));
        }
    }

    function draw() {
        ctx.fillStyle = "#050505";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const cx = game.cam.x; const cy = game.cam.y;

        if (game.state === 'WORLD') {
            drawGrid(cx, cy);
            drawEntities(cx, cy);
        } else {
            drawSectScene(cx, cy);
        }

        drawPlayer();
        drawRadar();
        updateUI();
        requestAnimationFrame(() => { update(); draw(); });
    }

    function drawSectScene(cx, cy) {
        // V·∫Ω n·ªÅn t√¥ng m√¥n
        ctx.fillStyle = "#151515";
        ctx.fillRect(100 + cx, 100 + cy, 800, 800);
        ctx.strokeStyle = varColor('--gold');
        ctx.lineWidth = 4;
        ctx.strokeRect(100 + cx, 100 + cy, 800, 800);

        // V·∫Ω Tr∆∞·ªüng M√¥n AI
        const masterX = 500 + cx, masterY = 300 + cy;
        ctx.font = "60px Arial"; ctx.fillText("üßô‚Äç‚ôÇÔ∏è", masterX - 30, masterY);
        ctx.fillStyle = "white"; ctx.font = "bold 16px Arial";
        ctx.fillText("TR∆Ø·ªûNG M√îN", masterX - 45, masterY + 40);

        // T·ª± ƒë·ªông m·ªü UI khi l·∫°i g·∫ßn Tr∆∞·ªüng M√¥n
        let dist = Math.sqrt((game.p.x - 500) ** 2 + (game.p.y - 300) ** 2);
        if (dist < 80 && document.getElementById('sect-ui').style.display === 'none') {
            openUI();
        }
    }
                /** --- H·ªÜ TH·ªêNG ƒêI·ªÄU KHI·ªÇN JOYSTICK & C·∫¢M ·ª®NG --- **/
    const joyContainer = document.getElementById('joy-container');
    const joyStick = document.getElementById('joy-stick');
    let joyRect = joyContainer.getBoundingClientRect();

    window.addEventListener('resize', () => { 
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        joyRect = joyContainer.getBoundingClientRect();
    });

    // X·ª≠ l√Ω di chuy·ªÉn Joystick
    const handleMove = (e) => {
        e.preventDefault();
        const touch = e.touches ? e.touches[0] : e;
        const centerX = joyRect.left + joyRect.width / 2;
        const centerY = joyRect.top + joyRect.height / 2;
        let dx = touch.clientX - centerX;
        let dy = touch.clientY - centerY;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const maxDist = joyRect.width / 2;

        if (dist > maxDist) { dx *= maxDist / dist; dy *= maxDist / dist; }

        game.joy.x = dx / maxDist;
        game.joy.y = dy / maxDist;
        game.joy.active = true;
        joyStick.style.transform = `translate(${dx}px, ${dy}px)`;
    };

    joyContainer.addEventListener('touchstart', (e) => { game.joy.active = true; handleMove(e); });
    joyContainer.addEventListener('touchmove', handleMove);
    joyContainer.addEventListener('touchend', () => {
        game.joy.active = false; game.joy.x = 0; game.joy.y = 0;
        joyStick.style.transform = `translate(0px, 0px)`;
    });

    /** --- H·ªÜ TH·ªêNG CHI·∫æN ƒê·∫§U & K·ª∏ NƒÇNG --- **/
    function castSkill(slotIdx) {
        const skillName = game.p.equipped[slotIdx];
        if (!skillName) return;

        const now = Date.now();
        const skillBase = SECT_DATA[game.p.sect].skills.find(s => s.n === skillName);
        
        // Ki·ªÉm tra h·ªìi chi√™u
        if (now - game.p.lastCD[slotIdx] < skillBase.cd * 1000) {
            addLog(`<span style="color:#666">Ch∆∞a h·ªìi chi√™u ${skillName}!</span>`);
            return;
        }

        // Thi tri·ªÉn k·ªπ nƒÉng
        game.p.lastCD[slotIdx] = now;
        startCDAnimation(slotIdx, skillBase.cd);
        
        // T·∫°o hi·ªáu ·ª©ng h√¨nh ·∫£nh
        spawnEffect(game.p.x, game.p.y, skillBase.i, SECT_DATA[game.p.sect].color);

        // X·ª≠ l√Ω s√°t th∆∞∆°ng di·ªán r·ªông
        let hitCount = 0;
        game.entities.forEach(en => {
            if (en.type === 'mob') {
                let d = Math.sqrt((en.x - game.p.x)**2 + (en.y - game.p.y)**2);
                if (d < 180) { // Ph·∫°m vi s√°t th∆∞∆°ng
                    en.hp -= skillBase.dmg;
                    hitCount++;
                    if (en.hp <= 0) {
                        game.p.gold += 150; // Th∆∞·ªüng linh th·∫°ch
                        en.dead = true;
                    }
                }
            }
        });
        
        addLog(`<span style="color:var(--cyan)">Thi tri·ªÉn ${skillName}! (ƒê·∫£ th∆∞∆°ng ${hitCount} m·ª•c ti√™u)</span>`);
    }

    function startCDAnimation(slot, duration) {
        const mask = document.getElementById(`cd-${slot}`);
        mask.style.height = "100%";
        let start = Date.now();
        let timer = setInterval(() => {
            let elapsed = Date.now() - start;
            let percent = 100 - (elapsed / (duration * 1000) * 100);
            mask.style.height = Math.max(0, percent) + "%";
            if (percent <= 0) clearInterval(timer);
        }, 50);
    }

    /** --- RENDER TH·ª∞C TH·ªÇ & QU√ÅI V·∫¨T --- **/
    function drawEntities(cx, cy) {
        game.entities = game.entities.filter(en => !en.dead);
        game.entities.forEach(en => {
            let dx = en.x + cx, dy = en.y + cy;
            if (dx < -50 || dx > canvas.width + 50 || dy < -50 || dy > canvas.height + 50) return;

            if (en.type === 'portal') {
                ctx.font = "50px Arial"; ctx.fillText("‚õ©Ô∏è", dx - 25, dy);
                ctx.fillStyle = "gold"; ctx.font = "12px Arial"; ctx.fillText(en.name, dx - 20, dy + 25);
                if (Math.sqrt((en.x - game.p.x)**2 + (en.y - game.p.y)**2) < 60) enterSect(en.name);
            } else {
                // V·∫Ω Qu√°i V·∫≠t
                ctx.fillStyle = "#ff4757"; ctx.beginPath(); ctx.arc(dx, dy, 15, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "#222"; ctx.fillRect(dx - 15, dy - 25, 30, 4);
                ctx.fillStyle = "red"; ctx.fillRect(dx - 15, dy - 25, (en.hp/150)*30, 4);
                
                // AI Qu√°i v·∫≠t ƒëu·ªïi theo ng∆∞·ªùi ch∆°i
                let adx = game.p.x - en.x, ady = game.p.y - en.y;
                let dist = Math.sqrt(adx*adx + ady*ady);
                if (dist < 300) {
                    en.x += (adx/dist) * 1.2; en.y += (ady/dist) * 1.2;
                    if (dist < 40 && Date.now() % 100 < 5) {
                        game.p.hp -= 5; // Qu√°i c·∫Øn
                        if (game.p.hp < 0) game.p.hp = 0;
                    }
                }
            }
        });
    }

    function spawnEffect(x, y, icon, color) {
        ctx.save();
        ctx.shadowBlur = 20; ctx.shadowColor = color;
        ctx.fillStyle = "white"; ctx.font = "40px Arial";
        ctx.fillText(icon, canvas.width/2 - 20, canvas.height/2 - 60);
        ctx.restore();
    }

    /** --- KH·ªûI CH·∫†Y GAME --- **/
    function updateWorld() {
        // T·ª± ƒë·ªông sinh qu√°i quanh v·ªã tr√≠ ng∆∞·ªùi ch∆°i
        if (game.entities.filter(e => e.type === 'mob').length < 15) {
            game.entities.push({
                type: 'mob', hp: 150,
                x: game.p.x + (Math.random() - 0.5) * 1500,
                y: game.p.y + (Math.random() - 0.5) * 1500
            });
        }
        // Sinh c·ªïng ph√°i ng·∫´u nhi√™n n·∫øu ch∆∞a c√≥
        if (game.entities.filter(e => e.type === 'portal').length < 5) {
            let names = Object.keys(SECT_DATA);
            game.entities.push({
                type: 'portal', name: names[Math.floor(Math.random() * names.length)],
                x: game.p.x + (Math.random() - 0.5) * 3000,
                y: game.p.y + (Math.random() - 0.5) * 3000
            });
        }
    }

    function drawGrid(cx, cy) {
        ctx.strokeStyle = "#151515"; ctx.lineWidth = 1;
        let step = 100;
        let startX = Math.floor((-cx)/step)*step, startY = Math.floor((-cy)/step)*step;
        for(let x=startX; x<startX+canvas.width+step; x+=step) {
            ctx.beginPath(); ctx.moveTo(x+cx, 0); ctx.lineTo(x+cx, canvas.height); ctx.stroke();
        }
        for(let y=startY; y<startY+canvas.height+step; y+=step) {
            ctx.beginPath(); ctx.moveTo(0, y+cy); ctx.lineTo(canvas.width, y+cy); ctx.stroke();
        }
    }

    function drawPlayer() {
        const x = canvas.width/2, y = canvas.height/2;
        ctx.strokeStyle = SECT_DATA[game.p.sect].color; ctx.lineWidth = 3;
        // ƒê·∫ßu
        ctx.beginPath(); ctx.arc(x, y-35, 10, 0, Math.PI*2); ctx.stroke();
        // Th√¢n & Ki·∫øm
        ctx.beginPath(); ctx.moveTo(x, y-25); ctx.lineTo(x, y); ctx.stroke();
        ctx.strokeStyle = "white"; ctx.beginPath(); ctx.moveTo(x+5, y-15); ctx.lineTo(x+25, y-35); ctx.stroke();
    }

    function updateUI() {
        document.getElementById('p-gold').innerText = game.p.gold.toLocaleString();
        document.getElementById('ui-gold-shop').innerText = game.p.gold.toLocaleString();
        document.getElementById('hp-fill').style.width = (game.p.hp/game.p.maxHp*100) + "%";
        document.getElementById('coords').innerText = `${Math.floor(game.p.x)}, ${Math.floor(game.p.y)}`;
        
        // C·∫≠p nh·∫≠t icon 3 √¥ k·ªπ nƒÉng trang b·ªã
        game.p.equipped.forEach((sName, i) => {
            const slot = document.getElementById(`slot-${i}`);
            if (sName) {
                const sBase = SECT_DATA[game.p.sect].skills.find(sk => sk.n === sName);
                slot.innerHTML = sBase.i + `<div class="cd" id="cd-${i}"></div>`;
                slot.className = "slot ready";
                slot.onclick = () => castSkill(i);
            } else {
                slot.innerHTML = "üîí"; slot.className = "slot"; slot.onclick = null;
            }
        });
    }

    function startGame() {
        if (!game.p.sect) return alert("Vui l√≤ng ch·ªçn m·ªôt T√¥ng m√¥n!");
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('p-sect-name').innerText = game.p.sect;
        document.getElementById('p-avatar').innerText = SECT_DATA[game.p.sect].icon;
        
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        addLog("Ch√†o m·ª´ng ƒë·ªá t·ª≠ ƒë√£ gia nh·∫≠p " + game.p.sect);
        draw();
    }

    function openUI() { document.getElementById('sect-ui').style.display = 'flex'; renderSkillGrid(); }
    function closeUI() { document.getElementById('sect-ui').style.display = 'none'; }
    function addLog(m) {
        const b = document.getElementById('log-box');
        b.innerHTML = `<div>${m}</div>` + b.innerHTML;
    }
    function varColor(n) { return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); }

    // N√∫t ƒë√°nh th∆∞·ªùng (Main Attack)
    document.getElementById('btn-atk').onclick = () => {
        spawnEffect(game.p.x, game.p.y, "‚öîÔ∏è", "white");
        game.entities.forEach(en => {
            if (en.type === 'mob' && Math.sqrt((en.x-game.p.x)**2+(en.y-game.p.y)**2) < 100) {
                en.hp -= 40; if (en.hp <= 0) { game.p.gold += 150; en.dead = true; }
            }
        });
    };
                </script>
                    </body>
                </html>
                    
