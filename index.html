<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>V√ï L√ÇM SUPREME: V·∫†N C·ªî QUY T√îNG</title>
    
    <style id="game-main-styles">
        
:root {
    /* B·∫£ng m√†u Ng≈© H√†nh */
    --gold-bright: #FFD700;
    --gold-dark: #B8860B;
    --gold-glow: rgba(255, 215, 0, 0.6);
    --hp-color: #ff4d4d;
    --mp-color: #3399ff;
    --exp-color: #2ecc71;
    --ele-kim: #ffffff; --ele-moc: #2ecc71; --ele-thuy: #3498db; --ele-hoa: #e74c3c; --ele-tho: #f1c40f;
    
    /* C·∫•u tr√∫c v·∫≠t l√Ω */
    --transition-fast: 0.15s ease;
    --transition-slow: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    --glass: rgba(15, 15, 15, 0.85);
}

/* 1. RESET & N·ªÄN T·∫¢NG C∆† B·∫¢N */
* {
    margin: 0; padding: 0; box-sizing: border-box;
    user-select: none; -webkit-tap-highlight-color: transparent;
}

body, html {
    width: 100%; height: 100%; overflow: hidden;
    background: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #fff;
}

/* 2. M√ÄN H√åNH KH·ªûI ƒê·ªòNG (START SCREEN) */
#start-screen {
    position: fixed; inset: 0; z-index: 10000;
    display: flex; align-items: center; justify-content: center;
    background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
}

.vfx-nebula-bg {
    position: absolute; width: 100%; height: 100%; overflow: hidden;
}

.cloud-1, .cloud-2 {
    position: absolute; width: 200%; height: 200%;
    background: url('https://www.transparenttextures.com/patterns/clouds-dark.png');
    opacity: 0.3; animation: drift 120s linear infinite;
}

@keyframes drift { from { transform: translate(0,0); } to { transform: translate(-50%, -50%); } }

.logo-text {
    font-size: 4rem; font-weight: 900; letter-spacing: 15px;
    background: linear-gradient(to bottom, var(--gold-bright), #fff, var(--gold-dark));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 15px var(--gold-glow));
    animation: pulseLogo 3s infinite alternate ease-in-out;
}

@keyframes pulseLogo { from { transform: scale(1); filter: brightness(1); } to { transform: scale(1.05); filter: brightness(1.3); } }

/* 3. CH·ªåN M√îN PH√ÅI (SECT SELECTION) */
.sect-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 20px;
}

.sect-card {
    background: var(--glass); border: 1px solid #333; border-radius: 10px;
    padding: 15px; cursor: pointer; transition: var(--transition-slow);
    position: relative; overflow: hidden;
}

.sect-card.active {
    border-color: var(--gold-bright); transform: translateY(-5px);
    box-shadow: 0 0 20px var(--gold-glow);
}

.sect-card::after {
    content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: rotate(45deg); transition: 0.5s;
}

.sect-card:hover::after { left: 100%; }

/* 4. CHI·∫æN TR∆Ø·ªúNG T·ªîNG TH·ªÇ (WORLD MAP) */
#map-viewport {
    width: 100vw; height: 100vh; overflow: hidden; position: relative;
}

#map-container {
    width: 2000000px; height: 2000000px; background: #0b110b;
    transform-origin: 0 0; will-change: transform;
}

.ground-texture-mesh {
    width: 100%; height: 100%;
    background-image: 
        radial-gradient(circle at 2px 2px, rgba(255,255,255,0.03) 1px, transparent 0);
    background-size: 100px 100px;
}

/* 5. C·∫§U TR√öC X∆Ø∆†NG NH√ÇN V·∫¨T (CHARACTER RIGGING) */
.entity-base {
    position: absolute; width: 80px; height: 100px;
    z-index: 100; transition: transform 0.1s linear;
}

.rig-skeleton {
    position: relative; width: 100%; height: 100%;
    display: flex; flex-direction: column; align-items: center;
}

.rig-head {
    width: 28px; height: 28px; border: 2.5px solid #fff; border-radius: 50%;
    background: #111; z-index: 10;
}

.eye-glow-vfx {
    position: absolute; top: 8px; width: 100%; display: flex; justify-content: space-around;
}

.eye-glow-vfx::before, .eye-glow-vfx::after {
    content: ''; width: 4px; height: 4px; background: #0ff; border-radius: 50%; box-shadow: 0 0 8px #0ff;
}

.rig-torso {
    width: 6px; height: 45px; background: #fff; border-radius: 3px; position: relative;
}

.rig-arm {
    position: absolute; width: 4px; height: 35px; background: #fff;
    transform-origin: top; top: 2px; border-radius: 2px;
}

.arm-l { left: -4px; transform: rotate(15deg); }
.arm-r { right: -4px; transform: rotate(-15deg); }

.rig-leg {
    position: absolute; width: 4px; height: 40px; background: #fff;
    transform-origin: top; bottom: -38px; border-radius: 2px;
}

.leg-l { left: 0; transform: rotate(10deg); }
.leg-r { right: 2px; transform: rotate(-10deg); }

/* V≈® KH√ç (WEAPON) */
.weapon-instance {
    position: absolute; bottom: -20px; right: -5px;
    width: 5px; height: 75px; background: linear-gradient(to top, #fff, var(--gold-bright));
    transform-origin: top; box-shadow: 0 0 10px var(--gold-glow);
    animation: weaponIdle 2s infinite ease-in-out;
}

@keyframes weaponIdle { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }

/* 6. GIAO DI·ªÜN NG∆Ø·ªúI D√ôNG (HUD UI) */
.hud-player-vitals {
    position: fixed; top: 15px; left: 15px; z-index: 9000;
    display: flex; align-items: center; background: var(--glass);
    padding: 8px 20px 8px 8px; border-radius: 50px 15px 15px 50px;
    border: 1px solid var(--gold-dark); box-shadow: 0 5px 20px rgba(0,0,0,0.5);
}

.portrait-box {
    width: 65px; height: 65px; border-radius: 50%; border: 3px solid var(--gold-bright);
    background: #222; overflow: hidden; position: relative;
}

.bar-unit {
    width: 180px; height: 18px; background: #000; border-radius: 9px;
    margin: 4px 0; position: relative; overflow: hidden; border: 1px solid #333;
}

.bar-unit.hp .fill { background: linear-gradient(90deg, #900, var(--hp-color)); }
.bar-unit.mp .fill { background: linear-gradient(90deg, #005, var(--mp-color)); }
.fill { height: 100%; width: 100%; transition: width 0.3s ease; }

.value-text {
    position: absolute; width: 100%; text-align: center; font-size: 10px;
    font-weight: bold; line-height: 18px; text-shadow: 1px 1px #000;
}

/* 7. MOBILE CONTROLLER */
#joystick-wrapper {
    position: absolute; bottom: 50px; left: 50px;
    width: 160px; height: 160px; background: rgba(255,255,255,0.05);
    border-radius: 50%; border: 2px solid rgba(255,215,0,0.2);
}

#joystick-knob {
    position: absolute; top: 50%; left: 50%; width: 70px; height: 70px;
    background: radial-gradient(circle, var(--gold-bright), var(--gold-dark));
    border-radius: 50%; transform: translate(-50%, -50%);
    box-shadow: 0 0 20px rgba(0,0,0,0.8);
}

#skill-pad-cluster {
    position: absolute; bottom: 30px; right: 30px; width: 300px; height: 300px;
}

#btn-attack-trigger {
    position: absolute; bottom: 10px; right: 10px; width: 100px; height: 100px;
    background: radial-gradient(circle, #ff4757, #8e0000);
    border: 4px solid var(--gold-bright); border-radius: 50%;
    font-size: 40px; box-shadow: 0 0 25px rgba(255,0,0,0.4);
}

.s-btn {
    position: absolute; width: 65px; height: 65px; background: rgba(20,20,20,0.9);
    border: 2px solid var(--gold-bright); border-radius: 50%; color: #fff;
    font-weight: bold; overflow: hidden;
}

.s1 { bottom: 130px; right: 10px; }
.s2 { bottom: 120px; right: 100px; }
.s3 { bottom: 30px; right: 130px; }
.s4 { bottom: 200px; right: 40px; } /* Ult */

.cd-mask {
    position: absolute; bottom: 0; width: 100%; height: 0%;
    background: rgba(0,0,0,0.7); transition: height 0.1s linear;
}

/* 8. H·ªÜ TH·ªêNG MODAL (POPUPS) */
.modal-window-supreme {
    width: 90%; max-width: 550px; background: #111;
    border: 2px solid var(--gold-dark); border-radius: 15px;
    animation: modalIn 0.3s var(--transition-slow);
}

@keyframes modalIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

.modal-header {
    padding: 15px; border-bottom: 1px solid #333;
    background: linear-gradient(to bottom, #222, #111);
    display: flex; justify-content: space-between; align-items: center;
}

/* HI·ªÜU ·ª®NG TH·ªúI TI·∫æT DYNAMIC */
.weather-overlay-rain {
    position: absolute; inset: 0; pointer-events: none;
    background: url('https://www.transparenttextures.com/patterns/stardust.png');
    opacity: 0.1; animation: rain 0.5s linear infinite;
}

@keyframes rain { from { background-position: 0 0; } to { background-position: 200px 500px; } }

/* CH·ªÆ S√ÅT TH∆Ø∆†NG (DAMAGE POPUP) */
.dmg-text {
    position: absolute; color: #ff0; font-weight: 900; font-size: 24px;
    pointer-events: none; animation: flyUp 0.8s ease-out forwards;
    text-shadow: 2px 2px #000;
}

@keyframes flyUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } }

    
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="start-screen">
        <div class="vfx-nebula-bg">
            <div class="cloud-1"></div>
            <div class="cloud-2"></div>
            <div class="particle-system"></div>
        </div>

        <div class="selection-ui">
            <header class="game-logo-container">
                <h1 class="logo-text" data-text="V√ï L√ÇM SUPREME">V√ï L√ÇM SUPREME</h1>
                <div class="sub-title-decoration">KI·∫æM HI·ªÜP T√åNH DUY√äN - V·∫†N C·ªî TR∆Ø·ªúNG T·ªíN</div>
                <div class="divider-gold"></div>
            </header>

            <div class="server-node-list">
                <div class="server-box active">
                    <span class="status-pulse"></span>
                    <span class="sv-name">M√ÅY CH·ª¶ 1: TH√ÅI S∆†N B·∫ÆC ƒê·∫®U</span>
                    <span class="sv-ping">Ping: 12ms</span>
                </div>
            </div>

            <section class="sect-mega-selection">
                <div class="sect-header">
                    <span class="border-line"></span>
                    <h2 class="sect-title">TH·ªàNH CH·ªåN M√îN PH√ÅI</h2>
                    <span class="border-line"></span>
                </div>
                
                <div class="sect-grid-scroll">
                    <div class="sect-grid" id="sect-picker">
                        </div>
                </div>

                <div id="sect-preview-box" class="preview-card">
                    <div class="preview-body">
                        <div class="preview-visual">
                            <div class="skeleton-preview-rig"></div>
                        </div>
                        <div class="preview-stats">
                            <h3 id="pre-name">H·ªÜ TH·ªêNG</h3>
                            <div class="stat-group">
                                <div class="stat-label">CƒÉn C·ªët: <div class="bar-outer"><div id="pre-hp" class="bar-inner"></div></div></div>
                                <div class="stat-label">N·ªôi C√¥ng: <div class="bar-outer"><div id="pre-mp" class="bar-inner"></div></div></div>
                                <div class="stat-label">Th√¢n Ph√°p: <div class="bar-outer"><div id="pre-spd" class="bar-inner"></div></div></div>
                            </div>
                            <div class="sect-element-tag" id="pre-element">Ng≈© H√†nh: ???</div>
                            <p id="pre-desc">Vui l√≤ng ch·ªçn m√¥n ph√°i ƒë·ªÉ xem tuy·ªát h·ªçc...</p>
                        </div>
                    </div>
                </div>
            </section>

            <footer class="start-footer">
                <div class="character-input-zone">
                    <input type="text" id="player-name-input" maxlength="10" placeholder="Danh t√≠nh ƒë·∫°i hi·ªáp...">
                    <button id="btn-random-name">üé≤</button>
                </div>
                <button id="btn-enter-game" class="btn-start-hero">XU·∫§T TH·∫æ GIANG H·ªí</button>
                <div id="boot-loader" class="hidden">
                    <div class="loader-vfx"></div>
                    <div class="loader-status">ƒêang n·∫°p kh√≠ h√≥a th·∫ßn (0%)...</div>
                </div>
            </footer>
        </div>
    </div>

    <main id="stage" style="display: none;">
        
        <div id="map-viewport">
            <div id="map-container">
                
                <div id="terrain-layer">
                    <div class="ground-texture-mesh"></div>
                    <div id="static-scenery-entities">
                        </div>
                </div>

                <div id="climate-layer">
                    <div class="dynamic-fog-vfx"></div>
                    <div class="sakura-petal-vfx"></div>
                    <div class="weather-overlay-rain" id="rain-layer"></div>
                    <div class="thunder-flash-layer"></div>
                </div>

                <div id="entities-layer">
                    
                    <article id="hero" class="entity-base hero-class">
                        
                        <div class="vfx-aura-socket" id="hero-aura"></div>
                        <div class="vfx-wings-socket" id="hero-wings" style="display:none;">
                            <div class="wing-l"></div>
                            <div class="wing-r"></div>
                        </div>

                        <div class="overhead-hud-unit">
                            <div class="rank-title">‚≠ê V·∫°n C·ªï Ki·∫øm T√¥n ‚≠ê</div>
                            <div class="name-badge" id="hero-name-display">ƒê·∫°i Hi·ªáp</div>
                            <div class="guild-tag">&lt;H√†o Ki·ªát Bang&gt;</div>
                            <div class="hp-mini-bar"><div id="hero-hp-mini" class="fill"></div></div>
                        </div>

                        <div class="rig-skeleton">
                            <div class="rig-head" id="hero-head">
                                <div class="eye-glow-vfx"></div>
                            </div>
                            <div class="rig-torso">
                                <div class="rig-arm arm-l">
                                    <div class="shoulder"></div>
                                    <div class="hand-socket"></div>
                                </div>
                                <div class="rig-arm arm-r">
                                    <div class="shoulder"></div>
                                    <div class="hand-socket">
                                        <div class="weapon-instance" id="hero-weapon">
                                            <div class="blade-core"></div>
                                            <div class="blade-glint"></div>
                                            <div class="atk-trail-vfx"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="rig-legs">
                                <div class="leg leg-l"></div>
                                <div class="leg leg-r"></div>
                            </div>
                        </div>

                        <div class="dynamic-shadow-vfx"></div>
                        <div class="dust-kick-vfx"></div>
                    </article>

                    <div id="npc-spawn-pool"></div>
                    <div id="mob-spawn-pool"></div>
                </div>

                <div id="skill-vfx-surface"></div>
                <div id="damage-popup-surface"></div>
                <div id="loot-drop-surface"></div>
            </div>
        </div>

        <div id="ui-master-hud">
            
            <header class="hud-player-vitals">
                <div class="portrait-box" onclick="toggleModal('profile')">
                    <div id="ui-sect-icon" class="sect-icon-v3"></div>
                    <div class="lv-badge" id="ui-level">1</div>
                </div>
                <div class="bars-container">
                    <div class="bar-unit hp"><div id="ui-hp-fill" class="fill"></div><span id="ui-hp-text">0/0</span></div>
                    <div class="bar-unit mp"><div id="ui-mp-fill" class="fill"></div><span id="ui-mp-text">0/0</span></div>
                    <div class="bar-unit exp"><div id="ui-exp-fill" class="fill"></div></div>
                </div>
                <div class="currency-group">
                    <div class="gold-slot">üí∞ <span id="ui-gold">0</span></div>
                    <div class="atk-slot">‚öîÔ∏è <span id="ui-atk">0</span></div>
                </div>
            </header>

            <aside class="hud-navigation">
                <div class="map-label">
                    <div class="m-name" id="ui-map-name">TH√ÄNH T∆Ø∆†NG D∆Ø∆†NG</div>
                    <div class="m-coords" id="ui-coords">X: 100, Y: 100</div>
                </div>
                <div class="radar-box">
                    <div id="radar-entities-layer"></div>
                    <div class="radar-scan-vfx"></div>
                    <div class="radar-player-marker"></div>
                </div>
            </aside>

            <section class="hud-chat-system">
                <nav class="chat-tabs">
                    <button class="tab active" data-channel="all">T·∫•t C·∫£</button>
                    <button class="tab" data-channel="world">Th·∫ø Gi·ªõi</button>
                    <button class="tab" data-channel="guild">Bang</button>
                </nav>
                <div id="chat-messages-flow" class="message-area"></div>
                <div class="chat-input-bar">
                    <input type="text" id="chat-input-field" placeholder="Nh·∫≠p n·ªôi dung...">
                    <button id="btn-chat-send">G·ª¨I</button>
                </div>
            </section>

            <nav id="hud-controls-mobile">
                
                <div id="joystick-wrapper">
                    <div id="joystick-base">
                        <div id="joystick-knob">
                            <div class="knob-glow"></div>
                        </div>
                    </div>
                </div>

                <div id="skill-pad-cluster">
                    <div class="btn-main-atk-slot">
                        <button id="btn-attack-trigger">
                            <span class="icon">‚öîÔ∏è</span>
                            <div class="ripple-vfx"></div>
                        </button>
                    </div>

                    <div class="skill-slot s1"><button id="btn-skill-1" class="s-btn"><div class="cd-mask" id="cd-1"></div><span class="key">1</span></button></div>
                    <div class="skill-slot s2"><button id="btn-skill-2" class="s-btn"><div class="cd-mask" id="cd-2"></div><span class="key">2</span></button></div>
                    <div class="skill-slot s3"><button id="btn-skill-3" class="s-btn"><div class="cd-mask" id="cd-3"></div><span class="key">3</span></button></div>
                    
                    <div class="skill-slot s4">
                        <button id="btn-skill-4" class="s-btn ult-btn">
                            <div class="cd-mask" id="cd-4"></div>
                            <div class="ult-flame-vfx"></div>
                            <span class="key">N·ªò</span>
                        </button>
                    </div>

                    <div class="util-slot fly"><button id="btn-fly-trigger">‚úàÔ∏è</button></div>
                    <div class="util-slot mount"><button id="btn-mount-trigger">üêé</button></div>
                    <div class="util-slot sit"><button id="btn-meditate-trigger">üßò</button></div>
                </div>
            </nav>

            <nav class="hud-side-menu">
                <button onclick="openModal('inventory')">H√ÄNH TRANG</button>
                <button onclick="openModal('skills')">K·ª∏ NƒÇNG</button>
                <button onclick="openModal('guild')">BANG H·ªòI</button>
                <button onclick="openModal('shop')">K·ª≤ TR√ÇN C√ÅC</button>
            </nav>
        </div>

        <div id="global-modal-overlay" class="modal-closed">
            <div class="modal-window-supreme">
                <header class="modal-header">
                    <div class="modal-decoration"></div>
                    <h2 id="modal-title-text">DANH M·ª§C</h2>
                    <button class="btn-modal-close" onclick="closeModal()">‚úñ</button>
                </header>
                <div class="modal-body-content" id="modal-body-render">
                    </div>
                <footer class="modal-footer">
                    <div id="modal-footer-msg">H·ªá Th·ªëng V√µ L√¢m Supreme v2.0</div>
                </footer>
            </div>
        </div>

        <div id="toast-notify-layer"></div>

    </main>

    <audio id="bgm-player" loop></audio>
    <audio id="sfx-player"></audio>

    <script id="game-main-logic">
        
const GameEngine = (() => {
    // 1. C·∫§U H√åNH H·ªÜ TH·ªêNG & D·ªÆ LI·ªÜU G·ªêC
    const CONFIG = {
        MAP_SIZE: 2000000,
        FPS: 60,
        GRAVITY: 0.5,
        JOYSTICK_RADIUS: 80,
        MAX_MOBS: 50,
        SECTS: {
            thieulam: { name: "Thi·∫øu L√¢m", element: "Kim", hp: 1500, atk: 80, color: "#ffffff", skill: "S∆∞ T·ª≠ H·ªëng" },
            vodang: { name: "V√µ ƒêang", element: "Th·ªï", hp: 1100, atk: 110, color: "#f1c40f", skill: "Th√°i C·ª±c Ki·∫øm" },
            duongmon: { name: "ƒê∆∞·ªùng M√¥n", element: "M·ªôc", hp: 900, atk: 140, color: "#2ecc71", skill: "B·∫°o V≈© L√™ Hoa" },
            ngami: { name: "Nga Mi", element: "Th·ªßy", hp: 1000, atk: 90, color: "#3498db", skill: "Ch∆∞·ªüng BƒÉng" },
            caibang: { name: "C√°i Bang", element: "H·ªèa", hp: 1300, atk: 120, color: "#e74c3c", skill: "Kh√°ng Long H·ªØu H·ªëi" }
        }
    };

    // 2. TR·∫†NG TH√ÅI TH·ªúI GIAN TH·ª∞C (GAME STATE)
    const state = {
        player: {
            name: "ƒê·∫°i Hi·ªáp", sect: "thieulam", lv: 1, exp: 0, 
            hp: 1000, maxHp: 1000, mp: 500, maxMp: 500,
            atk: 100, def: 50, gold: 0,
            x: 1000000, y: 1000000, vx: 0, vy: 0, speed: 8,
            isMoving: false, isAttacking: false, isFlying: false,
            rotation: 0, currentSectData: null
        },
        joystick: { active: false, startX: 0, startY: 0, moveX: 0, moveY: 0, angle: 0 },
        mobs: [],
        vfx: [],
        input: {},
        camX: 0, camY: 0,
        screenW: window.innerWidth, screenH: window.innerHeight
    };

    // 3. KH·ªûI T·∫†O M√îN PH√ÅI & GIAO DI·ªÜN CH·ªåN NH√ÇN V·∫¨T
    const initSectPicker = () => {
        const picker = document.getElementById('sect-picker');
        Object.keys(CONFIG.SECTS).forEach(key => {
            const s = CONFIG.SECTS[key];
            const card = document.createElement('div');
            card.className = 'sect-card';
            card.innerHTML = `<h3>${s.name}</h3><p>H·ªá: ${s.element}</p>`;
            card.onclick = () => selectSect(key, card);
            picker.appendChild(card);
        });
    };

    const selectSect = (key, el) => {
        document.querySelectorAll('.sect-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        state.player.sect = key;
        state.player.currentSectData = CONFIG.SECTS[key];
        
        // C·∫≠p nh·∫≠t Preview UI
        document.getElementById('pre-name').innerText = CONFIG.SECTS[key].name;
        document.getElementById('pre-desc').innerText = `Tuy·ªát k·ªπ: ${CONFIG.SECTS[key].skill}. S·ª©c m·∫°nh h·ªá ${CONFIG.SECTS[key].element} vƒ©nh c·ª≠u.`;
        document.getElementById('pre-hp').style.width = (CONFIG.SECTS[key].hp / 15) + "%";
        document.getElementById('pre-spd').style.width = (CONFIG.SECTS[key].atk / 1.5) + "%";
    };

    // 4. H·ªÜ TH·ªêNG ƒêI·ªÄU KHI·ªÇN (CONTROLS)
    const setupControls = () => {
        const knob = document.getElementById('joystick-knob');
        const base = document.getElementById('joystick-base');

        const handleStart = (e) => {
            const touch = e.touches ? e.touches[0] : e;
            const rect = base.getBoundingClientRect();
            state.joystick.startX = rect.left + rect.width / 2;
            state.joystick.startY = rect.top + rect.height / 2;
            state.joystick.active = true;
        };

        const handleMove = (e) => {
            if (!state.joystick.active) return;
            const touch = e.touches ? e.touches[0] : e;
            let dx = touch.clientX - state.joystick.startX;
            let dy = touch.clientY - state.joystick.startY;
            let dist = Math.sqrt(dx*dx + dy*dy);
            
            if (dist > CONFIG.JOYSTICK_RADIUS) {
                dx *= CONFIG.JOYSTICK_RADIUS / dist;
                dy *= CONFIG.JOYSTICK_RADIUS / dist;
            }

            knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            state.joystick.angle = Math.atan2(dy, dx);
            state.player.vx = (dx / CONFIG.JOYSTICK_RADIUS) * state.player.speed;
            state.player.vy = (dy / CONFIG.JOYSTICK_RADIUS) * state.player.speed;
            state.player.isMoving = true;
        };

        const handleEnd = () => {
            state.joystick.active = false;
            state.player.vx = 0; state.player.vy = 0;
            state.player.isMoving = false;
            knob.style.transform = `translate(-50%, -50%)`;
        };

        base.addEventListener('touchstart', handleStart);
        window.addEventListener('touchmove', handleMove);
        window.addEventListener('touchend', handleEnd);

        // N√∫t t·∫•n c√¥ng
        document.getElementById('btn-attack-trigger').onclick = () => performAttack();
    };

    // 5. C∆† CH·∫æ CHI·∫æN ƒê·∫§U & K·ª∏ NƒÇNG
    const performAttack = () => {
        if (state.player.isAttacking) return;
        state.player.isAttacking = true;
        const heroEl = document.getElementById('hero');
        heroEl.classList.add('attacking');

        // T·∫°o hi·ªáu ·ª©ng ch√©m
        createVFX(state.player.x, state.player.y, 'slash');

        // Ki·ªÉm tra va ch·∫°m v·ªõi qu√°i
        state.mobs.forEach(mob => {
            let d = Math.sqrt((state.player.x - mob.x)**2 + (state.player.y - mob.y)**2);
            if (d < 150) {
                damageMob(mob, state.player.atk);
            }
        });

        setTimeout(() => {
            state.player.isAttacking = false;
            heroEl.classList.remove('attacking');
        }, 300);
    };

    const damageMob = (mob, dmg) => {
        mob.hp -= dmg;
        showDamagePopup(mob.x, mob.y, dmg);
        if (mob.hp <= 0) {
            state.player.gold += 50;
            state.player.exp += 100;
            removeMob(mob);
            updateUI();
        }
    };

    // 6. TR√ç TU·ªÜ NH√ÇN T·∫†O QU√ÅI V·∫¨T (MOB AI)
    const spawnMob = () => {
        if (state.mobs.length >= CONFIG.MAX_MOBS) return;
        const mob = {
            id: Date.now() + Math.random(),
            x: state.player.x + (Math.random() - 0.5) * 1500,
            y: state.player.y + (Math.random() - 0.5) * 1500,
            hp: 200, maxHp: 200, speed: 2, atk: 10,
            el: null
        };
        
        const div = document.createElement('div');
        div.className = 'entity mob-base';
        div.innerHTML = `<div class="hp-bar"><div class="fill"></div></div><div class="mob-body">üíÄ</div>`;
        document.getElementById('mob-spawn-pool').appendChild(div);
        mob.el = div;
        state.mobs.push(mob);
    };

    const updateMobs = () => {
        state.mobs.forEach(mob => {
            // AI ƒêu·ªïi theo ng∆∞·ªùi ch∆°i n·∫øu l·∫°i g·∫ßn
            let dx = state.player.x - mob.x;
            let dy = state.player.y - mob.y;
            let dist = Math.sqrt(dx*dx + dy*dy);

            if (dist < 600 && dist > 50) {
                mob.x += (dx / dist) * mob.speed;
                mob.y += (dy / dist) * mob.speed;
            }

            // C·∫≠p nh·∫≠t v·ªã tr√≠ hi·ªÉn th·ªã
            mob.el.style.transform = `translate(${mob.x}px, ${mob.y}px)`;
            mob.el.querySelector('.fill').style.width = (mob.hp / mob.maxHp * 100) + "%";
        });
    };

    // 7. V√íNG L·∫∂P GAME (GAME LOOP - 60FPS)
    const update = () => {
        // C·∫≠p nh·∫≠t t·ªça ƒë·ªô ng∆∞·ªùi ch∆°i
        state.player.x += state.player.vx;
        state.player.y += state.player.vy;

        // Gi·ªõi h·∫°n b·∫£n ƒë·ªì
        state.player.x = Math.max(0, Math.min(CONFIG.MAP_SIZE, state.player.x));
        state.player.y = Math.max(0, Math.min(CONFIG.MAP_SIZE, state.player.y));

        // Camera b√°m ƒëu·ªïi
        state.camX = state.player.x - state.screenW / 2;
        state.camY = state.player.y - state.screenH / 2;

        const mapContainer = document.getElementById('map-container');
        mapContainer.style.transform = `translate(${-state.camX}px, ${-state.camY}px)`;

        // C·∫≠p nh·∫≠t nh√¢n v·∫≠t
        const hero = document.getElementById('hero');
        hero.style.transform = `translate(${state.player.x}px, ${state.player.y}px)`;
        
        if (state.player.vx !== 0) {
            hero.style.transform += ` scaleX(${state.player.vx > 0 ? 1 : -1})`;
        }

        updateMobs();
        requestAnimationFrame(update);
    };

    // 8. H·ªÜ TH·ªêNG GIAO DI·ªÜN (UI UPDATES)
    const updateUI = () => {
        document.getElementById('ui-hp-fill').style.width = (state.player.hp / state.player.maxHp * 100) + "%";
        document.getElementById('ui-hp-text').innerText = `${state.player.hp} / ${state.player.maxHp}`;
        document.getElementById('ui-gold').innerText = state.player.gold;
        document.getElementById('ui-atk').innerText = state.player.atk;
        document.getElementById('ui-coords').innerText = `X: ${Math.floor(state.player.x / 100)}, Y: ${Math.floor(state.player.y / 100)}`;
    };

    const showDamagePopup = (x, y, dmg) => {
        const p = document.createElement('div');
        p.className = 'dmg-text';
        p.innerText = `-${dmg}`;
        p.style.left = x + 'px';
        p.style.top = y + 'px';
        document.getElementById('damage-popup-surface').appendChild(p);
        setTimeout(() => p.remove(), 800);
    };

    // KH·ªûI CH·∫†Y GAME
    const start = () => {
        const nameInput = document.getElementById('player-name-input').value;
        if (nameInput) state.player.name = nameInput;
        
        document.getElementById('start-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('stage').style.display = 'block';
            updateUI();
            update();
            // T·ª± ƒë·ªông sinh qu√°i m·ªói 3 gi√¢y
            setInterval(spawnMob, 3000);
        }, 1000);
    };

    return {
        init: () => {
            initSectPicker();
            setupControls();
            document.getElementById('btn-enter-game').onclick = start;
        }
    };
})();

// K√≠ch ho·∫°t Engine
window.onload = GameEngine.init;
        
    </script>
</body>
    </html>
    
